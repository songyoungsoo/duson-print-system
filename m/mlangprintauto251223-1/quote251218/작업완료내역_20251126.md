# ê²¬ì ì„œ ì‹œìŠ¤í…œ ìˆ˜ì • ì™„ë£Œ ë‚´ì—­

**ì‘ì—…ì¼**: 2025-11-26
**ì‘ì—…ì**: Claude Code Assistant

---

## ğŸ¯ í•µì‹¬ ìˆ˜ì •ì‚¬í•­

### 1. ROOT CAUSE í•´ê²° (ê°€ì¥ ì¤‘ìš”!)

**íŒŒì¼**: `/var/www/html/mlangprintauto/quote/includes/QuoteManager.php`
**í•¨ìˆ˜**: `addManualItem()` (lines 374-394)

#### ë¬¸ì œ
- mysqli_stmt_bind_param íƒ€ì… ë¬¸ìì—´ ë¶ˆì¼ì¹˜
- VALUES ì ˆì— 13ê°œ ê°’ vs bind_paramì— 12ê°œ íƒ€ì… ì§€ì •ì
- **ê²°ê³¼**: í’ˆëª…, ê·œê²©, ìˆ˜ëŸ‰ ë“± í’ˆëª© ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ

#### ìˆ˜ì • ë‚´ìš©
```php
// âŒ ìˆ˜ì • ì „ (12ê°œ íƒ€ì… ì§€ì •ì)
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'manual', ?)";
mysqli_stmt_bind_param($stmt, "iisssdsiiiis",

// âœ… ìˆ˜ì • í›„ (13ê°œ íƒ€ì… ì§€ì •ì)
$sourceType = 'manual';
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
mysqli_stmt_bind_param($stmt, "iisssdsiiiiiss",
    $quoteId, $itemNo,
    $productType,
    $productName,
    $specification,
    $quantity,
    $unit,
    $unitPrice, $supplyPrice, $vatAmount, $totalPrice,
    $sourceType,  // 'manual'ì„ ë³€ìˆ˜ë¡œ ë³€ê²½
    $notes
);
```

#### ì˜í–¥ ë²”ìœ„
- âœ… ìƒˆ ê²¬ì ì„œ ì‘ì„± ì‹œ í’ˆëª© ì €ì¥
- âœ… ê°œì •íŒ ì‘ì„± ì‹œ í’ˆëª© ì €ì¥
- âœ… ìˆ˜ë™ í’ˆëª© ì¶”ê°€ ì‹œ ì •ìƒ ì‘ë™

---

## ğŸ“‹ í™”ë©´ í†µì¼ ì‘ì—… (PDF ê¸°ì¤€)

### í‘œì¤€ í˜•ì‹
```
NO | í’ˆëª… | ê·œê²© ë° ì‚¬ì–‘ | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ë‹¨ê°€ | ê³µê¸‰ê°€ì•¡(VATë³„ë„) | ë¹„ê³ 
```

### ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

#### 1. detail.php - ê´€ë¦¬ì ìƒì„¸ í™”ë©´
**íŒŒì¼**: `/var/www/html/mlangprintauto/quote/detail.php`

**ìˆ˜ì • ë‚´ìš©**:
1. **CSS ì¶”ê°€** (lines 206-207):
```css
.col-supply { width: 110px; text-align: right; font-family: 'Noto Sans KR', sans-serif; }
.col-notes { width: 10%; text-align: left; font-size: 12px; color: #666; }
```

2. **í…Œì´ë¸” í—¤ë”** (lines 388-395): 7ì»¬ëŸ¼ â†’ 8ì»¬ëŸ¼
```html
<th class="col-supply">ê³µê¸‰ê°€ì•¡(VATë³„ë„)</th>
<th class="col-notes">ë¹„ê³ </th>
```

3. **ìˆ˜ëŸ‰ ì…€ - ì „ë‹¨ì§€ ë§¤ìˆ˜ í‘œì‹œ** (lines 404-417):
```php
<td class="col-qty"><?php
    $qty = $item['quantity'];
    $qtyDisplay = ($qty == intval($qty)) ? number_format($qty) : rtrim(rtrim(number_format($qty, 2), '0'), '.');
    echo $qtyDisplay;

    // ì „ë‹¨ì§€(inserted)ì¸ ê²½ìš° ë§¤ìˆ˜ í‘œì‹œ ì¶”ê°€
    if (($item['product_type'] ?? '') === 'inserted' && !empty($item['source_data'])) {
        $sourceData = json_decode($item['source_data'], true);
        if (!empty($sourceData['mesu'])) {
            echo '<br><span style="font-size: 10px; color: #666;">(' . number_format($sourceData['mesu']) . 'ë§¤)</span>';
        }
    }
?></td>
```

4. **ë‹¨ê°€ ì…€ - ì „ë‹¨ì§€ ì†Œìˆ˜ì  ì²˜ë¦¬** (lines 419-426):
```php
<td class="col-price"><?php
    if (($item['product_type'] ?? '') === 'inserted') {
        echo number_format($item['unit_price'], 1);
    } else {
        echo number_format($item['unit_price']);
    }
?></td>
```

5. **ê³µê¸‰ê°€ì•¡/ë¹„ê³  ì»¬ëŸ¼** (lines 427-428):
```php
<td class="col-supply"><?php echo number_format($item['supply_price']); ?></td>
<td class="col-notes"><?php echo htmlspecialchars($item['notes'] ?? ''); ?></td>
```

#### 2. send_email.php - ì´ë©”ì¼ ë°œì†¡
**íŒŒì¼**: `/var/www/html/mlangprintauto/quote/api/send_email.php`

**ìˆ˜ì • ë‚´ìš©**:
1. **ë³€ìˆ˜ ì¶”ê°€** (lines 77-78):
```php
$supplyPriceFmt = number_format($item['supply_price']);
$notes = htmlspecialchars($item['notes'] ?? '');
```

2. **HTML í’ˆëª© í–‰** (lines 80-89): 7ì…€ â†’ 8ì…€
```php
$itemsHtml .= "<tr>
    <td style='border:1px solid #ddd;padding:5px;text-align:center;font-size:14px;'>{$no}</td>
    <td style='border:1px solid #ddd;padding:5px;font-size:14px;'>{$productName}</td>
    <td style='border:1px solid #ddd;padding:5px;font-size:13px;line-height:1.4;'>{$specification}</td>
    <td style='border:1px solid #ddd;padding:5px;text-align:center;font-size:14px;'>{$qtyDisplay}</td>
    <td style='border:1px solid #ddd;padding:5px;text-align:center;font-size:14px;'>{$unit}</td>
    <td style='border:1px solid #ddd;padding:5px;text-align:right;font-size:14px;'>{$unitPriceFmt}</td>
    <td style='border:1px solid #ddd;padding:5px;text-align:right;font-size:14px;font-weight:600;'>{$supplyPriceFmt}</td>
    <td style='border:1px solid #ddd;padding:5px;font-size:12px;color:#666;'>{$notes}</td>
</tr>";
```

3. **í…Œì´ë¸” í—¤ë”** (lines 184-191): 7ì»¬ëŸ¼ â†’ 8ì»¬ëŸ¼
```html
<th style="border:1px solid #03C75A;padding:6px;font-size:13px;font-weight:600;">ê³µê¸‰ê°€ì•¡(VATë³„ë„)</th>
<th style="border:1px solid #03C75A;padding:6px;font-size:13px;font-weight:600;">ë¹„ê³ </th>
```

---

## ğŸ”§ ê¸°íƒ€ ìˆ˜ì •ì‚¬í•­

### 1. ê²¬ì ë²ˆí˜¸ ì¤‘ë³µ ì˜¤ë¥˜ ìˆ˜ì •
**íŒŒì¼**: `QuoteManager.php`
**í•¨ìˆ˜**: `createRevision()` (lines 776-790)

**ë¬¸ì œ**: v2, v3 ìƒì„± ì‹œ "Duplicate entry" ì˜¤ë¥˜
**í•´ê²°**: DBì—ì„œ ì‹¤ì œ MAX(version) ì¡°íšŒí•˜ì—¬ ì‚¬ìš©

```php
$maxVersionQuery = "SELECT MAX(version) as max_version FROM quotes WHERE original_quote_id = ? OR id = ?";
$maxVersionStmt = mysqli_prepare($this->db, $maxVersionQuery);
mysqli_stmt_bind_param($maxVersionStmt, "ii", $rootId, $rootId);
mysqli_stmt_execute($maxVersionStmt);
$maxVersionResult = mysqli_stmt_get_result($maxVersionStmt);
$maxVersionRow = mysqli_fetch_assoc($maxVersionResult);
mysqli_stmt_close($maxVersionStmt);

$currentMaxVersion = intval($maxVersionRow['max_version'] ?? $original['version'] ?? 1);
$newVersion = $currentMaxVersion + 1;
```

### 2. ê³µê¸‰ê°€ ì…ë ¥ ê°€ëŠ¥ (ì´ì „ ì„¸ì…˜ ì™„ë£Œ)
**íŒŒì¼**: `edit.php`, `revise.php`
- readonly ì†ì„± ì œê±°
- ë™ì  ì¶”ê°€ í–‰ì—ì„œë„ í¸ì§‘ ê°€ëŠ¥

### 3. ì—­ê³„ì‚° ê¸°ëŠ¥ (ì´ì „ ì„¸ì…˜ ì™„ë£Œ)
**íŒŒì¼**: `edit.php`, `revise.php`
**í•¨ìˆ˜**: `calculateUnitPrice()`

```javascript
function calculateUnitPrice(supplyInput) {
    const row = supplyInput.closest('tr');
    const quantity = parseFloat(row.querySelector('.quantity-input').value) || 1;
    const supplyPrice = parseFloat(supplyInput.value) || 0;
    const unitPrice = Math.floor(supplyPrice / quantity);

    row.querySelector('.unit-price-input').value = unitPrice;
    calculateItemTotal(supplyInput);
}
```

---

## ğŸ› ï¸ ìƒì„±ëœ ë„êµ¬

### 1. check_quote.php
**ê²½ë¡œ**: `/var/www/html/mlangprintauto/quote/check_quote.php`
**ìš©ë„**: ê²¬ì ì„œ DB ë°ì´í„° í™•ì¸
**ì‚¬ìš©ë²•**: `check_quote.php?id=63`

### 2. fix_customer_name.php
**ê²½ë¡œ**: `/var/www/html/mlangprintauto/quote/fix_customer_name.php`
**ìš©ë„**: ê³ ê°ëª… ìˆ˜ì •
**ì‚¬ìš©ë²•**: `fix_customer_name.php?id=63&name=í™ê¸¸ë™&key=fix2025`

### 3. fix_company_name.php
**ê²½ë¡œ**: `/var/www/html/mlangprintauto/quote/fix_company_name.php`
**ìš©ë„**: íšŒì‚¬ëª… ìˆ˜ì •
**ì‚¬ìš©ë²•**: `fix_company_name.php?id=63&company=í•œí•˜ë‹ˆ&key=fix2025`

---

## âœ… ì—…ë¡œë“œ ì™„ë£Œ íŒŒì¼

### ì„œë²„ì— ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡
1. âœ… `/var/www/html/mlangprintauto/quote/includes/QuoteManager.php` - ROOT CAUSE ìˆ˜ì •
2. âœ… `/var/www/html/mlangprintauto/quote/detail.php` - 8ì»¬ëŸ¼ í†µì¼
3. âœ… `/var/www/html/mlangprintauto/quote/api/send_email.php` - 8ì»¬ëŸ¼ í†µì¼
4. âœ… `/var/www/html/mlangprintauto/quote/check_quote.php` - ì§„ë‹¨ ë„êµ¬
5. âœ… `/var/www/html/mlangprintauto/quote/fix_customer_name.php` - ìˆ˜ì • ë„êµ¬
6. âœ… `/var/www/html/mlangprintauto/quote/fix_company_name.php` - ìˆ˜ì • ë„êµ¬

---

## ğŸ§ª ì§‘ì—ì„œ í…ŒìŠ¤íŠ¸í•  í•­ëª©

### 1. ìƒˆ ê²¬ì ì„œ ì‘ì„± í…ŒìŠ¤íŠ¸
```
1. http://dsp1830.shop/mlangprintauto/quote/create.php ì ‘ì†
2. í’ˆëª© ì¶”ê°€ ë²„íŠ¼ í´ë¦­
3. í’ˆëª…, ê·œê²©, ìˆ˜ëŸ‰, ë‹¨ê°€ ì…ë ¥
4. ì €ì¥ í›„ ìƒì„¸ í˜ì´ì§€ì—ì„œ í™•ì¸
5. âœ… ì²´í¬: í’ˆëª…, ê·œê²© ë“±ì´ ì œëŒ€ë¡œ ì €ì¥ë˜ì—ˆëŠ”ê°€?
```

### 2. ê°œì •íŒ ì‘ì„± í…ŒìŠ¤íŠ¸
```
1. ê¸°ì¡´ ê²¬ì ì„œì—ì„œ "ê°œì •íŒ ì‘ì„±" í´ë¦­
2. ë‚´ìš© ìˆ˜ì • í›„ ì €ì¥
3. âœ… ì²´í¬: "Duplicate entry" ì˜¤ë¥˜ ì—†ì´ v2 ìƒì„±ë˜ëŠ”ê°€?
```

### 3. í™”ë©´ ì¼ê´€ì„± í…ŒìŠ¤íŠ¸
```
1. ê²¬ì ì„œ ìƒì„¸ í˜ì´ì§€ (detail.php) ì—´ê¸°
2. PDF ë‹¤ìš´ë¡œë“œ
3. ì´ë©”ì¼ ë°œì†¡ í›„ ë°›ì€ ë©”ì¼ í™•ì¸
4. âœ… ì²´í¬: 3ê°œ í™”ë©´ ëª¨ë‘ 8ê°œ ì»¬ëŸ¼ìœ¼ë¡œ ë™ì¼í•œê°€?
   - NO | í’ˆëª… | ê·œê²© | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ë‹¨ê°€ | ê³µê¸‰ê°€ì•¡(VATë³„ë„) | ë¹„ê³ 
```

### 4. ì „ë‹¨ì§€ íŠ¹ìˆ˜ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```
1. ì „ë‹¨ì§€(inserted) í’ˆëª©ì´ í¬í•¨ëœ ê²¬ì ì„œ ì—´ê¸°
2. âœ… ì²´í¬: ìˆ˜ëŸ‰ ì•„ë˜ì— "(5,000ë§¤)" ê°™ì€ ë§¤ìˆ˜ í‘œì‹œê°€ ìˆëŠ”ê°€?
3. âœ… ì²´í¬: ë‹¨ê°€ê°€ ì†Œìˆ˜ì  1ìë¦¬ë¡œ í‘œì‹œë˜ëŠ”ê°€? (ì˜ˆ: 12,345.0)
```

### 5. ì—­ê³„ì‚° ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```
1. ê²¬ì ì„œ ìˆ˜ì • í™”ë©´ (edit.php) ì—´ê¸°
2. ê³µê¸‰ê°€ í•„ë“œì— ê°’ ì…ë ¥
3. âœ… ì²´í¬: ë‹¨ê°€ê°€ ìë™ìœ¼ë¡œ ê³„ì‚°ë˜ëŠ”ê°€? (ë‹¨ê°€ = ê³µê¸‰ê°€ Ã· ìˆ˜ëŸ‰)
```

---

## ğŸ“Š ìˆ˜ì • ì „í›„ ë¹„êµ

### í™”ë©´ ì»¬ëŸ¼ êµ¬ì¡°

| í™”ë©´ | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|------|---------|---------|
| **PDF** | 8ì»¬ëŸ¼ (ê³µê¸‰ê°€ì•¡, ë¹„ê³ ) | âœ… 8ì»¬ëŸ¼ (ë³€ê²½ ì—†ìŒ) |
| **detail.php** | 7ì»¬ëŸ¼ (ê¸ˆì•¡ë§Œ í‘œì‹œ) | âœ… 8ì»¬ëŸ¼ (ê³µê¸‰ê°€ì•¡, ë¹„ê³ ) |
| **ì´ë©”ì¼** | 7ì»¬ëŸ¼ (ê¸ˆì•¡ë§Œ í‘œì‹œ) | âœ… 8ì»¬ëŸ¼ (ê³µê¸‰ê°€ì•¡, ë¹„ê³ ) |

### í’ˆëª© ì €ì¥ ê¸°ëŠ¥

| ìƒí™© | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|------|---------|---------|
| **ìƒˆ ê²¬ì ì„œ ì‘ì„±** | âŒ í’ˆëª…, ê·œê²© ë“± ì €ì¥ ì•ˆ ë¨ | âœ… ëª¨ë“  í•„ë“œ ì €ì¥ë¨ |
| **ê°œì •íŒ ì‘ì„±** | âŒ í’ˆëª© ì •ë³´ ëˆ„ë½ | âœ… ì •ìƒ ì €ì¥ |
| **ìˆ˜ë™ í’ˆëª© ì¶”ê°€** | âŒ ì €ì¥ ì‹¤íŒ¨ | âœ… ì •ìƒ ì €ì¥ |

---

## ğŸ” ë¬¸ì œ ì¶”ì  íˆìŠ¤í† ë¦¬

### ë¬¸ì œ ë°œê²¬ ê³¼ì •
1. **ìµœì´ˆ ì¦ìƒ**: "í’ˆëª… ë“±ì´ ì•ˆì í˜€ìš”" (í’ˆëª© ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ)
2. **ì¤‘ê°„ ì¦ìƒ**: ê³ ê°ëª…ì´ "0"ìœ¼ë¡œ í‘œì‹œë¨ (ID 63, ì›ë³¸ ID 56)
3. **ê·¼ë³¸ ì›ì¸**: QuoteManager.phpì˜ addManualItem() í•¨ìˆ˜ì— mysqli_stmt_bind_param ë²„ê·¸
4. **íŒŒê¸‰ íš¨ê³¼**: ëª¨ë“  ìƒˆ ê²¬ì ì„œ ì‘ì„± ë° ê°œì •íŒì— ì˜í–¥

### í•´ê²° ê³¼ì •
```
1ë‹¨ê³„: í™”ë©´ í†µì¼ ì‘ì—… (detail.php, send_email.php)
2ë‹¨ê³„: ë²„ì „ ê´€ë¦¬ ë²„ê·¸ ìˆ˜ì • (createRevision)
3ë‹¨ê³„: ë°ì´í„° ìˆ˜ì • ë„êµ¬ ì œê³µ (check_quote, fix_customer_name, fix_company_name)
4ë‹¨ê³„: ê·¼ë³¸ ì›ì¸ ìˆ˜ì • (addManualItem) â† ê°€ì¥ ì¤‘ìš”!
```

---

## ğŸ“ ì£¼ì˜ì‚¬í•­

### ë°ì´í„° ì •í•©ì„±
- ê¸°ì¡´ ê²¬ì ì„œ ID 56, 63 ë“±ì€ ê³¼ê±° ë²„ê·¸ë¡œ ì¸í•´ ì˜ëª»ëœ ë°ì´í„°ê°€ ìˆì„ ìˆ˜ ìˆìŒ
- í•„ìš”ì‹œ check_quote.phpë¡œ í™•ì¸ í›„ fix ë„êµ¬ë¡œ ìˆ˜ì •

### ë²„ì „ ê´€ë¦¬
- ê°œì •íŒ ì‘ì„± ì‹œ ìë™ìœ¼ë¡œ v2, v3 ë“±ì˜ ë²„ì „ ë²ˆí˜¸ê°€ ë¶€ì—¬ë¨
- ì¤‘ë³µ ì˜¤ë¥˜ëŠ” ìˆ˜ì •ë˜ì—ˆìœ¼ë‚˜, í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¬ì‹œë„

### ì „ë‹¨ì§€ íŠ¹ìˆ˜ ì²˜ë¦¬
- product_type = 'inserted'ì¸ ê²½ìš°:
  - ë§¤ìˆ˜(mesu) ì •ë³´ê°€ source_data JSONì— ì €ì¥ë¨
  - ë‹¨ê°€ëŠ” ì†Œìˆ˜ì  1ìë¦¬ë¡œ í‘œì‹œë¨

---

## ğŸš€ í–¥í›„ ê°œì„  ê°€ëŠ¥ í•­ëª©

1. **ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**: ê¸°ì¡´ ê²¬ì ì„œì˜ ì˜ëª»ëœ ë°ì´í„° ì¼ê´„ ìˆ˜ì •
2. **í’ˆëª© í…œí”Œë¦¿**: ìì£¼ ì‚¬ìš©í•˜ëŠ” í’ˆëª©ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥
3. **ì¼ê´„ í¸ì§‘**: ì—¬ëŸ¬ í’ˆëª©ì„ í•œ ë²ˆì— ìˆ˜ì •í•˜ëŠ” ê¸°ëŠ¥
4. **íˆìŠ¤í† ë¦¬ ì¶”ì **: ê²¬ì ì„œ ìˆ˜ì • ì´ë ¥ì„ ìƒì„¸íˆ ê¸°ë¡

---

**ì‘ì„± ì™„ë£Œ**: 2025-11-26
**ë‹¤ìŒ ì‘ì—… ì‹œ ì°¸ê³ **: ì´ ë¬¸ì„œì™€ í•¨ê»˜ í…ŒìŠ¤íŠ¸ ì§„í–‰

**ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´**:
- check_quote.phpë¡œ ë°ì´í„° í™•ì¸
- ì´ ë¬¸ì„œì˜ "ì§‘ì—ì„œ í…ŒìŠ¤íŠ¸í•  í•­ëª©" ì°¸ê³ 
