/**
 * ÌÜµÌï© Í∞§Îü¨Î¶¨ Ïª¥Ìè¨ÎÑåÌä∏ ÏãúÏä§ÌÖú v2.0
 * ÎçîÏö± Ìñ•ÏÉÅÎêú Ïû¨ÏÇ¨Ïö©ÏÑ±Í≥º ÌôïÏû•ÏÑ±ÏùÑ Ï†úÍ≥µÌïòÎäî Í∞§Îü¨Î¶¨ Ïª¥Ìè¨ÎÑåÌä∏
 * 
 * Features:
 * - ÏôÑÏ†ÑÌïú Ïª¥Ìè¨ÎÑåÌä∏Ìôî Î∞è Î™®ÎìàÌôî
 * - Ïù¥Î≤§Ìä∏ Í∏∞Î∞ò ÌÜµÏã† ÏãúÏä§ÌÖú
 * - ÌÖåÎßà Î∞è Ïä§ÌÉÄÏùº Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï
 * - Î∞òÏùëÌòï ÎîîÏûêÏù∏ ÏßÄÏõê
 * - Ï†ëÍ∑ºÏÑ± Ìñ•ÏÉÅ (ARIA ÏÜçÏÑ±)
 * - ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ ÏßÄÏõê
 */

class GalleryComponent {
    static VERSION = '2.0.0';
    static instances = new Map();
    
    constructor(config = {}) {
        // Í≥†Ïú† ID ÏÉùÏÑ±
        this.id = config.id || `gallery_${Date.now()}`;
        
        // Í∏∞Î≥∏ ÏÑ§Ï†ïÍ≥º ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î≥ëÌï©
        this.config = {
            ...this.getDefaultConfig(),
            ...config
        };
        
        // Ïª¥Ìè¨ÎÑåÌä∏ ÏÉÅÌÉú
        this.state = {
            images: [],
            currentIndex: 0,
            isLoading: false,
            isError: false,
            errorMessage: '',
            isZoomed: false,
            thumbnailsVisible: true
        };
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ÄÏû•ÏÜå
        this.eventListeners = new Map();
        
        // Ïï†ÎãàÎ©îÏù¥ÏÖò Í¥ÄÎ†®
        this.animation = {
            frame: null,
            currentX: 50,
            currentY: 50,
            currentScale: 1,
            targetX: 50,
            targetY: 50,
            targetScale: 1
        };
        
        // ÌÑ∞Ïπò ÏßÄÏõê
        this.touch = {
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0,
            isSwipping: false
        };
        
        // Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•
        GalleryComponent.instances.set(this.id, this);
    }
    
    /**
     * Í∏∞Î≥∏ ÏÑ§Ï†ï
     */
    getDefaultConfig() {
        return {
            // Ïª®ÌÖåÏù¥ÎÑà ÏÑ§Ï†ï
            container: null,
            containerClass: 'gallery-component',
            
            // Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§
            dataSource: null,
            dataType: 'json', // json, array, html
            images: [],
            
            // ÎîîÏä§ÌîåÎ†àÏù¥ ÏÑ§Ï†ï
            layout: 'grid', // grid, carousel, masonry
            columns: 4,
            gap: 10,
            aspectRatio: '1:1',
            
            // Í∏∞Îä• ÏÑ§Ï†ï
            features: {
                zoom: true,
                lightbox: true,
                thumbnails: true,
                navigation: true,
                autoplay: false,
                download: false,
                share: false,
                fullscreen: true
            },
            
            // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÑ§Ï†ï
            animation: {
                enabled: true,
                duration: 300,
                easing: 'ease-in-out'
            },
            
            // ÌÖåÎßà ÏÑ§Ï†ï
            theme: {
                primary: '#667eea',
                secondary: '#764ba2',
                background: '#ffffff',
                text: '#333333',
                border: '#e0e0e0'
            },
            
            // Î∞òÏùëÌòï ÏÑ§Ï†ï
            responsive: {
                breakpoints: {
                    mobile: 576,
                    tablet: 768,
                    desktop: 1024
                },
                columnsOnMobile: 2,
                columnsOnTablet: 3
            },
            
            // ÏΩúÎ∞± Ìï®Ïàò
            callbacks: {
                onInit: null,
                onLoad: null,
                onImageChange: null,
                onZoom: null,
                onError: null,
                onDestroy: null
            },
            
            // Ï†ëÍ∑ºÏÑ±
            accessibility: {
                enabled: true,
                labels: {
                    gallery: 'Ïù¥ÎØ∏ÏßÄ Í∞§Îü¨Î¶¨',
                    thumbnail: 'Ïç∏ÎÑ§Ïùº',
                    mainImage: 'Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ',
                    nextButton: 'Îã§Ïùå Ïù¥ÎØ∏ÏßÄ',
                    prevButton: 'Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄ',
                    zoomIn: 'ÌôïÎåÄ',
                    zoomOut: 'Ï∂ïÏÜå',
                    close: 'Îã´Í∏∞'
                }
            },
            
            // Î°úÏª¨ÎùºÏù¥Ï†úÏù¥ÏÖò
            locale: 'ko',
            translations: {
                ko: {
                    loading: 'Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...',
                    error: 'Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.',
                    empty: 'ÌëúÏãúÌï† Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.',
                    imageCounter: '{{current}} / {{total}}'
                },
                en: {
                    loading: 'Loading images...',
                    error: 'Failed to load images.',
                    empty: 'No images to display.',
                    imageCounter: '{{current}} / {{total}}'
                }
            }
        };
    }
    
    /**
     * Í∞§Îü¨Î¶¨ Ï¥àÍ∏∞Ìôî
     */
    async init() {
        try {
            // Ïª®ÌÖåÏù¥ÎÑà Í≤ÄÏ¶ù
            if (typeof this.config.container === 'string') {
                this.container = document.querySelector(this.config.container);
            } else {
                this.container = this.config.container;
            }
            
            if (!this.container) {
                throw new Error('Gallery container not found');
            }
            
            // HTML Íµ¨Ï°∞ ÏÉùÏÑ±
            this.render();
            
            // Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
            this.bindEvents();
            
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (this.config.dataSource) {
                await this.loadData();
            } else if (this.config.images.length > 0) {
                this.setImages(this.config.images);
            }
            
            // Î∞òÏùëÌòï Ï≤òÎ¶¨
            this.handleResponsive();
            
            // Ï¥àÍ∏∞Ìôî ÏΩúÎ∞±
            this.trigger('init');
            
            console.log(`‚úÖ GalleryComponent v${GalleryComponent.VERSION} initialized:`, this.id);
            
        } catch (error) {
            console.error('Gallery initialization failed:', error);
            this.showError(error.message);
            this.trigger('error', error);
        }
    }
    
    /**
     * HTML Î†åÎçîÎßÅ
     */
    render() {
        const theme = this.config.theme;
        const features = this.config.features;
        
        this.container.innerHTML = `
            <div class="${this.config.containerClass}" id="${this.id}" 
                 role="region" 
                 aria-label="${this.config.accessibility.labels.gallery}"
                 style="--primary-color: ${theme.primary}; --secondary-color: ${theme.secondary};">
                
                <!-- Î©îÏù∏ Î∑∞Ïñ¥ ÏòÅÏó≠ -->
                <div class="gallery-viewer">
                    <div class="gallery-main-image" role="img" aria-label="${this.config.accessibility.labels.mainImage}">
                        <img src="" alt="" />
                        ${features.zoom ? '<div class="zoom-indicator">üîç</div>' : ''}
                    </div>
                    
                    ${features.navigation ? `
                    <div class="gallery-navigation">
                        <button class="nav-prev" aria-label="${this.config.accessibility.labels.prevButton}">‚Äπ</button>
                        <button class="nav-next" aria-label="${this.config.accessibility.labels.nextButton}">‚Ä∫</button>
                    </div>
                    ` : ''}
                    
                    <div class="gallery-counter"></div>
                </div>
                
                ${features.thumbnails ? `
                <!-- Ïç∏ÎÑ§Ïùº ÏòÅÏó≠ -->
                <div class="gallery-thumbnails" role="list">
                    <div class="thumbnails-container"></div>
                </div>
                ` : ''}
                
                <!-- Î°úÎî©/ÏóêÎü¨ ÏÉÅÌÉú -->
                <div class="gallery-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>${this.getTranslation('loading')}</p>
                </div>
                
                <div class="gallery-error" style="display: none;">
                    <p class="error-message"></p>
                </div>
                
                ${features.lightbox ? `
                <!-- ÎùºÏù¥Ìä∏Î∞ïÏä§ -->
                <div class="gallery-lightbox" style="display: none;">
                    <div class="lightbox-overlay"></div>
                    <div class="lightbox-content">
                        <img src="" alt="" />
                        <button class="lightbox-close" aria-label="${this.config.accessibility.labels.close}">√ó</button>
                        ${features.fullscreen ? '<button class="lightbox-fullscreen">‚õ∂</button>' : ''}
                        ${features.download ? '<button class="lightbox-download">‚¨á</button>' : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        // Ïä§ÌÉÄÏùº Ï£ºÏûÖ
        this.injectStyles();
    }
    
    /**
     * Ïä§ÌÉÄÏùº Ï£ºÏûÖ
     */
    injectStyles() {
        if (document.getElementById('gallery-component-styles')) return;
        
        const styles = document.createElement('style');
        styles.id = 'gallery-component-styles';
        styles.textContent = `
            .gallery-component {
                position: relative;
                width: 100%;
                background: var(--background-color, #fff);
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            }
            
            .gallery-viewer {
                position: relative;
                width: 100%;
                padding-bottom: 75%; /* 4:3 aspect ratio */
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                overflow: hidden;
            }
            
            .gallery-main-image {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .gallery-main-image img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                transition: transform 0.3s ease;
            }
            
            .gallery-main-image:hover img {
                transform: scale(1.05);
            }
            
            .gallery-thumbnails {
                padding: 1rem;
                background: #f8f9fa;
            }
            
            .thumbnails-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 0.5rem;
            }
            
            .thumbnail-item {
                aspect-ratio: 1;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
            }
            
            .thumbnail-item:hover {
                transform: scale(1.1);
                border-color: var(--primary-color);
            }
            
            .thumbnail-item.active {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            }
            
            .thumbnail-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .gallery-navigation button {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255,255,255,0.9);
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                font-size: 24px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }
            
            .gallery-navigation button:hover {
                background: white;
                transform: translateY(-50%) scale(1.1);
            }
            
            .nav-prev { left: 1rem; }
            .nav-next { right: 1rem; }
            
            .gallery-counter {
                position: absolute;
                bottom: 1rem;
                right: 1rem;
                background: rgba(0,0,0,0.6);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.875rem;
            }
            
            .gallery-lightbox {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .lightbox-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
            }
            
            .lightbox-content {
                position: relative;
                max-width: 90%;
                max-height: 90%;
                z-index: 1;
            }
            
            .lightbox-content img {
                max-width: 100%;
                max-height: 90vh;
                object-fit: contain;
            }
            
            .lightbox-close {
                position: absolute;
                top: -40px;
                right: 0;
                background: none;
                border: none;
                color: white;
                font-size: 36px;
                cursor: pointer;
                transition: transform 0.3s ease;
            }
            
            .lightbox-close:hover {
                transform: scale(1.2);
            }
            
            .gallery-loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }
            
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid var(--primary-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 1rem;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .gallery-error {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: #dc3545;
            }
            
            .zoom-indicator {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: rgba(255,255,255,0.9);
                padding: 0.5rem;
                border-radius: 50%;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .gallery-main-image:hover .zoom-indicator {
                opacity: 1;
            }
            
            /* Î∞òÏùëÌòï Ïä§ÌÉÄÏùº */
            @media (max-width: 768px) {
                .thumbnails-container {
                    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                }
                
                .gallery-navigation button {
                    width: 35px;
                    height: 35px;
                    font-size: 20px;
                }
            }
            
            @media (max-width: 576px) {
                .gallery-viewer {
                    padding-bottom: 100%; /* 1:1 on mobile */
                }
                
                .thumbnails-container {
                    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                }
            }
        `;
        
        document.head.appendChild(styles);
    }
    
    /**
     * Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
     */
    bindEvents() {
        const viewer = this.container.querySelector('.gallery-main-image');
        const thumbnails = this.container.querySelector('.thumbnails-container');
        const navPrev = this.container.querySelector('.nav-prev');
        const navNext = this.container.querySelector('.nav-next');
        const lightbox = this.container.querySelector('.gallery-lightbox');
        
        // Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ - ÎùºÏù¥Ìä∏Î∞ïÏä§
        if (viewer && this.config.features.lightbox) {
            viewer.addEventListener('click', () => this.openLightbox());
        }
        
        // Ïç∏ÎÑ§Ïùº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
        if (thumbnails) {
            thumbnails.addEventListener('click', (e) => {
                const thumbnail = e.target.closest('.thumbnail-item');
                if (thumbnail) {
                    const index = parseInt(thumbnail.dataset.index);
                    this.goToImage(index);
                }
            });
        }
        
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        if (navPrev) navPrev.addEventListener('click', () => this.prevImage());
        if (navNext) navNext.addEventListener('click', () => this.nextImage());
        
        // ÎùºÏù¥Ìä∏Î∞ïÏä§ Îã´Í∏∞
        if (lightbox) {
            const overlay = lightbox.querySelector('.lightbox-overlay');
            const closeBtn = lightbox.querySelector('.lightbox-close');
            
            if (overlay) overlay.addEventListener('click', () => this.closeLightbox());
            if (closeBtn) closeBtn.addEventListener('click', () => this.closeLightbox());
        }
        
        // ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        document.addEventListener('keydown', (e) => {
            if (!this.state.isZoomed) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    this.prevImage();
                    break;
                case 'ArrowRight':
                    this.nextImage();
                    break;
                case 'Escape':
                    this.closeLightbox();
                    break;
            }
        });
        
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ (Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑ)
        if (viewer && 'ontouchstart' in window) {
            viewer.addEventListener('touchstart', (e) => this.handleTouchStart(e));
            viewer.addEventListener('touchmove', (e) => this.handleTouchMove(e));
            viewer.addEventListener('touchend', (e) => this.handleTouchEnd(e));
        }
        
        // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à
        window.addEventListener('resize', () => this.handleResponsive());
    }
    
    /**
     * Îç∞Ïù¥ÌÑ∞ Î°úÎìú
     */
    async loadData() {
        this.setState({ isLoading: true, isError: false });
        this.showLoading(true);
        
        try {
            let data;
            
            if (this.config.dataType === 'json') {
                const response = await fetch(this.config.dataSource);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const json = await response.json();
                data = json.data || json.images || json;
            } else if (this.config.dataType === 'array') {
                data = this.config.dataSource;
            }
            
            if (!Array.isArray(data)) {
                throw new Error('Invalid data format');
            }
            
            this.setImages(data);
            this.trigger('load', data);
            
        } catch (error) {
            console.error('Failed to load gallery data:', error);
            this.showError(error.message);
            this.trigger('error', error);
        } finally {
            this.setState({ isLoading: false });
            this.showLoading(false);
        }
    }
    
    /**
     * Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
     */
    setImages(images) {
        // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ïÍ∑úÌôî
        this.state.images = images.map((img, index) => {
            if (typeof img === 'string') {
                return {
                    id: index,
                    src: img,
                    thumbnail: img,
                    title: `Image ${index + 1}`,
                    alt: `Image ${index + 1}`
                };
            }
            return {
                id: img.id || index,
                src: img.src || img.url || img.path,
                thumbnail: img.thumbnail || img.thumb || img.src || img.url || img.path,
                title: img.title || img.name || `Image ${index + 1}`,
                alt: img.alt || img.title || `Image ${index + 1}`,
                ...img
            };
        });
        
        if (this.state.images.length > 0) {
            this.renderThumbnails();
            this.goToImage(0);
        } else {
            this.showEmpty();
        }
    }
    
    /**
     * Ïç∏ÎÑ§Ïùº Î†åÎçîÎßÅ
     */
    renderThumbnails() {
        const container = this.container.querySelector('.thumbnails-container');
        if (!container) return;
        
        container.innerHTML = this.state.images.map((img, index) => `
            <div class="thumbnail-item ${index === 0 ? 'active' : ''}" 
                 data-index="${index}"
                 role="listitem"
                 tabindex="0"
                 aria-label="${img.alt}">
                <img src="${img.thumbnail}" alt="${img.alt}" loading="lazy" />
            </div>
        `).join('');
    }
    
    /**
     * ÌäπÏ†ï Ïù¥ÎØ∏ÏßÄÎ°ú Ïù¥Îèô
     */
    goToImage(index) {
        if (index < 0 || index >= this.state.images.length) return;
        
        const image = this.state.images[index];
        this.state.currentIndex = index;
        
        // Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        const mainImg = this.container.querySelector('.gallery-main-image img');
        if (mainImg) {
            mainImg.src = image.src;
            mainImg.alt = image.alt;
        }
        
        // ÎùºÏù¥Ìä∏Î∞ïÏä§ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        const lightboxImg = this.container.querySelector('.lightbox-content img');
        if (lightboxImg) {
            lightboxImg.src = image.src;
            lightboxImg.alt = image.alt;
        }
        
        // Ïç∏ÎÑ§Ïùº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        this.updateThumbnailActive(index);
        
        // Ïπ¥Ïö¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        this.updateCounter();
        
        // Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
        this.trigger('imageChange', { index, image });
    }
    
    /**
     * Ïç∏ÎÑ§Ïùº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateThumbnailActive(index) {
        const thumbnails = this.container.querySelectorAll('.thumbnail-item');
        thumbnails.forEach((thumb, i) => {
            if (i === index) {
                thumb.classList.add('active');
                thumb.setAttribute('aria-selected', 'true');
            } else {
                thumb.classList.remove('active');
                thumb.setAttribute('aria-selected', 'false');
            }
        });
    }
    
    /**
     * Ïπ¥Ïö¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateCounter() {
        const counter = this.container.querySelector('.gallery-counter');
        if (!counter) return;
        
        const text = this.getTranslation('imageCounter')
            .replace('{{current}}', this.state.currentIndex + 1)
            .replace('{{total}}', this.state.images.length);
        
        counter.textContent = text;
    }
    
    /**
     * Îã§Ïùå Ïù¥ÎØ∏ÏßÄ
     */
    nextImage() {
        const nextIndex = (this.state.currentIndex + 1) % this.state.images.length;
        this.goToImage(nextIndex);
    }
    
    /**
     * Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄ
     */
    prevImage() {
        const prevIndex = (this.state.currentIndex - 1 + this.state.images.length) % this.state.images.length;
        this.goToImage(prevIndex);
    }
    
    /**
     * ÎùºÏù¥Ìä∏Î∞ïÏä§ Ïó¥Í∏∞
     */
    openLightbox() {
        const lightbox = this.container.querySelector('.gallery-lightbox');
        if (!lightbox) return;
        
        lightbox.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        this.state.isZoomed = true;
        
        this.trigger('zoom', { opened: true });
    }
    
    /**
     * ÎùºÏù¥Ìä∏Î∞ïÏä§ Îã´Í∏∞
     */
    closeLightbox() {
        const lightbox = this.container.querySelector('.gallery-lightbox');
        if (!lightbox) return;
        
        lightbox.style.display = 'none';
        document.body.style.overflow = '';
        this.state.isZoomed = false;
        
        this.trigger('zoom', { opened: false });
    }
    
    /**
     * ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
     */
    handleTouchStart(e) {
        this.touch.startX = e.touches[0].clientX;
        this.touch.startY = e.touches[0].clientY;
        this.touch.isSwipping = true;
    }
    
    handleTouchMove(e) {
        if (!this.touch.isSwipping) return;
        
        this.touch.endX = e.touches[0].clientX;
        this.touch.endY = e.touches[0].clientY;
    }
    
    handleTouchEnd(e) {
        if (!this.touch.isSwipping) return;
        
        const diffX = this.touch.startX - this.touch.endX;
        const diffY = this.touch.startY - this.touch.endY;
        const threshold = 50;
        
        // ÏàòÌèâ Ïä§ÏôÄÏù¥ÌîÑ Í∞êÏßÄ
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
            if (diffX > 0) {
                this.nextImage(); // ÏôºÏ™Ω Ïä§ÏôÄÏù¥ÌîÑ
            } else {
                this.prevImage(); // Ïò§Î•∏Ï™Ω Ïä§ÏôÄÏù¥ÌîÑ
            }
        }
        
        this.touch.isSwipping = false;
    }
    
    /**
     * Î∞òÏùëÌòï Ï≤òÎ¶¨
     */
    handleResponsive() {
        const width = window.innerWidth;
        const breakpoints = this.config.responsive.breakpoints;
        const container = this.container.querySelector('.thumbnails-container');
        
        if (!container) return;
        
        let columns;
        if (width <= breakpoints.mobile) {
            columns = this.config.responsive.columnsOnMobile;
        } else if (width <= breakpoints.tablet) {
            columns = this.config.responsive.columnsOnTablet;
        } else {
            columns = this.config.columns;
        }
        
        container.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
    }
    
    /**
     * ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
     */
    setState(newState) {
        this.state = { ...this.state, ...newState };
    }
    
    /**
     * Î°úÎî© ÌëúÏãú
     */
    showLoading(show) {
        const loading = this.container.querySelector('.gallery-loading');
        if (loading) {
            loading.style.display = show ? 'block' : 'none';
        }
    }
    
    /**
     * ÏóêÎü¨ ÌëúÏãú
     */
    showError(message) {
        const error = this.container.querySelector('.gallery-error');
        const errorMessage = this.container.querySelector('.error-message');
        
        if (error && errorMessage) {
            errorMessage.textContent = message || this.getTranslation('error');
            error.style.display = 'block';
        }
        
        this.setState({ isError: true, errorMessage: message });
    }
    
    /**
     * Îπà ÏÉÅÌÉú ÌëúÏãú
     */
    showEmpty() {
        const viewer = this.container.querySelector('.gallery-viewer');
        if (viewer) {
            viewer.innerHTML = `
                <div class="gallery-empty">
                    <p>${this.getTranslation('empty')}</p>
                </div>
            `;
        }
    }
    
    /**
     * Î≤àÏó≠ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    getTranslation(key) {
        const locale = this.config.locale;
        const translations = this.config.translations[locale] || this.config.translations.ko;
        return translations[key] || key;
    }
    
    /**
     * Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
     */
    on(event, callback) {
        if (!this.eventListeners.has(event)) {
            this.eventListeners.set(event, []);
        }
        this.eventListeners.get(event).push(callback);
    }
    
    /**
     * Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
     */
    off(event, callback) {
        if (!this.eventListeners.has(event)) return;
        
        const listeners = this.eventListeners.get(event);
        const index = listeners.indexOf(callback);
        
        if (index > -1) {
            listeners.splice(index, 1);
        }
    }
    
    /**
     * Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
     */
    trigger(event, data = {}) {
        // ÎÇ¥Î∂Ä ÏΩúÎ∞± Ïã§Ìñâ
        const callbackName = `on${event.charAt(0).toUpperCase()}${event.slice(1)}`;
        if (this.config.callbacks[callbackName]) {
            this.config.callbacks[callbackName].call(this, data);
        }
        
        // Îì±Î°ùÎêú Î¶¨Ïä§ÎÑà Ïã§Ìñâ
        if (this.eventListeners.has(event)) {
            this.eventListeners.get(event).forEach(callback => {
                callback.call(this, data);
            });
        }
    }
    
    /**
     * Í∞§Îü¨Î¶¨ ÌååÍ¥¥
     */
    destroy() {
        // Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ïÎ¶¨
        if (this.animation.frame) {
            cancelAnimationFrame(this.animation.frame);
        }
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
        this.eventListeners.clear();
        
        // DOM Ï†ïÎ¶¨
        if (this.container) {
            this.container.innerHTML = '';
        }
        
        // Ïù∏Ïä§ÌÑ¥Ïä§ Ï†úÍ±∞
        GalleryComponent.instances.delete(this.id);
        
        // ÏΩúÎ∞± Ïã§Ìñâ
        this.trigger('destroy');
        
        console.log(`GalleryComponent destroyed: ${this.id}`);
    }
    
    /**
     * Ï†ïÏ†Å Î©îÏÑúÎìú: IDÎ°ú Ïù∏Ïä§ÌÑ¥Ïä§ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    static getInstance(id) {
        return GalleryComponent.instances.get(id);
    }
    
    /**
     * Ï†ïÏ†Å Î©îÏÑúÎìú: Î™®Îì† Ïù∏Ïä§ÌÑ¥Ïä§ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    static getAllInstances() {
        return Array.from(GalleryComponent.instances.values());
    }
    
    /**
     * Ï†ïÏ†Å Î©îÏÑúÎìú: Î™®Îì† Ïù∏Ïä§ÌÑ¥Ïä§ ÌååÍ¥¥
     */
    static destroyAll() {
        GalleryComponent.instances.forEach(instance => instance.destroy());
    }
}

// Ï†ÑÏó≠ Îì±Î°ù
window.GalleryComponent = GalleryComponent;

// jQuery ÌîåÎü¨Í∑∏Ïù∏ (ÏÑ†ÌÉùÏ†Å)
if (typeof jQuery !== 'undefined') {
    jQuery.fn.galleryComponent = function(options) {
        return this.each(function() {
            const $element = jQuery(this);
            let instance = $element.data('galleryComponent');
            
            if (!instance) {
                instance = new GalleryComponent({
                    container: this,
                    ...options
                });
                instance.init();
                $element.data('galleryComponent', instance);
            }
            
            return instance;
        });
    };
}

// ÏûêÎèô Ï¥àÍ∏∞Ìôî (data ÏÜçÏÑ± ÏÇ¨Ïö©)
document.addEventListener('DOMContentLoaded', function() {
    const galleries = document.querySelectorAll('[data-gallery-component]');
    
    galleries.forEach(element => {
        const config = element.dataset.galleryComponent;
        let options = {};
        
        try {
            options = config ? JSON.parse(config) : {};
        } catch (e) {
            console.warn('Invalid gallery config:', e);
        }
        
        const gallery = new GalleryComponent({
            container: element,
            ...options
        });
        
        gallery.init();
    });
});

console.log('‚ú® GalleryComponent v2.0.0 loaded');