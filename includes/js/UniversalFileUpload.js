/**
 * Î≤îÏö© ÌååÏùº ÏóÖÎ°úÎìú JavaScript ÌÅ¥ÎûòÏä§
 * Î™®Îì† ÌíàÎ™©ÏóêÏÑú Ïû¨ÏÇ¨Ïö© Í∞ÄÎä•
 */
class UniversalFileUpload {
    constructor(containerId, config = {}) {
        this.container = document.getElementById(containerId);
        this.config = {
            product_type: 'general',
            max_file_size: 10 * 1024 * 1024,
            allowed_types: ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'],
            allowed_extensions: ['jpg', 'jpeg', 'png', 'pdf'],
            upload_url: '../../includes/upload_handler.php',
            get_files_url: '../../includes/get_files_handler.php',
            delete_file_url: '../../includes/delete_file_handler.php',
            multiple: true,
            drag_drop: true,
            show_progress: true,
            auto_upload: true,
            delete_enabled: true,
            preview_enabled: true,
            ...config
        };
        
        this.uploadedFiles = [];
        this.init();
    }
    
    init() {
        this.dropZone = this.container.querySelector('.drop-zone');
        this.fileInput = this.container.querySelector('.file-input');
        this.fileList = this.container.querySelector('.file-list');
        this.uploadProgress = this.container.querySelector('.upload-progress');
        this.progressFill = this.container.querySelector('.progress-fill');
        this.progressText = this.container.querySelector('.progress-text');
        this.btnFileSelect = this.container.querySelector('.btn-file-select');
        
        this.setupEvents();
        this.loadExistingFiles();
    }
    
    setupEvents() {
        if (this.config.drag_drop && this.dropZone) {
            // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                this.dropZone.addEventListener(eventName, this.preventDefaults, false);
                document.body.addEventListener(eventName, this.preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                this.dropZone.addEventListener(eventName, this.highlight.bind(this), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                this.dropZone.addEventListener(eventName, this.unhighlight.bind(this), false);
            });
            
            this.dropZone.addEventListener('drop', this.handleDrop.bind(this), false);
            this.dropZone.addEventListener('click', () => this.fileInput.click());
        }
        
        if (this.btnFileSelect) {
            this.btnFileSelect.addEventListener('click', () => this.fileInput.click());
        }
        
        if (this.fileInput) {
            this.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
        }
    }
    
    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    highlight() {
        if (this.dropZone) {
            this.dropZone.style.borderColor = '#007bff';
            this.dropZone.style.backgroundColor = '#f8f9ff';
            this.dropZone.style.transform = 'scale(1.02)';
        }
    }
    
    unhighlight() {
        if (this.dropZone) {
            this.dropZone.style.borderColor = '#007bff';
            this.dropZone.style.backgroundColor = 'white';
            this.dropZone.style.transform = 'scale(1)';
        }
    }
    
    handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        this.handleFiles(files);
    }
    
    handleFileSelect(e) {
        const files = e.target.files;
        this.handleFiles(files);
    }
    
    handleFiles(files) {
        [...files].forEach(file => this.processFile(file));
    }
    
    processFile(file) {
        if (!this.validateFile(file)) return;
        
        if (this.config.auto_upload) {
            this.uploadFile(file);
        } else {
            this.addFileToQueue(file);
        }
    }
    
    validateFile(file) {
        // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
        if (file.size > this.config.max_file_size) {
            this.showError(`ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ${this.config.max_file_size / 1024 / 1024}MBÎ•º Ï¥àÍ≥ºÌï©ÎãàÎã§: ${file.name}`);
            return false;
        }
        
        // ÌååÏùº ÌòïÏãù Í≤ÄÏ¶ù
        if (!this.config.allowed_types.includes(file.type)) {
            this.showError(`ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§: ${file.name}\nÏßÄÏõê ÌòïÏãù: ${this.config.allowed_extensions.join(', ').toUpperCase()}`);
            return false;
        }
        
        return true;
    }
    
    uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('product_type', this.config.product_type);
        formData.append('session_id', this.getSessionId());
        
        // ÌååÏùº Î™©Î°ùÏóê Ï∂îÍ∞Ä (ÏóÖÎ°úÎìú Ï§ë ÏÉÅÌÉú)
        const fileItem = this.addFileToList(file, 'uploading');
        
        // ÏßÑÌñâÎ•† ÌëúÏãú
        if (this.config.show_progress) {
            this.showProgress();
        }
        
        fetch(this.config.upload_url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.updateFileStatus(fileItem, 'success', data.file_info);
                this.uploadedFiles.push(data.file_info);
                this.onFileUploaded(data.file_info);
            } else {
                this.updateFileStatus(fileItem, 'error', null, data.message);
                this.onUploadError(data.message);
            }
        })
        .catch(error => {
            console.error('ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
            this.updateFileStatus(fileItem, 'error', null, 'ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            this.onUploadError(error.message);
        })
        .finally(() => {
            if (this.config.show_progress) {
                this.hideProgress();
            }
        });
    }
    
    addFileToList(file, status) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9rem;
        `;
        
        const fileName = file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2) + 'MB';
        
        fileItem.innerHTML = `
            <div class="file-info">
                <span class="file-name" style="font-weight: 600;">${fileName}</span>
                <span class="file-size" style="color: #6c757d; margin-left: 0.5rem;">(${fileSize})</span>
            </div>
            <div class="file-status">
                ${this.getStatusIcon(status)}
            </div>
        `;
        
        this.fileList.appendChild(fileItem);
        return fileItem;
    }
    
    updateFileStatus(fileItem, status, fileInfo = null, errorMessage = null) {
        const statusElement = fileItem.querySelector('.file-status');
        statusElement.innerHTML = this.getStatusIcon(status, fileInfo);
        
        if (status === 'error' && errorMessage) {
            fileItem.style.borderColor = '#dc3545';
            fileItem.title = errorMessage;
        } else if (status === 'success') {
            fileItem.style.borderColor = '#28a745';
        }
    }
    
    getStatusIcon(status, fileInfo = null) {
        switch (status) {
            case 'uploading':
                return '<span style="color: #007bff;">‚è≥ ÏóÖÎ°úÎìú Ï§ë...</span>';
            case 'success':
                let successHtml = '<span style="color: #28a745;">‚úÖ ÏôÑÎ£å</span>';
                if (this.config.delete_enabled && fileInfo) {
                    successHtml += `
                        <button onclick="window.deleteUploadedFile(${fileInfo.id}, this)" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem; margin-left: 0.5rem;">
                            üóëÔ∏è ÏÇ≠Ï†ú
                        </button>
                    `;
                }
                return successHtml;
            case 'error':
                return '<span style="color: #dc3545;">‚ùå Ïã§Ìå®</span>';
            default:
                return '';
        }
    }
    
    showProgress() {
        if (this.uploadProgress) {
            this.uploadProgress.style.display = 'block';
            this.progressText.textContent = 'ÌååÏùº ÏóÖÎ°úÎìú Ï§ë...';
            
            // Í∞ÄÏßú ÏßÑÌñâÎ•† Ïï†ÎãàÎ©îÏù¥ÏÖò
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                this.progressFill.style.width = progress + '%';
            }, 200);
            
            this.progressInterval = interval;
        }
    }
    
    hideProgress() {
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
        }
        
        if (this.progressFill && this.progressText && this.uploadProgress) {
            this.progressFill.style.width = '100%';
            this.progressText.textContent = 'ÏóÖÎ°úÎìú ÏôÑÎ£å!';
            
            setTimeout(() => {
                this.uploadProgress.style.display = 'none';
                this.progressFill.style.width = '0%';
            }, 1000);
        }
    }
    
    loadExistingFiles() {
        fetch(`${this.config.get_files_url}?product_type=${this.config.product_type}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.files.length > 0) {
                data.files.forEach(file => {
                    const fileItem = this.createExistingFileItem(file);
                    this.fileList.appendChild(fileItem);
                    this.uploadedFiles.push(file);
                });
            }
        })
        .catch(error => {
            console.error('Í∏∞Ï°¥ ÌååÏùº Î°úÎìú Ïò§Î•ò:', error);
        });
    }
    
    createExistingFileItem(file) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #28a745;
            border-radius: 5px;
            font-size: 0.9rem;
        `;
        
        const fileName = file.original_name.length > 30 ? 
            file.original_name.substring(0, 30) + '...' : file.original_name;
        const fileSize = (file.file_size / 1024 / 1024).toFixed(2) + 'MB';
        
        fileItem.innerHTML = `
            <div class="file-info">
                <span class="file-name" style="font-weight: 600;">${fileName}</span>
                <span class="file-size" style="color: #6c757d; margin-left: 0.5rem;">(${fileSize})</span>
                <span class="upload-date" style="color: #868e96; margin-left: 0.5rem; font-size: 0.8rem;">
                    ${new Date(file.upload_date).toLocaleString()}
                </span>
            </div>
            <div class="file-actions">
                <span style="color: #28a745; margin-right: 0.5rem;">‚úÖ ÏóÖÎ°úÎìú ÏôÑÎ£å</span>
                ${this.config.delete_enabled ? `
                    <button onclick="window.deleteUploadedFile(${file.id}, this)" 
                            style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">
                        üóëÔ∏è ÏÇ≠Ï†ú
                    </button>
                ` : ''}
            </div>
        `;
        
        return fileItem;
    }
    
    getSessionId() {
        // PHP ÏÑ∏ÏÖò IDÎ•º Í∞ÄÏ†∏Ïò§Îäî Î∞©Î≤ï (ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Î∞õÏïÑÏïº Ìï®)
        return document.querySelector('meta[name="session-id"]')?.content || '';
    }
    
    showError(message) {
        alert(message);
    }
    
    // Ïù¥Î≤§Ìä∏ ÏΩúÎ∞± Ìï®ÏàòÎì§
    onFileUploaded(fileInfo) {
        // ÌååÏùº ÏóÖÎ°úÎìú ÏôÑÎ£å Ïãú Ìò∏Ï∂ú
        console.log('ÌååÏùº ÏóÖÎ°úÎìú ÏôÑÎ£å:', fileInfo);
    }
    
    onUploadError(error) {
        // ÏóÖÎ°úÎìú Ïò§Î•ò Ïãú Ìò∏Ï∂ú
        console.error('ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
    }
    
    onFileDeleted(fileId) {
        // ÌååÏùº ÏÇ≠Ï†ú ÏôÑÎ£å Ïãú Ìò∏Ï∂ú
        console.log('ÌååÏùº ÏÇ≠Ï†ú ÏôÑÎ£å:', fileId);
    }
    
    // Í≥µÍ∞ú Î©îÏÑúÎìúÎì§
    getUploadedFiles() {
        return this.uploadedFiles;
    }
    
    clearAllFiles() {
        this.fileList.innerHTML = '';
        this.uploadedFiles = [];
    }
}

// Ï†ÑÏó≠ ÌååÏùº ÏÇ≠Ï†ú Ìï®Ïàò
window.deleteUploadedFile = function(fileId, buttonElement) {
    if (!confirm('Ïù¥ ÌååÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file_id', fileId);
    
    fetch('../../includes/delete_file_handler.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÌååÏùº ÏïÑÏù¥ÌÖú Ï†úÍ±∞
            const fileItem = buttonElement.closest('.file-item');
            fileItem.remove();
            
            alert('ÌååÏùºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        } else {
            alert('ÌååÏùº ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ÌååÏùº ÏÇ≠Ï†ú Ïò§Î•ò:', error);
        alert('ÌååÏùº ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    });
};