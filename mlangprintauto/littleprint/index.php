<?php
/**
 * Ìè¨Ïä§ÌÑ∞/Î¶¨ÌîåÎ†õ Í≤¨Ï†ÅÏïàÎÇ¥ Ïª¥Ìå©Ìä∏ ÏãúÏä§ÌÖú - PROJECT_SUCCESS_REPORT.md Ïä§Ìéô Íµ¨ÌòÑ  
 * Features: Ï†ÅÏùëÌòï Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù, Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖò, Ïã§ÏãúÍ∞Ñ Í∞ÄÍ≤© Í≥ÑÏÇ∞
 * Created: 2025ÎÖÑ 8Ïõî (AI Assistant - Frontend Persona)
 */

// Î≥¥Ïïà ÏÉÅÏàò Ï†ïÏùò ÌõÑ Í≥µÌÜµ Ïù∏Ï¶ù Î∞è ÏÑ§Ï†ï
include "../../includes/auth.php";

// Í≥µÌÜµ Ìï®Ïàò Î∞è Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§
include "../../includes/functions.php";
include "../../db.php";

// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Î∞è ÏÑ§Ï†ï
check_db_connection($db);
mysqli_set_charset($db, "utf8");

// Î°úÍ∑∏ Ï†ïÎ≥¥ Î∞è ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï
$log_info = generateLogInfo();
$page_title = generate_page_title("Ìè¨Ïä§ÌÑ∞/Î¶¨ÌîåÎ†õ Í≤¨Ï†ÅÏïàÎÇ¥ Ïª¥Ìå©Ìä∏ - ÌîÑÎ¶¨ÎØ∏ÏóÑ");

// Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú ÏôÑÏ†ÑÌûà ÎèôÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞)
$default_values = [
    'MY_type' => '',
    'Section' => '',
    'PN_type' => '',
    'POtype' => '',
    'MY_amount' => '',
    'ordertype' => ''
];

// mlangprintauto_transactioncateÏóêÏÑú Ï≤´ Î≤àÏß∏ Ìè¨Ïä§ÌÑ∞ Ï¢ÖÎ•ò Í∞ÄÏ†∏Ïò§Í∏∞
$type_query = "SELECT no, title FROM mlangprintauto_transactioncate 
               WHERE Ttable='LittlePrint' AND BigNo='0' 
               ORDER BY no ASC 
               LIMIT 1";
$type_result = mysqli_query($db, $type_query);

if ($type_result && ($type_row = mysqli_fetch_assoc($type_result))) {
    $default_values['MY_type'] = $type_row['no'];
    
    // mlangprintauto_littleprintÏóêÏÑú Ìï¥Îãπ Ïä§ÌÉÄÏùºÏùò Ï≤´ Î≤àÏß∏ Ïû¨Ïßà Í∞ÄÏ†∏Ïò§Í∏∞
    $material_query = "SELECT DISTINCT TreeSelect FROM mlangprintauto_littleprint 
                       WHERE style='" . mysqli_real_escape_string($db, $type_row['no']) . "' 
                       AND TreeSelect IS NOT NULL 
                       ORDER BY TreeSelect ASC LIMIT 1";
    $material_result = mysqli_query($db, $material_query);
    
    if ($material_result && ($material_row = mysqli_fetch_assoc($material_result))) {
        $default_values['Section'] = $material_row['TreeSelect'];
        
        // Ìï¥Îãπ Ïû¨ÏßàÏùò Ï≤´ Î≤àÏß∏ Í∑úÍ≤© Í∞ÄÏ†∏Ïò§Í∏∞
        $size_query = "SELECT DISTINCT Section FROM mlangprintauto_littleprint 
                       WHERE TreeSelect='" . mysqli_real_escape_string($db, $material_row['TreeSelect']) . "' 
                       AND Section IS NOT NULL 
                       ORDER BY Section ASC LIMIT 1";
        $size_result = mysqli_query($db, $size_query);
        
        if ($size_result && ($size_row = mysqli_fetch_assoc($size_result))) {
            $default_values['PN_type'] = $size_row['Section'];
            
            // Ï≤´ Î≤àÏß∏ Ïù∏ÏáÑÎ©¥ Í∞ÄÏ†∏Ïò§Í∏∞
            $potype_query = "SELECT DISTINCT POtype FROM mlangprintauto_littleprint 
                            WHERE TreeSelect='" . mysqli_real_escape_string($db, $material_row['TreeSelect']) . "' 
                            AND Section='" . mysqli_real_escape_string($db, $size_row['Section']) . "'
                            ORDER BY POtype ASC LIMIT 1";
            $potype_result = mysqli_query($db, $potype_query);
            
            if ($potype_result && ($potype_row = mysqli_fetch_assoc($potype_result))) {
                $default_values['POtype'] = $potype_row['POtype'];
                
                // Ï≤´ Î≤àÏß∏ ÏàòÎüâ Í∞ÄÏ†∏Ïò§Í∏∞
                $quantity_query = "SELECT DISTINCT quantity FROM mlangprintauto_littleprint 
                                  WHERE style='" . mysqli_real_escape_string($db, $type_row['no']) . "' 
                                  AND TreeSelect='" . mysqli_real_escape_string($db, $material_row['TreeSelect']) . "'
                                  AND Section='" . mysqli_real_escape_string($db, $size_row['Section']) . "'
                                  AND POtype='" . mysqli_real_escape_string($db, $potype_row['POtype']) . "'
                                  ORDER BY CAST(quantity AS UNSIGNED) ASC LIMIT 1";
                $quantity_result = mysqli_query($db, $quantity_query);
                
                if ($quantity_result && ($quantity_row = mysqli_fetch_assoc($quantity_result))) {
                    $default_values['MY_amount'] = $quantity_row['quantity'];
                }
            }
        }
    }
}

// ordertype Í∏∞Î≥∏Í∞í (ÎîîÏûêÏù∏Îßå ÌïòÎìúÏΩîÎî©)
$default_values['ordertype'] = 'print'; // Ïù∏ÏáÑÎßå
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- üé® ÌÜµÌï© Ïª¨Îü¨ ÏãúÏä§ÌÖú -->
    <link rel="stylesheet" href="../../css/color-system-unified.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo safe_html($page_title); ?></title>
    
    
    
    
    <!-- Ìè¨Ïä§ÌÑ∞ Ïª¥Ìå©Ìä∏ ÌéòÏù¥ÏßÄ Ï†ÑÏö© CSS -->
    <link rel="stylesheet" href="../../css/product-layout.css">
    <!-- Í≥µÌÜµ Î≤ÑÌäº Ïä§ÌÉÄÏùº CSS -->
    <link rel="stylesheet" href="../../css/btn-primary.css">
    <!-- Ïª¥Ìå©Ìä∏ Ìèº Í∑∏Î¶¨Îìú CSS (Î™®Îì† ÌíàÎ™© Í≥µÌÜµ) -->
    <link rel="stylesheet" href="../../css/compact-form.css">
    <!-- ÌÜµÌï© Í∞§Îü¨Î¶¨ CSS -->
    <link rel="stylesheet" href="../../css/unified-gallery.css">
    <!-- ÌÜµÌï© Í∞ÄÍ≤© ÌëúÏãú ÏãúÏä§ÌÖú -->
    <link rel="stylesheet" href="../../css/unified-price-display.css">
    <!-- ÌÜµÌï© Ïù∏ÎùºÏù∏ Ìèº Ïä§ÌÉÄÏùº ÏãúÏä§ÌÖú -->
    <link rel="stylesheet" href="../../css/unified-inline-form.css">
    <!-- Ï∂îÍ∞Ä ÏòµÏÖò ÏãúÏä§ÌÖú CSS -->
    <link rel="stylesheet" href="../../css/additional-options.css">

    <!-- Í≥µÌÜµ Í∞ÄÍ≤© ÌëúÏãú ÏãúÏä§ÌÖú -->
    <script src="../../js/common-price-display.js" defer></script>
    <!-- Í≥µÌÜµ Í∞§Îü¨Î¶¨ ÏãúÏä§ÌÖú (helperÍ∞Ä ÏûêÎèôÏúºÎ°ú ÌïÑÏöîÌïú ÏóêÏÖã Î°úÎìú) -->
    <script src="../../js/poster.js?v=1759244654" defer></script>
    
    <!-- ÏÑ∏ÏÖò ID Î∞è ÏÑ§Ï†ïÍ∞í Î©îÌÉÄ ÌÉúÍ∑∏ -->
    <meta name="session-id" content="<?php echo htmlspecialchars(session_id()); ?>">
    <meta name="default-section" content="<?php echo htmlspecialchars($default_values['Section']); ?>">
    <meta name="default-quantity" content="<?php echo htmlspecialchars($default_values['MY_amount']); ?>">
    <!-- Í≥µÌÜµ Í∞§Îü¨Î¶¨ ÌåùÏóÖ Ìï®Ïàò -->
    <script src="../../js/common-gallery-popup.js"></script>

    <!-- Ïù∏ÎùºÏù∏ CSS Ï∂îÏ∂ú ÌååÏùº -->
    <link rel="stylesheet" href="css/littleprint-inline-extracted.css">
    <!-- üéØ ÌÜµÌï© Í≥µÌÜµ Ïä§ÌÉÄÏùº CSS (ÏµúÏ¢Ö Î°úÎìúÎ°ú ÏµúÏö∞ÏÑ† Ï†ÅÏö©) -->
    <link rel="stylesheet" href="../../css/common-styles.css?v=1759615861">
    <link rel="stylesheet" href="../../css/upload-modal-common.css">
</head>
<body class="littleprint-page">
    <?php include "../../includes/header-ui.php"; ?>
    <?php include "../../includes/nav.php"; ?>

    <div class="product-container">
        <div class="page-title">
            <h1>üìÑ Ìè¨Ïä§ÌÑ∞ Í≤¨Ï†Å ÏïàÎÇ¥</h1>
        </div>

        <!-- Ïª¥Ìå©Ìä∏ 2Îã® Í∑∏Î¶¨Îìú Î†àÏù¥ÏïÑÏõÉ (500px Í∞§Îü¨Î¶¨ + ÎÇòÎ®∏ÏßÄ Í≥ÑÏÇ∞Í∏∞) -->
        <div class="product-content">
            <!-- Ï¢åÏ∏°: Ìè¨Ïä§ÌÑ∞ Í∞§Îü¨Î¶¨ (Í≥µÌÜµ ÏãúÏä§ÌÖú) -->
            <div class="product-gallery">
                
                <?php 
                // Í≥µÌÜµ Í∞§Îü¨Î¶¨ ÏãúÏä§ÌÖú ÏÇ¨Ïö© (500√ó300px Í∏∞Î≥∏Í∞í)
                if (file_exists('../../includes/gallery_helper.php')) { if (file_exists('../../includes/gallery_helper.php')) { include_once '../../includes/gallery_helper.php'; } }
                if (function_exists("include_product_gallery")) { include_product_gallery('littleprint'); }
                ?>
            </div>

            <!-- Ïö∞Ï∏°: Ïã§ÏãúÍ∞Ñ Í∞ÄÍ≤© Í≥ÑÏÇ∞Í∏∞ (ÎèôÏ†Å ÏòµÏÖò Î°úÎî© Î∞è ÏûêÎèô Í≥ÑÏÇ∞) -->
            <div class="product-calculator">
                <div class="calculator-header">
                    <h3>üí∞ Ïã§ÏãúÍ∞Ñ Í≤¨Ï†Å Í≥ÑÏÇ∞Í∏∞</h3>
                </div>

                <form id="posterForm">
                    <!-- ÌÜµÏùº Ïù∏ÎùºÏù∏ Ìèº ÏãúÏä§ÌÖú - Î¶¨ÌãÄÌîÑÎ¶∞Ìä∏ ÌéòÏù¥ÏßÄ -->
                    <div class="inline-form-container">
                        <div class="inline-form-row">
                            <label class="inline-label" for="MY_type">Ï¢ÖÎ•ò</label>
                            <select class="inline-select" name="MY_type" id="MY_type" required onchange="calculatePrice()">
                                <option value="">ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                                <?php
                                // mlangprintauto_transactioncateÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ìè¨Ïä§ÌÑ∞ Ï¢ÖÎ•ò Í∞ÄÏ†∏Ïò§Í∏∞
                                $category_query = "SELECT no, title FROM mlangprintauto_transactioncate
                                                  WHERE Ttable='LittlePrint' AND BigNo='0'
                                                  ORDER BY no ASC";
                                $category_result = mysqli_query($db, $category_query);
                                if ($category_result) {
                                    while ($category = mysqli_fetch_assoc($category_result)) {
                                        $selected = ($category['no'] == $default_values['MY_type']) ? 'selected' : '';
                                        echo "<option value='" . safe_html($category['no']) . "' $selected>" . safe_html($category['title']) . "</option>";
                                    }
                                }
                                ?>
                            </select>
                            <span class="inline-note">Ìè¨Ïä§ÌÑ∞ Ï¢ÖÎ•òÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
                        </div>

                        <div class="inline-form-row">
                            <label class="inline-label" for="Section">ÏßÄÎ•ò</label>
                            <select class="inline-select" name="Section" id="Section" required data-default-value="<?php echo htmlspecialchars($default_values['Section']); ?>" onchange="calculatePrice()">
                                <option value="">Î®ºÏ†Ä Ï¢ÖÎ•òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                            </select>
                            <span class="inline-note">ÏõêÌïòÎäî Ïö©ÏßÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
                        </div>

                        <div class="inline-form-row">
                            <label class="inline-label" for="PN_type">Í∑úÍ≤©</label>
                            <select class="inline-select" name="PN_type" id="PN_type" required onchange="calculatePrice()">
                                <option value="">Î®ºÏ†Ä ÏßÄÎ•òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                            </select>
                            <span class="inline-note">Ïù∏ÏáÑ ÏÇ¨Ïù¥Ï¶àÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
                        </div>

                        <div class="inline-form-row">
                            <label class="inline-label" for="POtype">Ïù∏ÏáÑÎ©¥</label>
                            <select class="inline-select" name="POtype" id="POtype" required onchange="calculatePrice()">
                                <option value="">ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                                <?php
                                // mlangprintauto_littleprintÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïù∏ÏáÑÎ©¥ ÏòµÏÖò Í∞ÄÏ†∏Ïò§Í∏∞
                                $potype_query = "SELECT DISTINCT POtype FROM mlangprintauto_littleprint
                                               WHERE POtype IS NOT NULL
                                               ORDER BY POtype ASC";
                                $potype_result = mysqli_query($db, $potype_query);
                                if ($potype_result) {
                                    while ($potype = mysqli_fetch_assoc($potype_result)) {
                                        $selected = ($potype['POtype'] == $default_values['POtype']) ? 'selected' : '';
                                        $potype_text = ($potype['POtype'] == '1') ? 'Îã®Î©¥' : 'ÏñëÎ©¥';
                                        echo "<option value='" . safe_html($potype['POtype']) . "' $selected>" . safe_html($potype_text) . "</option>";
                                    }
                                }
                                ?>
                            </select>
                            <span class="inline-note">Îã®Î©¥ ÎòêÎäî ÏñëÎ©¥ Ïù∏ÏáÑ</span>
                        </div>

                        <div class="inline-form-row">
                            <label class="inline-label" for="MY_amount">ÏàòÎüâ</label>
                            <select class="inline-select" name="MY_amount" id="MY_amount" required data-default-value="<?php echo htmlspecialchars($default_values['MY_amount']); ?>" onchange="calculatePrice()">
                                <option value="">Î®ºÏ†Ä Í∑úÍ≤©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                            </select>
                            <span class="inline-note">ÏõêÌïòÏãúÎäî ÏàòÎüâÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
                        </div>

                        <div class="inline-form-row">
                            <label class="inline-label" for="ordertype">Ìé∏ÏßëÎπÑ</label>
                            <select class="inline-select" name="ordertype" id="ordertype" required onchange="calculatePrice()">
                                <option value="">ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                                <?php
                                // Ìé∏ÏßëÎîîÏûêÏù∏ ÏòµÏÖò (Ïù¥ Î∂ÄÎ∂ÑÏùÄ ÎπÑÏ¶àÎãàÏä§ Î°úÏßÅÏù¥ÎØÄÎ°ú Í∞ÑÎã®Ìïú Î∞∞Ïó¥ ÏÇ¨Ïö©)
                                $ordertype_options = [
                                    ['value' => 'print', 'text' => 'Ïù∏ÏáÑÎßå ÏùòÎ¢∞'],
                                    ['value' => 'total', 'text' => 'ÎîîÏûêÏù∏+Ïù∏ÏáÑ']
                                ];
                                foreach ($ordertype_options as $option) {
                                    $selected = ($option['value'] == $default_values['ordertype']) ? 'selected' : '';
                                    echo "<option value='" . safe_html($option['value']) . "' $selected>" . safe_html($option['text']) . "</option>";
                                }
                                ?>
                            </select>
                            <span class="inline-note">ÎîîÏûêÏù∏ ÏûëÏóÖ Ìè¨Ìï® Ïó¨Î∂Ä</span>
                        </div>
                    </div>

                    <!-- Ï∂îÍ∞Ä ÏòµÏÖò ÏÑπÏÖò (Ï†ÑÎã®ÏßÄ Ïä§ÌÉÄÏùº) -->
                    <div class="leaflet-premium-options-section" id="premiumOptionsSection" style="margin-top: 15px;">
                        <!-- Ìïú Ï§Ñ Ï≤¥ÌÅ¨Î∞ïÏä§ Ìó§Îçî -->
                        <div class="option-headers-row">
                            <div class="option-checkbox-group">
                                <input type="checkbox" id="coating_enabled" name="coating_enabled" class="option-toggle" value="1">
                                <label for="coating_enabled" class="toggle-label">ÏΩîÌåÖ</label>
                            </div>
                            <div class="option-checkbox-group">
                                <input type="checkbox" id="folding_enabled" name="folding_enabled" class="option-toggle" value="1">
                                <label for="folding_enabled" class="toggle-label">Ï†ëÏßÄ</label>
                            </div>
                            <div class="option-checkbox-group">
                                <input type="checkbox" id="creasing_enabled" name="creasing_enabled" class="option-toggle" value="1">
                                <label for="creasing_enabled" class="toggle-label">Ïò§Ïãú</label>
                            </div>
                            <div class="option-price-display">
                                <span class="option-price-total" id="premiumPriceTotal">(+0Ïõê)</span>
                            </div>
                        </div>

                        <!-- ÏΩîÌåÖ ÏòµÏÖò ÏÉÅÏÑ∏ -->
                        <div class="option-details" id="coating_options" style="display: none;">
                            <select name="coating_type" id="coating_type" class="option-select">
                                <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                <option value="single">Îã®Î©¥Ïú†Í¥ëÏΩîÌåÖ</option>
                                <option value="double">ÏñëÎ©¥Ïú†Í¥ëÏΩîÌåÖ</option>
                                <option value="single_matte">Îã®Î©¥Î¨¥Í¥ëÏΩîÌåÖ</option>
                                <option value="double_matte">ÏñëÎ©¥Î¨¥Í¥ëÏΩîÌåÖ</option>
                            </select>
                        </div>

                        <!-- Ï†ëÏßÄ ÏòµÏÖò ÏÉÅÏÑ∏ -->
                        <div class="option-details" id="folding_options" style="display: none;">
                            <select name="folding_type" id="folding_type" class="option-select">
                                <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                <option value="2fold">2Îã®Ï†ëÏßÄ</option>
                                <option value="3fold">3Îã®Ï†ëÏßÄ</option>
                                <option value="accordion">Î≥ëÌíçÏ†ëÏßÄ</option>
                                <option value="gate">ÎåÄÎ¨∏Ï†ëÏßÄ</option>
                            </select>
                        </div>

                        <!-- Ïò§Ïãú ÏòµÏÖò ÏÉÅÏÑ∏ -->
                        <div class="option-details" id="creasing_options" style="display: none;">
                            <select name="creasing_lines" id="creasing_lines" class="option-select">
                                <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                <option value="1">1Ï§Ñ</option>
                                <option value="2">2Ï§Ñ</option>
                                <option value="3">3Ï§Ñ</option>
                            </select>
                        </div>

                        <!-- Ïà®Í≤®ÏßÑ ÌïÑÎìúÎì§ -->
                        <input type="hidden" name="coating_price" id="coating_price" value="0">
                        <input type="hidden" name="folding_price" id="folding_price" value="0">
                        <input type="hidden" name="creasing_price" id="creasing_price" value="0">
                        <input type="hidden" name="additional_options_total" id="additional_options_total" value="0">
                    </div>

                    <!-- ÌÜµÏùºÎêú Í∞ÄÍ≤© ÌëúÏãú ÏãúÏä§ÌÖú -->
                    <div class="price-display" id="priceDisplay">
                        <div class="price-amount" id="priceAmount">Í≤¨Ï†Å Í≥ÑÏÇ∞ ÌïÑÏöî</div>
                        <div class="price-details" id="priceDetails">
                            Î™®Îì† ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Í≥ÑÏÇ∞Îê©ÎãàÎã§
                        </div>
                    </div>

                    <!-- ÌååÏùº ÏóÖÎ°úÎìú Î∞è Ï£ºÎ¨∏ Î≤ÑÌäº -->
                    <div class="upload-order-button" id="uploadOrderButton">
                        <button type="button" class="btn-upload-order" onclick="openUploadModal()">
                            ÌååÏùº ÏóÖÎ°úÎìú Î∞è Ï£ºÎ¨∏ÌïòÍ∏∞
                        </button>
                    </div>

                    <!-- Ïà®Í≤®ÏßÑ ÌïÑÎìúÎì§ -->
                    <input type="hidden" name="log_url" value="<?php echo safe_html($log_info['url']); ?>">
                    <input type="hidden" name="log_y" value="<?php echo safe_html($log_info['y']); ?>">
                    <input type="hidden" name="log_md" value="<?php echo safe_html($log_info['md']); ?>">
                    <input type="hidden" name="log_ip" value="<?php echo safe_html($log_info['ip']); ?>">
                    <input type="hidden" name="log_time" value="<?php echo safe_html($log_info['time']); ?>">
                    <input type="hidden" name="page" value="LittlePrint">
                </form>
            </div>
        </div>
    </div>

    <!-- ÌååÏùº ÏóÖÎ°úÎìú Î™®Îã¨ (ÌÜµÌï© Ïª¥Ìè¨ÎÑåÌä∏) -->
    <?php include "../../includes/upload_modal.php"; ?>
    <script src="../../includes/upload_modal.js?v=1759244661"></script>

    <?php include "../../includes/login_modal.php"; ?>

    <!-- Ìè¨Ïä§ÌÑ∞ ÏÉÅÏÑ∏ ÏÑ§Î™Ö ÏÑπÏÖò (1200px Ìè≠) - ÌïòÎã® ÏÑ§Î™ÖÎ∞©Î≤ï Ï†ÅÏö© -->
    <div class="poster-detail-combined" style="width: 1200px; max-width: 100%; margin: 7.5px auto; padding: 25px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e0e0e0;">
        <?php include "explane_poster.php"; ?>
    </div>

    <?php include "../../includes/footer.php"; ?>

    <script>
        // PHP Î≥ÄÏàòÎ•º JavaScriptÎ°ú Ï†ÑÎã¨ (PROJECT_SUCCESS_REPORT.md Ïä§Ìéô)
        window.phpVars = {
            MultyUploadDir: "../../PHPClass/MultyUpload",
            log_url: "<?php echo safe_html($log_info['url']); ?>",
            log_y: "<?php echo safe_html($log_info['y']); ?>",
            log_md: "<?php echo safe_html($log_info['md']); ?>",
            log_ip: "<?php echo safe_html($log_info['ip']); ?>",
            log_time: "<?php echo safe_html($log_info['time']); ?>",
            page: "LittlePrint",
            defaultValues: {
                MY_type: "<?php echo safe_html($default_values['MY_type']); ?>",
                Section: "<?php echo safe_html($default_values['Section']); ?>",
                POtype: "<?php echo safe_html($default_values['POtype']); ?>",
                MY_amount: "<?php echo safe_html($default_values['MY_amount']); ?>",
                ordertype: "<?php echo safe_html($default_values['ordertype']); ?>"
            }
        };
        // Ìè¨Ïä§ÌÑ∞(Î¶¨ÌãÄÌîÑÎ¶∞Ìä∏) Ï†ÑÏö© Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä Ìï®Ïàò (ÌÜµÌï© Î™®Îã¨ Ìå®ÌÑ¥)
        window.handleModalBasketAdd = function(uploadedFiles, onSuccess, onError) {
            console.log("Ìè¨Ïä§ÌÑ∞ Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä ÏãúÏûë");

            if (!window.currentPriceData) {
                console.error("Í∞ÄÍ≤© Í≥ÑÏÇ∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§");
                if (onError) onError("Î®ºÏ†Ä Í∞ÄÍ≤©ÏùÑ Í≥ÑÏÇ∞Ìï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }

            const formData = new FormData();
            formData.append("action", "add_to_basket");
            formData.append("product_type", "littleprint");
            formData.append("MY_type", document.getElementById("MY_type").value);
            formData.append("Section", document.getElementById("Section").value);
            formData.append("POtype", document.getElementById("POtype").value);
            formData.append("MY_amount", document.getElementById("MY_amount").value);
            formData.append("ordertype", document.getElementById("ordertype").value);
            formData.append("calculated_price", Math.round(window.currentPriceData.total_price));
            formData.append("calculated_vat_price", Math.round(window.currentPriceData.vat_price));

            const workMemo = document.getElementById("modalWorkMemo");
            if (workMemo) formData.append("work_memo", workMemo.value);

            formData.append("upload_method", window.selectedUploadMethod || "upload");

            if (uploadedFiles && uploadedFiles.length > 0) {
                uploadedFiles.forEach((file, index) => {
                    formData.append("uploaded_files[" + index + "]", file);
                });
            }

            fetch("add_to_basket.php", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (onSuccess) onSuccess(data);
                } else {
                    if (onError) onError(data.message);
                }
            })
            .catch(error => {
                console.error("Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä Ïò§Î•ò:", error);
                if (onError) onError("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            });
        };

        // poster.jsÏóêÏÑú Ï†ÑÏó≠ Î≥ÄÏàòÏôÄ Ï¥àÍ∏∞Ìôî Ìï®ÏàòÎì§ÏùÑ Ï≤òÎ¶¨ (Í∞§Îü¨Î¶¨Îäî Í≥µÌÜµ ÏãúÏä§ÌÖú ÏÇ¨Ïö©)
    </script>

    <!-- Ìè¨Ïä§ÌÑ∞ Ï∂îÍ∞Ä ÏòµÏÖò ÏãúÏä§ÌÖú -->
    <script src="js/littleprint-premium-options.js"></script>

    <!-- Ìè¨Ïä§ÌÑ∞/Î¶¨ÌîåÎ†õ Ï†ÑÏö© Ïª¥Ìå©Ìä∏ ÎîîÏûêÏù∏ Ï†ÅÏö© (Frontend-Compact-Design-Guide.md Í∏∞Î∞ò) -->


    <?php
    // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ï¢ÖÎ£å
    if ($db) {
        mysqli_close($db);
    }
    ?>
</body>
</html>