# ê²¬ì ì„œ ì‹œìŠ¤í…œ ì™„ì „ ê°€ì´ë“œ

**ë²„ì „**: 1.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-12-01
**ëª©ì **: ê²¬ì ì„œ ì‹œìŠ¤í…œ ë³µêµ¬ ë° ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•œ ì™„ì „í•œ ì°¸ì¡° ë¬¸ì„œ

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
/var/www/html/mlangprintauto/quote/
â”œâ”€â”€ index.php                    # ê²¬ì ì„œ ëª©ë¡ (ê´€ë¦¬ì)
â”œâ”€â”€ create.php                   # ìƒˆ ê²¬ì ì„œ ì‘ì„±
â”œâ”€â”€ detail.php                   # ê²¬ì ì„œ ìƒì„¸ ë³´ê¸°
â”œâ”€â”€ edit.php                     # ê²¬ì ì„œ ìˆ˜ì • (draftë§Œ)
â”œâ”€â”€ revise.php                   # ê°œì •íŒ ì‘ì„± (sentë§Œ)
â”‚
â”œâ”€â”€ includes/
â”‚   â”œâ”€â”€ QuoteManager.php         # â­ í•µì‹¬ í´ë˜ìŠ¤ (CRUD ì „ì²´)
â”‚   â”œâ”€â”€ ProductSpecFormatter.php # í’ˆëª© ê·œê²© í¬ë§·íŒ…
â”‚   â”œâ”€â”€ calculator_modal.js      # ê³„ì‚°ê¸° ëª¨ë‹¬ JavaScript
â”‚   â””â”€â”€ calculator_modal.css     # ê³„ì‚°ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼
â”‚
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ save.php                 # ê²¬ì ì„œ ì €ì¥ API
â”‚   â”œâ”€â”€ update.php               # ê²¬ì ì„œ ìˆ˜ì • API
â”‚   â”œâ”€â”€ create_revision.php      # ê°œì •íŒ ìƒì„± API
â”‚   â”œâ”€â”€ delete.php               # ê²¬ì ì„œ ì‚­ì œ API
â”‚   â”œâ”€â”€ send_email.php           # ì´ë©”ì¼ ë°œì†¡ API
â”‚   â”œâ”€â”€ generate_pdf.php         # PDF ìƒì„± API
â”‚   â””â”€â”€ update_status.php        # ìƒíƒœ ì—…ë°ì´íŠ¸ API
â”‚
â””â”€â”€ public/
    â””â”€â”€ view.php                 # ê³ ê° ê³µê°œ ë§í¬ í˜ì´ì§€
```

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”

### quotes (ê²¬ì ì„œ ë©”ì¸)

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | int | ê¸°ë³¸í‚¤, ìë™ì¦ê°€ |
| `quote_no` | varchar(50) | ê²¬ì ë²ˆí˜¸ (Q-YYYYMMDD-NNN, ê°œì •íŒì€ -v2, -v3 ì¶”ê°€) |
| `quote_type` | enum | quotation(ê²¬ì ì„œ), transaction(ê±°ë˜ëª…ì„¸í‘œ), tax_invoice(ì„¸ê¸ˆê³„ì‚°ì„œ) |
| `public_token` | varchar(64) | ê³ ê° ê³µê°œ ë§í¬ìš© í† í° |
| `original_quote_id` | int | ì›ë³¸ ê²¬ì ì„œ ID (ê°œì •íŒì¸ ê²½ìš°) |
| `version` | int | ë²„ì „ ë²ˆí˜¸ (ê¸°ë³¸ 1) |
| `is_latest` | tinyint | ìµœì‹  ë²„ì „ ì—¬ë¶€ (1/0) |
| `customer_name` | varchar(100) | ê³ ê°ëª… âš ï¸ í•„ìˆ˜ |
| `customer_company` | varchar(100) | íšŒì‚¬ëª… |
| `customer_phone` | varchar(30) | ì „í™”ë²ˆí˜¸ |
| `customer_email` | varchar(100) | ê³ ê° ì´ë©”ì¼ âš ï¸ í•„ìˆ˜ |
| `recipient_email` | varchar(100) | ìˆ˜ì‹  ì´ë©”ì¼ (ë‹¤ë¥¼ ê²½ìš°) |
| `delivery_type` | varchar(30) | ë°°ì†¡ë°©ì‹ (íƒë°°, í€µì„œë¹„ìŠ¤, ì§ì ‘ìˆ˜ë ¹, ë¬´ë£Œë°°ì†¡) |
| `delivery_address` | text | ë°°ì†¡ì§€ ì£¼ì†Œ |
| `delivery_price` | int | ë°°ì†¡ë¹„ (ê³µê¸‰ê°€) |
| `supply_total` | int | ê³µê¸‰ê°€ì•¡ í•©ê³„ |
| `vat_total` | int | ë¶€ê°€ì„¸ í•©ê³„ |
| `discount_amount` | int | í• ì¸ê¸ˆì•¡ |
| `discount_reason` | varchar(255) | í• ì¸ì‚¬ìœ  |
| `grand_total` | int | ì´í•©ê³„ (ê³µê¸‰ê°€ + ë¶€ê°€ì„¸ - í• ì¸ + ë°°ì†¡ë¹„) |
| `payment_terms` | varchar(100) | ê²°ì œì¡°ê±´ (ê¸°ë³¸: ë°œí–‰ì¼ë¡œë¶€í„° 7ì¼) |
| `valid_days` | int | ìœ íš¨ê¸°ê°„ ì¼ìˆ˜ |
| `valid_until` | date | ìœ íš¨ê¸°ê°„ ë§Œë£Œì¼ |
| `status` | enum | draft, sent, viewed, accepted, rejected, expired, converted |
| `notes` | text | ë¹„ê³  |
| `pdf_path` | varchar(255) | ìƒì„±ëœ PDF ê²½ë¡œ |
| `created_at` | timestamp | ìƒì„±ì¼ì‹œ |

### quote_items (ê²¬ì  í’ˆëª©)

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | int | ê¸°ë³¸í‚¤, ìë™ì¦ê°€ |
| `quote_id` | int | ê²¬ì ì„œ ID (FK) |
| `item_no` | int | í’ˆëª© ìˆœë²ˆ |
| `product_type` | varchar(50) | ì œí’ˆ íƒ€ì… (inserted, namecard, envelope ë“±) |
| `product_name` | varchar(200) | í’ˆëª… âš ï¸ í•„ìˆ˜ |
| `specification` | text | ê·œê²© ë° ì‚¬ì–‘ |
| `quantity` | decimal(10,2) | ìˆ˜ëŸ‰ âš ï¸ ì „ë‹¨ì§€ëŠ” "ì—°" ë‹¨ìœ„ (0.5, 1, 2 ë“±) |
| `unit` | varchar(10) | ë‹¨ìœ„ (ì—°, ë§¤, ë¶€, ê°œ) |
| `unit_price` | decimal(10,1) | ë‹¨ê°€ âš ï¸ ì „ë‹¨ì§€ëŠ” ì†Œìˆ˜ì  1ìë¦¬ |
| `supply_price` | int | ê³µê¸‰ê°€ì•¡ (VAT ë³„ë„) |
| `vat_amount` | int | ë¶€ê°€ì„¸ |
| `total_price` | int | í•©ê³„ (ê³µê¸‰ê°€ + ë¶€ê°€ì„¸) |
| `source_type` | enum | cart, manual, custom |
| `source_id` | int | ì›ë³¸ ì¥ë°”êµ¬ë‹ˆ ID |
| `source_data` | text | JSON í˜•ì‹ ì›ë³¸ ë°ì´í„° âš ï¸ ì „ë‹¨ì§€ mesu í¬í•¨ |
| `notes` | text | ë¹„ê³  |

---

## â­ í•µì‹¬ í´ë˜ìŠ¤: QuoteManager.php

### ì£¼ìš” í•¨ìˆ˜

#### 1. ê²¬ì ì„œ ìƒì„±

```php
// ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒì„±
$manager = new QuoteManager($db);
$result = $manager->createFromCart($sessionId, $data);

// ë¹ˆ ê²¬ì ì„œ ìƒì„± (ìˆ˜ë™ ì…ë ¥)
$result = $manager->createEmpty($data);

// ê°œì •íŒ ìƒì„± (sent ìƒíƒœë§Œ)
$result = $manager->createRevision($originalQuoteId, $data);
```

#### 2. ê²¬ì ì„œ ì¡°íšŒ

```php
// IDë¡œ ì¡°íšŒ
$quote = $manager->getQuoteById($id);

// ê³µê°œ í† í°ìœ¼ë¡œ ì¡°íšŒ
$quote = $manager->getByToken($token);

// í’ˆëª© ì¡°íšŒ
$items = $manager->getQuoteItems($quoteId);

// ëª©ë¡ ì¡°íšŒ (í˜ì´ì§•)
$list = $manager->getList($filters, $page, $perPage);
```

#### 3. ê²¬ì ì„œ ìˆ˜ì •

```php
// ê²¬ì ì„œ ì—…ë°ì´íŠ¸ (draftë§Œ)
$result = $manager->updateQuote($data);

// ìƒíƒœ ì—…ë°ì´íŠ¸
$manager->updateStatus($id, 'sent');
```

### âš ï¸ í•µì‹¬ ì£¼ì˜ì‚¬í•­: addManualItem()

**ìœ„ì¹˜**: QuoteManager.php 515ë²ˆ ë¼ì¸ ~

```php
private function addManualItem($quoteId, $itemNo, $item) {
    // 1. __direct__ ì²˜ë¦¬ (ì§ì ‘ì…ë ¥ ì„ íƒ ì‹œ)
    $productName = trim($item['product_name'] ?? '');
    if ($productName === '__direct__' || empty($productName)) {
        $productName = trim($item['product_name_custom'] ?? '');
    }

    // 2. ê³µê¸‰ê°€ ì²˜ë¦¬ âš ï¸ ë§¤ìš° ì¤‘ìš”!
    // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ supply_priceê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    if (isset($item['supply_price']) && $item['supply_price'] !== '' && $item['supply_price'] !== null) {
        $supplyPrice = intval($item['supply_price']);
    } else {
        // ì—†ìœ¼ë©´ ê³„ì‚° (ìˆ˜ëŸ‰ Ã— ë‹¨ê°€)
        $supplyPrice = intval($quantity * $unitPrice);
    }

    // 3. mysqli_stmt_bind_param íƒ€ì… ë¬¸ìì—´
    // "iisssdsiiiiss" = 13ê°œ íŒŒë¼ë¯¸í„°
    // i: quote_id, item_no
    // s: product_type, product_name, specification
    // d: quantity (decimal)
    // s: unit
    // i: unit_price, supply_price, vat_amount, total_price
    // s: source_type, notes
}
```

---

## ğŸ“Š í’ˆëª©ë³„ ì²˜ë¦¬ ì›ë¦¬

### ì „ë‹¨ì§€ (inserted) - íŠ¹ìˆ˜ ì²˜ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì „ë‹¨ì§€ëŠ” "ì—°" ë‹¨ìœ„ì™€ "ë§¤ìˆ˜(mesu)"ë¥¼ ë³„ë„ ê´€ë¦¬                     â”‚
â”‚                                                                 â”‚
â”‚  ì˜ˆì‹œ: 0.5ì—° (5,000ë§¤) â†’ ê³µê¸‰ê°€: 53,300ì›                        â”‚
â”‚                                                                 â”‚
â”‚  ë‹¨ê°€ ê³„ì‚°: ê³µê¸‰ê°€ Ã· ë§¤ìˆ˜ = 53,300 Ã· 5,000 = 10.66ì›/ë§¤          â”‚
â”‚            (ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ í‘œì‹œ)                                â”‚
â”‚                                                                 â”‚
â”‚  í™”ë©´ í‘œì‹œ: ìˆ˜ëŸ‰ ì…€ì— "0.5" + ë‹¨ìœ„ ì…€ ì•„ë˜ "(5,000ë§¤)" í‘œì‹œ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì½”ë“œ ìœ„ì¹˜**:
- `QuoteManager.php:426-430` - ì¥ë°”êµ¬ë‹ˆì—ì„œ ë‹¨ê°€ ê³„ì‚°
- `QuoteManager.php:476-483` - quotation_tempì—ì„œ ë‹¨ê°€ ê³„ì‚°
- `calculator_modal.js:236-250` - ê·œê²© ë¬¸ìì—´ì—ì„œ ì—°/ë§¤ìˆ˜ íŒŒì‹±

```javascript
// calculator_modal.js - ì „ë‹¨ì§€ ìˆ˜ëŸ‰/ë§¤ìˆ˜ ì¶”ì¶œ
const reamMatch = data.specification.match(/([0-9.]+)ì—°/);  // "0.5ì—°" â†’ 0.5
const mesuMatch = data.specification.match(/\(([0-9,]+)ë§¤\)/);  // "(5,000ë§¤)" â†’ 5000
```

### í’ˆëª©ë³„ ë‹¨ìœ„ ê¸°ì¤€

| í’ˆëª© | ë‹¨ìœ„ | ìˆ˜ëŸ‰ í•„ë“œ | ë‹¨ê°€ ê³„ì‚° |
|------|------|-----------|-----------|
| ì „ë‹¨ì§€ (inserted) | ì—° | MY_amount | ê³µê¸‰ê°€ Ã· mesu (ì†Œìˆ˜ì  1ìë¦¬) |
| ëª…í•¨ (namecard) | ë§¤ | mesu | ê³µê¸‰ê°€ Ã· mesu |
| ìŠ¤í‹°ì»¤ (sticker) | ë§¤ | mesu | ê³µê¸‰ê°€ Ã· mesu |
| ë´‰íˆ¬ (envelope) | ë¶€ | MY_amount | ê³µê¸‰ê°€ Ã· MY_amount |
| ì¹´ë‹¤ë¡ (cadarok) | ë¶€ | MY_amount | ê³µê¸‰ê°€ Ã· MY_amount |
| ìƒí’ˆê¶Œ (merchandisebond) | ë¶€ | MY_amount | ê³µê¸‰ê°€ Ã· MY_amount |
| ì–‘ì‹ì§€ (ncrflambeau) | ë¶€ | MY_amount | ê³µê¸‰ê°€ Ã· MY_amount |
| ìì„ìŠ¤í‹°ì»¤ (msticker) | ê°œ | ê¸°ë³¸ê°’ | ê³µê¸‰ê°€ Ã· ìˆ˜ëŸ‰ |
| ì†ŒëŸ‰ì¸ì‡„ (littleprint) | ë¶€ | MY_amount | ê³µê¸‰ê°€ Ã· MY_amount |

---

## ğŸ–¥ï¸ ê³„ì‚°ê¸° ëª¨ë‹¬ ì‹œìŠ¤í…œ

### íŒŒì¼ êµ¬ì„±

```
includes/
â”œâ”€â”€ calculator_modal.js   # ëª¨ë‹¬ ë¡œì§
â””â”€â”€ calculator_modal.css  # ëª¨ë‹¬ ìŠ¤íƒ€ì¼
```

### calculator_modal.js í•µì‹¬ êµ¬ì¡°

```javascript
// ì œí’ˆë³„ ê³„ì‚°ê¸° URL ë§¤í•‘
const CALCULATOR_URLS = {
    'ì „ë‹¨ì§€': '/mlangprintauto/inserted/index.php',
    'ëª…í•¨': '/mlangprintauto/namecard/index.php',
    'ë´‰íˆ¬': '/mlangprintauto/envelope/index.php',
    // ... 9ê°œ í’ˆëª©
};

// ì œí’ˆ íƒ€ì… ë§¤í•‘
const PRODUCT_TYPE_MAP = {
    'ì „ë‹¨ì§€': 'inserted',
    'ëª…í•¨': 'namecard',
    // ...
};

class CalculatorModal {
    // ëª¨ë‹¬ ì—´ê¸° - iframeìœ¼ë¡œ ê³„ì‚°ê¸° ë¡œë“œ
    open(productName, row) {
        this.iframe.src = calculatorUrl + '?mode=quotation';
    }

    // postMessageë¡œ ê°€ê²© ë°ì´í„° ìˆ˜ì‹ 
    setupMessageListener() {
        window.addEventListener('message', (event) => {
            if (event.data.type === 'CALCULATOR_PRICE_DATA') {
                this.handlePriceData(event.data.payload);
            }
        });
    }

    // ê²¬ì ì„œ í¼ì— ë°ì´í„° ì ìš©
    fillCurrentRow(data) {
        // ê·œê²©, ìˆ˜ëŸ‰, ë‹¨ìœ„, ë‹¨ê°€, ê³µê¸‰ê°€ ì…ë ¥
    }
}
```

### calculator_modal.css í•µì‹¬ ì„¤ì •

```css
.calc-modal-content {
    width: 90%;
    max-width: 1200px;
    min-width: 900px;  /* âš ï¸ ëª¨ë°”ì¼ ë·° ë°©ì§€ */
    height: 85vh;
}

/* ì‘ì€ í™”ë©´ì—ì„œë§Œ ìµœì†Œ ë„ˆë¹„ í•´ì œ */
@media screen and (max-width: 960px) {
    .calc-modal-content {
        min-width: auto;
    }
}
```

### ê³„ì‚°ê¸° â†’ ê²¬ì ì„œ ë°ì´í„° íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     postMessage      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ê³„ì‚°ê¸° iframe   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚  ë¶€ëª¨ì°½ (create) â”‚
â”‚  (inserted/)     â”‚                      â”‚                  â”‚
â”‚                  â”‚  CALCULATOR_PRICE_   â”‚  fillCurrentRow()â”‚
â”‚  "ê²¬ì ì„œì— ì ìš©"  â”‚  DATA               â”‚  â†’ í¼ í•„ë“œ ì±„ì›€   â”‚
â”‚  ë²„íŠ¼ í´ë¦­       â”‚                      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì „ì†¡ ë°ì´í„° êµ¬ì¡°:
{
    type: 'CALCULATOR_PRICE_DATA',
    payload: {
        product_name: 'ì „ë‹¨ì§€',
        specification: 'ì¹¼ë¼ì¸ì‡„(CMYK) | 90gì•„íŠ¸ì§€ | A4 | ë‹¨ë©´ | 0.5ì—° (5,000ë§¤)',
        quantity: 0.5,
        unit: 'ì—°',
        mesu: 5000,
        supply_price: 53300
    }
}
```

---

## ğŸ”§ API ì—”ë“œí¬ì¸íŠ¸

### save.php - ê²¬ì ì„œ ì €ì¥

```
POST /mlangprintauto/quote/api/save.php

í•„ìˆ˜ íŒŒë¼ë¯¸í„°:
- customer_name: ê³ ê°ëª…
- customer_email: ê³ ê° ì´ë©”ì¼
- from_cart: "1" (ì¥ë°”êµ¬ë‹ˆì—ì„œ) ë˜ëŠ” "0" (ìˆ˜ë™)
- items[]: í’ˆëª© ë°°ì—´ (ìˆ˜ë™ ì…ë ¥ ì‹œ)

ì‘ë‹µ:
{
    "success": true,
    "quote_id": 123,
    "quote_no": "Q-20251201-001",
    "public_token": "abc123...",
    "public_url": "http://..."
}
```

### update.php - ê²¬ì ì„œ ìˆ˜ì •

```
POST /mlangprintauto/quote/api/update.php

âš ï¸ draft ìƒíƒœë§Œ ìˆ˜ì • ê°€ëŠ¥

í•„ìˆ˜ íŒŒë¼ë¯¸í„°:
- quote_id: ê²¬ì ì„œ ID
- customer_name: ê³ ê°ëª…
- customer_email: ê³ ê° ì´ë©”ì¼
- items_json: JSON í˜•ì‹ í’ˆëª© ë°°ì—´

âš ï¸ ì¤‘ìš”: supply_price ì§ì ‘ ì‚¬ìš©
ê° í’ˆëª©ì˜ supply_priceë¥¼ ì¬ê³„ì‚°í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì €ì¥
(100ìë¦¬ ì ˆì‚­ ë°©ì§€)
```

### create_revision.php - ê°œì •íŒ ìƒì„±

```
POST /mlangprintauto/quote/api/create_revision.php

âš ï¸ sent ìƒíƒœë§Œ ê°œì •íŒ ìƒì„± ê°€ëŠ¥

í•„ìˆ˜ íŒŒë¼ë¯¸í„°:
- original_quote_id: ì›ë³¸ ê²¬ì ì„œ ID
- customer_name: ê³ ê°ëª…
- customer_email: ê³ ê° ì´ë©”ì¼
- items_json: JSON í˜•ì‹ í’ˆëª© ë°°ì—´

ì‘ë‹µ:
{
    "success": true,
    "quote_id": 124,
    "quote_no": "Q-20251201-001-v2",  // ë²„ì „ ì¶”ê°€ë¨
    "public_token": "xyz789..."
}
```

---

## ğŸš¨ í”í•œ ë¬¸ì œì™€ í•´ê²° ë°©ë²•

### 1. "__direct__" ì €ì¥ ë¬¸ì œ

**ì¦ìƒ**: ì§ì ‘ì…ë ¥ ì„ íƒ ì‹œ í’ˆëª…ì´ "__direct__"ë¡œ ì €ì¥ë¨

**ì›ì¸**: `product_name` ì…€ë ‰íŠ¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì €ì¥

**í•´ê²°**: QuoteManager.php addManualItem() ìˆ˜ì •
```php
if ($productName === '__direct__' || empty($productName)) {
    $productName = trim($item['product_name_custom'] ?? '');
}
```

**ìœ„ì¹˜**: 520-523í–‰

### 2. ê³µê¸‰ê°€ì•¡ 100ìë¦¬ ì ˆì‚­

**ì¦ìƒ**: ê°œì •íŒ ì‘ì„± ì‹œ ê³µê¸‰ê°€ì•¡ì´ 53300 â†’ 53000 ë“±ìœ¼ë¡œ ë³€ê²½ë¨

**ì›ì¸**: supply_priceë¥¼ quantity Ã— unit_priceë¡œ ì¬ê³„ì‚°

**í•´ê²°**: ì‚¬ìš©ì ì…ë ¥ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
```php
if (isset($item['supply_price']) && $item['supply_price'] !== '' && $item['supply_price'] !== null) {
    $supplyPrice = intval($item['supply_price']);
} else {
    $supplyPrice = intval($quantity * $unitPrice);
}
```

**ìœ„ì¹˜**:
- QuoteManager.php:549-554 (addManualItem)
- update.php:106-114

### 3. ê³„ì‚°ê¸° ëª¨ë‹¬ì´ ëª¨ë°”ì¼ ë·°ë¡œ í‘œì‹œ

**ì¦ìƒ**: ì»´í“¨í„°ì—ì„œë„ ê³„ì‚°ê¸°ê°€ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³´ì„

**ì›ì¸**: ëª¨ë‹¬ ë„ˆë¹„ê°€ ì¢ì•„ì„œ ë°˜ì‘í˜• ë¯¸ë””ì–´ì¿¼ë¦¬ ì ìš©

**í•´ê²°**: calculator_modal.css ìˆ˜ì •
```css
.calc-modal-content {
    min-width: 900px;  /* ëª¨ë°”ì¼ ë·° ë°©ì§€ */
}
```

**ìœ„ì¹˜**: calculator_modal.css:32

### 4. ê°œì •íŒ ì¤‘ë³µ ë²ˆí˜¸ ì˜¤ë¥˜

**ì¦ìƒ**: "Duplicate entry" ì˜¤ë¥˜ë¡œ v2, v3 ìƒì„± ì‹¤íŒ¨

**ì›ì¸**: ë²„ì „ ë²ˆí˜¸ ê³„ì‚° ì˜¤ë¥˜

**í•´ê²°**: DBì—ì„œ ì‹¤ì œ ìµœëŒ€ ë²„ì „ ì¡°íšŒ
```php
$maxVersionQuery = "SELECT MAX(version) as max_version FROM quotes
                   WHERE original_quote_id = ? OR id = ?";
```

**ìœ„ì¹˜**: QuoteManager.php:961-971

### 5. ì „ë‹¨ì§€ ë§¤ìˆ˜ í‘œì‹œ ì•ˆë¨

**ì¦ìƒ**: ì „ë‹¨ì§€ í’ˆëª©ì—ì„œ "(5,000ë§¤)" í‘œì‹œê°€ ì—†ìŒ

**ì›ì¸**: source_data JSONì— mesu ë¯¸í¬í•¨

**í•´ê²°**:
1. source_dataì— mesu ì €ì¥ í™•ì¸
2. detail.phpì—ì„œ JSON íŒŒì‹± í›„ í‘œì‹œ

```php
if (($item['product_type'] ?? '') === 'inserted' && !empty($item['source_data'])) {
    $sourceData = json_decode($item['source_data'], true);
    if (!empty($sourceData['mesu'])) {
        echo '<br><span style="font-size:10px;">(' . number_format($sourceData['mesu']) . 'ë§¤)</span>';
    }
}
```

---

## ğŸ”„ ìƒíƒœ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ì €ì¥     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ì´ë©”ì¼    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  draft  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  draft  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  sent   â”‚
â”‚ (ì‘ì„±ì¤‘) â”‚            â”‚ (ì €ì¥ë¨) â”‚   ë°œì†¡      â”‚ (ë°œì†¡ë¨) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â†“              â†“              â†“
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ viewed  â”‚    â”‚ accepted â”‚    â”‚ rejected â”‚
                             â”‚(ê³ ê°í™•ì¸)â”‚    â”‚ (ìˆ˜ë½ë¨) â”‚    â”‚ (ê±°ì ˆë¨) â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ ê·œì¹™:
- draftë§Œ ìˆ˜ì • ê°€ëŠ¥ (edit.php)
- sentë§Œ ê°œì •íŒ ìƒì„± ê°€ëŠ¥ (revise.php)
- ê°œì •íŒ ìƒì„± ì‹œ ì›ë³¸ì˜ is_latest = 0 ì²˜ë¦¬
```

---

## ğŸ“ ë°ì´í„° ê²€ì¦ ë„êµ¬

### check_quote.php

```
http://dsp1830.shop/mlangprintauto/quote/check_quote.php?id=63

ê²¬ì ì„œ IDë¡œ ë°ì´í„° ìƒíƒœ í™•ì¸
- ê²¬ì ì„œ ë©”ì¸ ì •ë³´
- í’ˆëª© ëª©ë¡ ë° í•„ë“œê°’
- JSON ë°ì´í„° íŒŒì‹± ê²°ê³¼
```

### fix_customer_name.php

```
http://dsp1830.shop/mlangprintauto/quote/fix_customer_name.php?id=63&name=í™ê¸¸ë™&key=fix2025

ì˜ëª»ëœ ê³ ê°ëª… ìˆ˜ì • (ë³´ì•ˆí‚¤ í•„ìˆ˜)
```

### fix_company_name.php

```
http://dsp1830.shop/mlangprintauto/quote/fix_company_name.php?id=63&company=í•œí•˜ë‹ˆ&key=fix2025

ì˜ëª»ëœ íšŒì‚¬ëª… ìˆ˜ì • (ë³´ì•ˆí‚¤ í•„ìˆ˜)
```

---

## ğŸ› ï¸ ë³µêµ¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê²¬ì ì„œ ì €ì¥ì´ ì•ˆë  ë•Œ

1. [ ] QuoteManager.php addManualItem() í™•ì¸
   - bind_param íƒ€ì… ë¬¸ìì—´: "iisssdsiiiiss" (13ê°œ)
   - supply_price ì§ì ‘ ì‚¬ìš© ì—¬ë¶€

2. [ ] api/save.php í™•ì¸
   - items íŒŒë¼ë¯¸í„° íŒŒì‹±
   - items_json ë˜ëŠ” items[] ì²˜ë¦¬

3. [ ] DB í…Œì´ë¸” í™•ì¸
   ```sql
   DESCRIBE quote_items;
   -- supply_price: int
   -- unit_price: decimal(10,1)
   -- quantity: decimal(10,2)
   ```

### ê°œì •íŒ ìƒì„±ì´ ì•ˆë  ë•Œ

1. [ ] ì›ë³¸ ê²¬ì ì„œ status = 'sent' í™•ì¸
2. [ ] QuoteManager.php createRevision() í™•ì¸
3. [ ] ë²„ì „ ë²ˆí˜¸ ì¤‘ë³µ ì—¬ë¶€ í™•ì¸

### ê³„ì‚°ê¸° ëª¨ë‹¬ì´ ì´ìƒí•  ë•Œ

1. [ ] calculator_modal.css min-width: 900px
2. [ ] calculator_modal.js postMessage ì²˜ë¦¬
3. [ ] ê³„ì‚°ê¸° í˜ì´ì§€ì—ì„œ ?mode=quotation ì²˜ë¦¬

### ì „ë‹¨ì§€ í‘œì‹œê°€ ì´ìƒí•  ë•Œ

1. [ ] ProductSpecFormatter.php getQuantity() í™•ì¸
2. [ ] source_data JSONì— mesu í¬í•¨ ì—¬ë¶€
3. [ ] detail.php ì „ë‹¨ì§€ íŠ¹ìˆ˜ ì²˜ë¦¬ ì½”ë“œ

---

## ğŸ“Œ ì„œë²„ ì •ë³´

```
ì›¹ì„œë²„: http://dsp1830.shop
FTP: dsp1830.shop
ê³„ì •: dsp1830
ë¹„ë°€ë²ˆí˜¸: ds701018

MySQL:
- ì„œë²„: localhost
- DB: dsp1830
- ê³„ì •: dsp1830
- ë¹„ë°€ë²ˆí˜¸: ds701018
```

### FTP ì—…ë¡œë“œ ëª…ë ¹

```bash
# ë‹¨ì¼ íŒŒì¼ ì—…ë¡œë“œ
curl -T /var/www/html/mlangprintauto/quote/includes/QuoteManager.php \
     ftp://dsp1830.shop/mlangprintauto/quote/includes/ \
     --user dsp1830:ds701018

# ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ
curl -T /path/file1.php ftp://dsp1830.shop/path/ --user dsp1830:ds701018 && \
curl -T /path/file2.php ftp://dsp1830.shop/path/ --user dsp1830:ds701018
```

---

## ğŸ“š ê´€ë ¨ íŒŒì¼ ë¹ ë¥¸ ì°¸ì¡°

| ê¸°ëŠ¥ | íŒŒì¼ | í•µì‹¬ í•¨ìˆ˜/ì„¹ì…˜ |
|------|------|---------------|
| ê²¬ì ì„œ ì €ì¥ | api/save.php | createFromCart(), createEmpty() |
| ê²¬ì ì„œ ìˆ˜ì • | api/update.php | updateQuote() |
| ê°œì •íŒ ìƒì„± | api/create_revision.php | createRevision() |
| í’ˆëª© ì¶”ê°€ | QuoteManager.php:515 | addManualItem() |
| ê³µê¸‰ê°€ ê³„ì‚° | QuoteManager.php:549 | supply_price ì²˜ë¦¬ |
| ì „ë‹¨ì§€ ë‹¨ê°€ | QuoteManager.php:426 | mesuë¡œ ë‹¨ê°€ ê³„ì‚° |
| ê·œê²© í¬ë§· | ProductSpecFormatter.php | formatSpecification() |
| ê³„ì‚°ê¸° ëª¨ë‹¬ | calculator_modal.js | CalculatorModal í´ë˜ìŠ¤ |
| ëª¨ë‹¬ ìŠ¤íƒ€ì¼ | calculator_modal.css | .calc-modal-content |
| PDF ìƒì„± | api/generate_pdf.php | - |
| ì´ë©”ì¼ ë°œì†¡ | api/send_email.php | sendQuotationEmail() |

---

**âš ï¸ ì´ ë¬¸ì„œëŠ” ê²¬ì ì„œ ì‹œìŠ¤í…œì˜ ì™„ì „í•œ ì°¸ì¡°ì…ë‹ˆë‹¤.**
**ë¬¸ì œ ë°œìƒ ì‹œ ì´ ë¬¸ì„œì˜ "í”í•œ ë¬¸ì œì™€ í•´ê²° ë°©ë²•" ì„¹ì…˜ì„ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”.**
