# 봉투 페이지 드롭다운 시스템 문제 해결 보고서

## 📅 작업 일시
2025년 8월 2일

## 🚨 발생한 문제들

### 1. JavaScript 문법 오류
**오류**: `Uncaught SyntaxError: Invalid or unexpected token (at index.php:573:29)`

**원인**: 
- PHP 변수가 정의되지 않은 상태에서 JavaScript로 전달되면서 발생
- `$MultyUploadDir` 등의 변수가 undefined 상태

**해결방법**:
```php
// 수정 전
MultyUploadDir: "<?php echo $MultyUploadDir; ?>",

// 수정 후  
MultyUploadDir: "<?php echo isset($MultyUploadDir) ? htmlspecialchars($MultyUploadDir, ENT_QUOTES, 'UTF-8') : ''; ?>",
```

### 2. JSON 파싱 오류
**오류**: `가격 계산 응답 파싱 오류: SyntaxError: Unexpected token '<', "<?`

**원인**:
- `price_cal_ajax.php`에서 PHP Notice/Warning이 HTML로 출력되어 JSON 응답이 오염됨
- `$row['quantityTwo']` 필드가 존재하지 않아 PHP Notice 발생
- 오류 출력이 JSON 앞에 붙어서 파싱 실패

**해결방법**:
```php
// 1. 오류 출력 방지
error_reporting(0);
ini_set('display_errors', 0);
header('Content-Type: application/json; charset=utf-8');

// 2. 안전한 배열 접근
$ViewquantityTwo = isset($row['quantityTwo']) ? $row['quantityTwo'] : '';

// 3. 예외 처리 강화
try {
    // 데이터베이스 작업
} catch (Exception $e) {
    echo json_encode(['success' => false, 'message' => '오류 메시지']);
    exit;
}
```

### 3. 드롭다운 연동 문제
**문제**: 봉투 구분 선택 시 하위 종류가 제대로 로드되지 않음

**원인**:
- AJAX 요청 경로 문제 (`ajax/get_envelope_types.php` → `get_envelope_types.php`)
- 응답 데이터 형식 불일치

**해결방법**:
```javascript
// 수정된 AJAX 요청
xhr.open("GET", "get_envelope_types.php?category_type=" + encodeURIComponent(val), true);

// 응답 처리 개선
var options = JSON.parse(response);
if (options && options.length > 0) {
    for (var i = 0; i < options.length; i++) {
        PN_type.options[i + 1] = new Option(options[i].title, options[i].no);
    }
}
```

## 🔧 주요 수정 사항

### 1. `index.php` 수정
- PHP 변수의 안전한 JavaScript 전달
- 드롭다운 변경 함수 개선 (`change_Envelope_Field`)
- 가격 계산 함수 안정성 향상 (`env_calc_ok`)
- 디버깅 로그 추가

### 2. `price_cal_ajax.php` 완전 재작성
- 오류 출력 방지
- 안전한 데이터베이스 쿼리 (Prepared Statement)
- 예외 처리 강화
- 안전한 배열 접근

### 3. `get_envelope_types.php` 신규 생성
- 간단하고 안정적인 드롭다운 데이터 제공
- JSON 응답 형식 통일

## 📊 데이터베이스 구조 확인

### MlangPrintAuto_transactionCate 테이블
```
구분 282: 소봉투 (BigNo = 0)
├── 종류 283: 소봉투(100모조 220*105)
├── 종류 284: 레자크(100g 220*105)
└── ... (총 10개 종류)

구분 466: 대봉투 (BigNo = 0)  
├── 종류 474: 대봉투330*243(110g레자크)
├── 종류 741: 크라프트지(누런종이)
└── ... (총 6개 종류)
```

### MlangPrintAuto_envelope 테이블
- style: 구분 번호 (282, 466 등)
- Section: 종류 번호 (283, 474 등)
- quantity: 수량 (1000, 2000 등)
- POtype: 인쇄색상 (1, 2, 3)
- money: 인쇄비
- DesignMoney: 디자인비

## 🎯 최종 결과

### 정상 작동 흐름
1. **페이지 로드** → 첫 번째 구분(소봉투)의 종류들이 자동 로드
2. **구분 변경** → 해당 구분의 종류들로 드롭다운 업데이트
3. **종류 선택** → 가격 자동 계산 및 표시
4. **옵션 변경** → 실시간 가격 재계산

### 테스트 결과
```json
{
  "success": true,
  "data": {
    "Price": 35000,
    "DesignMoneyOk": 5000,
    "Order_PricOk": 40000,
    "VAT_PriceOk": 4000,
    "Total_PriceOk": 44000,
    "formatted": {
      "Price": "35,000",
      "DesignMoneyOk": "5,000",
      "Total_PriceOk": "44,000"
    }
  }
}
```

## 🛠️ 생성된 파일들

### 메인 파일
- `MlangPrintAuto/envelope/index.php` (수정)
- `MlangPrintAuto/envelope/price_cal_ajax.php` (수정)
- `MlangPrintAuto/envelope/get_envelope_types.php` (신규)

### 테스트/디버그 파일
- `MlangPrintAuto/envelope/test_dropdown.php`
- `MlangPrintAuto/envelope/debug_index.php`
- `MlangPrintAuto/envelope/test_price_calc.php`
- `MlangPrintAuto/envelope/debug_envelope_data.php`

## 💡 핵심 교훈

1. **PHP 오류가 JSON 응답을 오염시킬 수 있음** → 오류 출력 방지 필수
2. **undefined 배열 키 접근 시 Notice 발생** → `isset()` 또는 `??` 연산자 사용
3. **JavaScript에서 PHP 변수 사용 시 이스케이프 처리 필요** → `htmlspecialchars()` 사용
4. **AJAX 응답은 반드시 순수 JSON이어야 함** → HTML 태그나 PHP 오류 메시지 혼입 방지

## ✅ 최종 상태
- ✅ 드롭다운 연동 정상 작동
- ✅ 가격 계산 정상 작동  
- ✅ 장바구니 추가 기능 정상
- ✅ 바로 주문하기 기능 정상
- ✅ 공통 파일 적용 완료

봉투 주문 시스템이 완전히 복구되어 정상 작동합니다.