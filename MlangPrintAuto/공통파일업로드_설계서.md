# 📎 공통 파일 업로드 시스템 설계서

## 📅 작성일: 2025년 8월 4일

## 🎯 목적
모든 인쇄물 품목에서 사용할 수 있는 통합 파일 업로드 컴포넌트를 설계하여 코드 중복을 제거하고 일관성을 유지합니다.

---

## 🔍 현재 시스템 분석

### 📁 기존 파일 업로드 구조
```
PHPClass/MultyUpload/
├── FileUp.php          # 파일 업로드 메인 페이지
├── upload.php          # 실제 업로드 처리
├── FileDelete.php      # 파일 삭제 처리
├── Form.php           # 업로드 폼
├── FormOk.php         # 업로드 완료 처리
└── validate.js        # 클라이언트 검증
```

### 🔄 현재 업로드 플로우
1. **팝업 창 열기**: `small_window()` 함수로 FileUp.php 팝업
2. **파일 선택**: 사용자가 파일 선택 및 업로드
3. **서버 처리**: upload.php에서 파일 저장
4. **결과 반환**: 부모 창의 parentList에 파일명 추가
5. **팝업 닫기**: 자동으로 팝업 창 닫힘

### 📊 로그 정보 기반 디렉토리 구조
```
uploads/
└── {log_url}/          # 페이지별 구분
    └── {log_y}/        # 연도별 구분
        └── {log_md}/   # 월일별 구분
            └── {log_ip}/   # IP별 구분
                └── {log_time}/  # 시간별 구분
                    └── uploaded_files
```

---

## 🎨 새로운 공통 컴포넌트 설계

### 1️⃣ 컴포넌트 구조

#### 📁 파일 구조
```
includes/
├── file_upload_component.php    # 메인 컴포넌트
├── file_upload_handler.php      # AJAX 업로드 처리
├── file_delete_handler.php      # AJAX 삭제 처리
└── file_upload.js               # JavaScript 함수들

css/
└── file_upload.css              # 스타일시트
```

#### 🔧 컴포넌트 기능
- **드래그 앤 드롭 지원**: 모던한 파일 업로드 UI
- **다중 파일 업로드**: 여러 파일 동시 업로드
- **실시간 미리보기**: 이미지 파일 미리보기
- **진행률 표시**: 업로드 진행 상황 표시
- **파일 타입 검증**: 허용된 파일 형식만 업로드
- **파일 크기 제한**: 최대 파일 크기 제한

### 2️⃣ 사용법 (각 품목 페이지에서)

#### PHP 코드
```php
<?php
// 로그 정보 생성 (기존과 동일)
$log_info = generateLogInfo();

// 파일 업로드 컴포넌트 포함
include "../../includes/file_upload_component.php";
?>

<!-- HTML에서 사용 -->
<div class="file-upload-section">
    <?php renderFileUploadComponent($log_info, 'msticker'); ?>
</div>
```

#### JavaScript 초기화
```javascript
// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    initFileUpload({
        maxFiles: 10,
        maxFileSize: 50 * 1024 * 1024, // 50MB
        allowedTypes: ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'ai', 'psd'],
        uploadUrl: '../../includes/file_upload_handler.php',
        deleteUrl: '../../includes/file_delete_handler.php'
    });
});
```

### 3️⃣ 컴포넌트 API 설계

#### 📤 업로드 API (`file_upload_handler.php`)
```php
POST /includes/file_upload_handler.php
Content-Type: multipart/form-data

Parameters:
- files[]: 업로드할 파일들
- log_url: 페이지 구분자
- log_y: 연도
- log_md: 월일
- log_ip: IP 주소
- log_time: 타임스탬프
- product_type: 품목 타입 (msticker, ncrflambeau 등)

Response:
{
    "success": true,
    "data": {
        "uploaded_files": [
            {
                "original_name": "design.jpg",
                "saved_name": "design_20250804_001.jpg",
                "file_size": 1024000,
                "file_type": "image/jpeg",
                "upload_path": "uploads/msticker/2025/0804/127.0.0.1/1691234567/design_20250804_001.jpg"
            }
        ]
    }
}
```

#### 🗑️ 삭제 API (`file_delete_handler.php`)
```php
POST /includes/file_delete_handler.php
Content-Type: application/json

Parameters:
{
    "file_path": "uploads/msticker/2025/0804/127.0.0.1/1691234567/design_20250804_001.jpg",
    "log_info": { ... }
}

Response:
{
    "success": true,
    "message": "파일이 삭제되었습니다."
}
```

### 4️⃣ UI/UX 설계

#### 🎨 모던 UI 컴포넌트
```html
<div class="file-upload-container">
    <!-- 드래그 앤 드롭 영역 -->
    <div class="file-drop-zone" id="fileDropZone">
        <div class="drop-zone-content">
            <i class="upload-icon">📎</i>
            <h4>파일을 드래그하거나 클릭하여 업로드</h4>
            <p>JPG, PNG, PDF, AI, PSD 파일 지원 (최대 50MB)</p>
            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.ai,.psd">
            <button type="button" class="btn-upload">파일 선택</button>
        </div>
    </div>
    
    <!-- 업로드된 파일 목록 -->
    <div class="uploaded-files-list" id="uploadedFilesList">
        <!-- 동적으로 생성 -->
    </div>
    
    <!-- 업로드 진행률 -->
    <div class="upload-progress" id="uploadProgress" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="progress-text" id="progressText">0%</span>
    </div>
</div>
```

#### 📱 반응형 디자인
- **데스크톱**: 드래그 앤 드롭 + 파일 선택 버튼
- **모바일**: 파일 선택 버튼 중심 (드래그 앤 드롭 보조)
- **태블릿**: 하이브리드 방식

---

## 🔧 구현 계획

### 1단계: 기본 컴포넌트 구현
- [ ] `file_upload_component.php` - HTML 렌더링
- [ ] `file_upload.css` - 스타일시트
- [ ] `file_upload.js` - 기본 JavaScript 기능

### 2단계: 서버 사이드 처리
- [ ] `file_upload_handler.php` - 업로드 처리
- [ ] `file_delete_handler.php` - 삭제 처리
- [ ] 파일 검증 및 보안 처리

### 3단계: 고급 기능
- [ ] 드래그 앤 드롭 구현
- [ ] 이미지 미리보기
- [ ] 업로드 진행률 표시
- [ ] 에러 처리 및 사용자 피드백

### 4단계: 기존 시스템 통합
- [ ] 기존 `parentList` 시스템과 호환성 유지
- [ ] 기존 팝업 방식과 새 방식 선택 가능
- [ ] 점진적 마이그레이션 지원

### 5단계: 각 품목 페이지 적용
- [ ] msticker 페이지 적용
- [ ] ncrflambeau 페이지 적용
- [ ] littleprint 페이지 적용
- [ ] 기타 품목 페이지 적용

---

## 🚨 주의사항 및 고려사항

### 🔒 보안
- **파일 타입 검증**: 서버 사이드에서 MIME 타입 검증
- **파일 크기 제한**: PHP 설정과 JavaScript 양쪽에서 제한
- **업로드 경로 보안**: 웹 루트 외부 또는 실행 불가 디렉토리
- **파일명 새니타이징**: 특수문자 제거 및 중복 방지

### 📊 성능
- **청크 업로드**: 대용량 파일을 위한 분할 업로드
- **비동기 처리**: AJAX 기반 논블로킹 업로드
- **진행률 표시**: 사용자 경험 향상
- **에러 복구**: 업로드 실패 시 재시도 기능

### 🔄 호환성
- **기존 시스템**: 현재 `parentList` 방식과 호환
- **브라우저 지원**: IE11+ 지원 (필요시)
- **모바일 지원**: 터치 기반 인터페이스
- **점진적 개선**: 기존 기능 유지하면서 새 기능 추가

### 📱 사용성
- **직관적 UI**: 드래그 앤 드롭 + 클릭 업로드
- **실시간 피드백**: 업로드 상태 및 에러 메시지
- **파일 미리보기**: 이미지 파일 썸네일 표시
- **일괄 삭제**: 여러 파일 선택 삭제

---

## 💡 장점

### 🔧 개발자 관점
- **코드 재사용**: 한 번 구현으로 모든 품목에서 사용
- **유지보수 용이**: 중앙 집중식 관리
- **일관성**: 모든 페이지에서 동일한 업로드 경험
- **확장성**: 새로운 기능 추가 용이

### 👤 사용자 관점
- **모던한 UI**: 드래그 앤 드롭 지원
- **빠른 업로드**: 다중 파일 동시 업로드
- **실시간 피드백**: 진행률 및 상태 표시
- **모바일 친화적**: 반응형 디자인

### 🏢 비즈니스 관점
- **개발 시간 단축**: 공통 컴포넌트 재사용
- **사용자 만족도**: 향상된 업로드 경험
- **유지보수 비용**: 중앙 집중식 관리로 비용 절감

---

## 🔄 마이그레이션 전략

### 1단계: 병렬 운영
- 기존 팝업 방식과 새 컴포넌트 동시 제공
- 사용자가 선택할 수 있도록 옵션 제공

### 2단계: 점진적 전환
- 새로 개발하는 페이지는 새 컴포넌트 사용
- 기존 페이지는 순차적으로 업데이트

### 3단계: 완전 전환
- 모든 페이지가 새 컴포넌트 사용
- 기존 팝업 방식 제거

---

## 📚 참조 문서

- **공통함수 사용가이드**: `MlangPrintAuto/공통함수_사용가이드.md`
- **품목별 개발가이드**: `MlangPrintAuto/품목별_개발가이드.md`
- **기존 업로드 시스템**: `PHPClass/MultyUpload/`

---

**다음 단계**: 이 설계서를 바탕으로 실제 구현을 시작할 예정입니다.  
**우선순위**: 1단계 기본 컴포넌트 구현부터 시작하여 점진적으로 고도화