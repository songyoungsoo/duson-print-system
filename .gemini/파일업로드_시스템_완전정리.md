# ğŸ“ íŒŒì¼ì—…ë¡œë“œ ì‹œìŠ¤í…œ ì™„ì „ ì •ë¦¬

## ğŸ“… ì‘ì„±ì¼: 2025ë…„ 8ì›” 4ì¼

---

## ğŸ¯ ê°œìš”

ì¸ì‡„ ìë™í™” ì‹œìŠ¤í…œì˜ íŒŒì¼ ì—…ë¡œë“œ êµ¬ì¡°ë¥¼ ì™„ì „íˆ ë¶„ì„í•˜ê³ , ê¸°ì¡´ ì‹œìŠ¤í…œì˜ ë¬¸ì œì ì„ í•´ê²°í•˜ëŠ” í†µí•© íŒŒì¼ ê´€ë¦¬ ì‹œìŠ¤í…œì„ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ“Š ê¸°ì¡´ ì‹œìŠ¤í…œ ë¶„ì„

### ğŸ” í˜„ì¬ íŒŒì¼ ì—…ë¡œë“œ êµ¬ì¡°

#### **1. ë¬¼ë¦¬ì  ì €ì¥ ìœ„ì¹˜**
```
ImgFolder/
â””â”€â”€ {í˜ì´ì§€ëª…}/          # ì˜ˆ: msticker, ncrflambeau, littleprint
    â””â”€â”€ {ì—°ë„}/          # ì˜ˆ: 2025
        â””â”€â”€ {ì›”ì¼}/      # ì˜ˆ: 0804
            â””â”€â”€ {IPì£¼ì†Œ}/    # ì˜ˆ: 127.0.0.1
                â””â”€â”€ {íƒ€ì„ìŠ¤íƒ¬í”„}/  # ì˜ˆ: 1691234567
                    â”œâ”€â”€ design.jpg
                    â”œâ”€â”€ sample.pdf
                    â””â”€â”€ logo.ai
```

#### **2. ê¸°ì¡´ ì—…ë¡œë“œ í”Œë¡œìš°**
```mermaid
graph TD
    A[ì‚¬ìš©ì íŒŒì¼ ì—…ë¡œë“œ] --> B[PHPClass/MultyUpload/upload.php]
    B --> C[ImgFolderì— ì¦‰ì‹œ ì €ì¥]
    C --> D[parentList JavaScript ë³€ìˆ˜ì— íŒŒì¼ëª… ì¶”ê°€]
    
    D --> E{ì¥ë°”êµ¬ë‹ˆ or ì§ì ‘ì£¼ë¬¸?}
    
    E -->|ì¥ë°”êµ¬ë‹ˆ| F[shop_temp í…Œì´ë¸”]
    F --> G[ì£¼ë¬¸ ì˜µì…˜ë§Œ ì €ì¥<br/>íŒŒì¼ ì •ë³´ëŠ” ì €ì¥ ì•ˆë¨]
    G --> H[ì‚¬ìš©ìê°€ ì£¼ë¬¸í•˜ê¸° í´ë¦­]
    
    E -->|ì§ì ‘ì£¼ë¬¸| I[ë°”ë¡œ ì£¼ë¬¸ í˜ì´ì§€ë¡œ]
    H --> I
    
    I --> J[order_up.php - ì£¼ë¬¸ì ì •ë³´ ì…ë ¥]
    J --> K[í¼ ì œì¶œ ì‹œ selectList í•¨ìˆ˜ í˜¸ì¶œ]
    K --> L[parentListì˜ ëª¨ë“  íŒŒì¼ ì„ íƒ]
    L --> M[order_post.php - ì£¼ë¬¸ ì²˜ë¦¬]
    M --> N[MlangOrder_PrintAuto í…Œì´ë¸”ì— ì €ì¥]
    N --> O[ImgFolder í•„ë“œì— íŒŒì¼ ê²½ë¡œ ì €ì¥]
```

#### **3. ê¸°ì¡´ ì‹œìŠ¤í…œì˜ í•µì‹¬ íŒŒì¼ë“¤**
```
PHPClass/MultyUpload/
â”œâ”€â”€ FileUp.php          # íŒŒì¼ ì—…ë¡œë“œ ë©”ì¸ í˜ì´ì§€ (íŒì—…)
â”œâ”€â”€ upload.php          # ì‹¤ì œ ì—…ë¡œë“œ ì²˜ë¦¬
â”œâ”€â”€ FileDelete.php      # íŒŒì¼ ì‚­ì œ ì²˜ë¦¬
â”œâ”€â”€ Form.php           # ì—…ë¡œë“œ í¼
â””â”€â”€ FormOk.php         # ì—…ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
```

### ğŸš¨ ê¸°ì¡´ ì‹œìŠ¤í…œì˜ ë¬¸ì œì 

#### **1. ì¥ë°”êµ¬ë‹ˆì™€ íŒŒì¼ ë¶„ë¦¬**
- **ë¬¸ì œ**: shop_temp í…Œì´ë¸”ì— íŒŒì¼ ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ
- **ê²°ê³¼**: íŒŒì¼ê³¼ ì£¼ë¬¸ ì •ë³´ê°€ ë¶„ë¦¬ë˜ì–´ ê´€ë¦¬ë¨
- **ìœ„í—˜**: ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì‹œ íŒŒì¼ ëª©ë¡ ì†ì‹¤

#### **2. í´ë¼ì´ì–¸íŠ¸ ì˜ì¡´ì„±**
- **ë¬¸ì œ**: parentList JavaScript ë³€ìˆ˜ë¡œë§Œ íŒŒì¼ ê´€ë¦¬
- **ê²°ê³¼**: ì„¸ì…˜ ë¶ˆì•ˆì •ì„±, ë°ì´í„° ì†ì‹¤ ìœ„í—˜
- **ì œì•½**: ì„œë²„ ì‚¬ì´ë“œì—ì„œ íŒŒì¼ ì •ë³´ ì ‘ê·¼ ë¶ˆê°€

#### **3. ìˆ˜ë™ ì—°ê²° ë°©ì‹**
- **ë¬¸ì œ**: ì£¼ë¬¸ ì™„ë£Œ ì‹œì—ë§Œ íŒŒì¼ê³¼ ì£¼ë¬¸ì´ ì—°ê²°ë¨
- **ê²°ê³¼**: ì¤‘ê°„ ë‹¨ê³„ì—ì„œ íŒŒì¼ ê´€ë¦¬ ì–´ë ¤ì›€
- **í•œê³„**: ì‹¤ì‹œê°„ íŒŒì¼ ì¶”ê°€/ì‚­ì œ ë¶ˆê°€ëŠ¥

---

## ğŸ”§ ê°œì„ ëœ íŒŒì¼ ì—…ë¡œë“œ ì‹œìŠ¤í…œ

### ğŸ“‹ **1. shop_temp í…Œì´ë¸” êµ¬ì¡° í™•ì¥**

#### **ê¸°ì¡´ êµ¬ì¡°**
```sql
CREATE TABLE `shop_temp` (
  `no` int(11) NOT NULL AUTO_INCREMENT,
  `session_id` varchar(100) NOT NULL,
  `product_type` varchar(50) NOT NULL,
  `MY_type` varchar(50) DEFAULT NULL,
  `st_price` decimal(10,2) DEFAULT 0.00,
  `img` varchar(200) DEFAULT NULL,  -- ê¸°ì¡´: ë‹¨ì¼ íŒŒì¼ëª…ë§Œ
  -- ê¸°íƒ€ í•„ë“œë“¤...
);
```

#### **ê°œì„ ëœ êµ¬ì¡°**
```sql
ALTER TABLE `shop_temp` 
  -- ê¸°ì¡´ img í•„ë“œ í™•ì¥
  MODIFY COLUMN `img` TEXT DEFAULT NULL COMMENT 'ì—…ë¡œë“œëœ íŒŒì¼ëª…ë“¤ (ì½¤ë§ˆ êµ¬ë¶„)',
  
  -- íŒŒì¼ ê´€ë¦¬ í•„ë“œ ì¶”ê°€
  ADD COLUMN `file_path` VARCHAR(500) DEFAULT NULL COMMENT 'íŒŒì¼ ì €ì¥ ê²½ë¡œ',
  ADD COLUMN `file_info` TEXT DEFAULT NULL COMMENT 'íŒŒì¼ ìƒì„¸ ì •ë³´ (JSON)',
  ADD COLUMN `upload_log` TEXT DEFAULT NULL COMMENT 'ì—…ë¡œë“œ ë¡œê·¸ ì •ë³´',
  
  -- ë¡œê·¸ ì •ë³´ í•„ë“œ (ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜)
  ADD COLUMN `log_url` VARCHAR(100) DEFAULT NULL COMMENT 'í˜ì´ì§€ êµ¬ë¶„ì',
  ADD COLUMN `log_y` VARCHAR(10) DEFAULT NULL COMMENT 'ì—°ë„',
  ADD COLUMN `log_md` VARCHAR(10) DEFAULT NULL COMMENT 'ì›”ì¼',
  ADD COLUMN `log_ip` VARCHAR(50) DEFAULT NULL COMMENT 'IP ì£¼ì†Œ',
  ADD COLUMN `log_time` VARCHAR(20) DEFAULT NULL COMMENT 'íƒ€ì„ìŠ¤íƒ¬í”„';
```

### ğŸ—‚ï¸ **2. íŒŒì¼ ì •ë³´ ì €ì¥ êµ¬ì¡°**

#### **file_info í•„ë“œ JSON êµ¬ì¡°**
```json
[
  {
    "original_name": "design.jpg",
    "saved_name": "design_20250804_001.jpg",
    "file_size": 1024000,
    "file_type": "image/jpeg",
    "upload_time": 1691234567,
    "upload_path": "ImgFolder/msticker/2025/0804/127.0.0.1/1691234567/design_20250804_001.jpg"
  },
  {
    "original_name": "logo.pdf",
    "saved_name": "logo_20250804_002.pdf",
    "file_size": 2048000,
    "file_type": "application/pdf",
    "upload_time": 1691234568,
    "upload_path": "ImgFolder/msticker/2025/0804/127.0.0.1/1691234567/logo_20250804_002.pdf"
  }
]
```

#### **img í•„ë“œ í˜¸í™˜ì„± ìœ ì§€**
```
ê¸°ì¡´ ë°©ì‹: "design.jpg"
ìƒˆë¡œìš´ ë°©ì‹: "design_20250804_001.jpg,logo_20250804_002.pdf"
```

### ğŸ”„ **3. ìƒˆë¡œìš´ íŒŒì¼ ì—…ë¡œë“œ í”Œë¡œìš°**

```mermaid
graph TD
    A[ì‚¬ìš©ì íŒŒì¼ ì—…ë¡œë“œ] --> B[AJAX file_upload_handler.php]
    B --> C[íŒŒì¼ ê²€ì¦ ë° ì•ˆì „í•œ ì´ë¦„ ìƒì„±]
    C --> D[ImgFolderì— íŒŒì¼ ì €ì¥]
    D --> E[shop_temp í…Œì´ë¸”ì— íŒŒì¼ ì •ë³´ ì €ì¥]
    E --> F[ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œê³¼ íŒŒì¼ ì—°ê²°]
    
    F --> G[ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ì—ì„œ íŒŒì¼ í‘œì‹œ]
    G --> H[ì‹¤ì‹œê°„ íŒŒì¼ ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥]
    H --> I[ì£¼ë¬¸í•˜ê¸° í´ë¦­]
    I --> J[íŒŒì¼ ì •ë³´ë¥¼ ì£¼ë¬¸ í…Œì´ë¸”ë¡œ ì´ì „]
    J --> K[MlangOrder_PrintAuto.ImgFolderì— ê²½ë¡œ ì €ì¥]
```

---

## ğŸ› ï¸ êµ¬í˜„ëœ íŒŒì¼ ê´€ë¦¬ ì‹œìŠ¤í…œ

### ğŸ“ **í•µì‹¬ íŒŒì¼ êµ¬ì¡°**

```
MlangPrintAuto/shop/
â”œâ”€â”€ upgrade_shop_temp_for_files.sql     # í…Œì´ë¸” êµ¬ì¡° ì—…ê·¸ë ˆì´ë“œ SQL
â”œâ”€â”€ file_management_helper.php          # íŒŒì¼ ê´€ë¦¬ í•µì‹¬ í•¨ìˆ˜ë“¤
â”œâ”€â”€ file_upload_handler.php             # AJAX íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
â”œâ”€â”€ file_delete_handler.php             # AJAX íŒŒì¼ ì‚­ì œ ì²˜ë¦¬
â”œâ”€â”€ get_cart_files.php                  # ì¥ë°”êµ¬ë‹ˆ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
â”œâ”€â”€ upgrade_add_to_basket_example.php   # ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì˜ˆì‹œ (íŒŒì¼ í¬í•¨)
â””â”€â”€ upgrade_cart_display_example.php    # ì¥ë°”êµ¬ë‹ˆ í‘œì‹œ ì˜ˆì‹œ (íŒŒì¼ í¬í•¨)

includes/
â””â”€â”€ file_upload_component.php           # ê³µí†µ íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸
```

### ğŸ”§ **ì£¼ìš” í•¨ìˆ˜ë“¤**

#### **1. íŒŒì¼ ê´€ë¦¬ í•µì‹¬ í•¨ìˆ˜ (file_management_helper.php)**

```php
// ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œì— íŒŒì¼ ì •ë³´ ì¶”ê°€
addFileToCartItem($connect, $cart_item_no, $file_info, $log_info)

// ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œì˜ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
getCartItemFiles($connect, $cart_item_no)

// ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œì—ì„œ íŠ¹ì • íŒŒì¼ ì‚­ì œ
removeFileFromCartItem($connect, $cart_item_no, $file_name)

// ì„¸ì…˜ì˜ ëª¨ë“  ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ íŒŒì¼ ì •ë³´ ì¡°íšŒ
getCartItemsWithFiles($connect, $session_id)

// ì£¼ë¬¸ ì™„ë£Œ ì‹œ íŒŒì¼ ì •ë³´ë¥¼ ì£¼ë¬¸ í…Œì´ë¸”ë¡œ ì´ì „
transferFilesToOrder($connect, $session_id, $order_id)

// íŒŒì¼ ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
createFileUploadDirectory($log_info)
```

#### **2. AJAX ì²˜ë¦¬ í•¨ìˆ˜ë“¤**

**íŒŒì¼ ì—…ë¡œë“œ (file_upload_handler.php)**
```php
POST /MlangPrintAuto/shop/file_upload_handler.php
Parameters:
- cart_item_no: ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë²ˆí˜¸
- product_type: ìƒí’ˆ ìœ í˜•
- files[]: ì—…ë¡œë“œí•  íŒŒì¼ë“¤

Response:
{
    "success": true,
    "data": {
        "uploaded_files": [...],
        "total_count": 2,
        "cart_item_no": 123
    }
}
```

**íŒŒì¼ ì‚­ì œ (file_delete_handler.php)**
```php
POST /MlangPrintAuto/shop/file_delete_handler.php
Content-Type: application/json

Body:
{
    "cart_item_no": 123,
    "file_name": "design_20250804_001.jpg"
}

Response:
{
    "success": true,
    "message": "íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

### ğŸ¨ **ê³µí†µ íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸**

#### **ì‚¬ìš©ë²•**
```php
<?php
// ë¡œê·¸ ì •ë³´ ìƒì„±
$log_info = generateLogInfo();

// íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
include "../../includes/file_upload_component.php";
renderFileUploadComponent($log_info, 'msticker', [
    'title' => 'ğŸ“ ë””ìì¸ íŒŒì¼ ì²¨ë¶€',
    'max_files' => 10,
    'max_file_size' => 50 * 1024 * 1024,
    'allowed_types' => ['jpg', 'jpeg', 'png', 'pdf', 'ai', 'psd']
]);
?>
```

#### **ê¸°ëŠ¥**
- âœ… **ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì§€ì›**
- âœ… **ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ**
- âœ… **ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°**
- âœ… **íŒŒì¼ íƒ€ì… ê²€ì¦**
- âœ… **íŒŒì¼ í¬ê¸° ì œí•œ**
- âœ… **ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜** (parentList ë°©ì‹ ë³‘í–‰)

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ìƒì„¸

### ğŸ—„ï¸ **í…Œì´ë¸” ê´€ê³„ë„**

```mermaid
erDiagram
    shop_temp {
        int no PK
        varchar session_id
        varchar product_type
        varchar MY_type
        decimal st_price
        text img
        varchar file_path
        text file_info
        varchar log_url
        varchar log_y
        varchar log_md
        varchar log_ip
        varchar log_time
    }
    
    MlangOrder_PrintAuto {
        int no PK
        varchar Type
        varchar ImgFolder
        varchar Type_1
        varchar name
        varchar email
    }
    
    mlangprintauto_transactioncate {
        int no PK
        varchar Ttable
        varchar BigNo
        varchar title
        varchar TreeNo
    }
    
    shop_temp ||--o{ MlangOrder_PrintAuto : "ì£¼ë¬¸ ì‹œ ì´ì „"
    shop_temp }o--|| mlangprintauto_transactioncate : "ì¹´í…Œê³ ë¦¬ ì°¸ì¡°"
```

### ğŸ“‹ **ë°ì´í„° ì˜ˆì‹œ**

#### **shop_temp í…Œì´ë¸” ë°ì´í„°**
```sql
INSERT INTO shop_temp (
    no, session_id, product_type, MY_type, MY_Fsd, MY_amount,
    st_price, st_price_vat, img, file_info, file_path,
    log_url, log_y, log_md, log_ip, log_time
) VALUES (
    1, 'sess_abc123', 'msticker', '742', '743', '1000',
    20000, 22000, 
    'design_001.jpg,logo_002.pdf',
    '[{"original_name":"design.jpg","saved_name":"design_001.jpg",...}]',
    'msticker/2025/0804/127.0.0.1/1691234567',
    'msticker', '2025', '0804', '127.0.0.1', '1691234567'
);
```

#### **MlangOrder_PrintAuto í…Œì´ë¸” ë°ì´í„°**
```sql
INSERT INTO MlangOrder_PrintAuto (
    Type, ImgFolder, Type_1, name, email, phone
) VALUES (
    'ìì„ìŠ¤í‹°ì»¤', 
    'msticker/2025/0804/127.0.0.1/1691234567',
    'ìì„ìŠ¤í‹°ì»¤ 90x60mm 1000ë§¤',
    'í™ê¸¸ë™', 'test@example.com', '010-1234-5678'
);
```

---

## ğŸ”„ ì‹œìŠ¤í…œ í†µí•© ë°©ì•ˆ

### ğŸ“ˆ **ë‹¨ê³„ë³„ ì ìš© ê³„íš**

#### **1ë‹¨ê³„: í…Œì´ë¸” êµ¬ì¡° ì—…ê·¸ë ˆì´ë“œ**
```bash
# 1. ê¸°ì¡´ ë°ì´í„° ë°±ì—…
CREATE TABLE shop_temp_backup AS SELECT * FROM shop_temp;

# 2. í…Œì´ë¸” êµ¬ì¡° ì—…ê·¸ë ˆì´ë“œ
SOURCE MlangPrintAuto/shop/upgrade_shop_temp_for_files.sql;

# 3. ì—…ê·¸ë ˆì´ë“œ í™•ì¸
DESCRIBE shop_temp;
```

#### **2ë‹¨ê³„: íŒŒì¼ ê´€ë¦¬ ì‹œìŠ¤í…œ ë°°í¬**
```bash
# íŒŒì¼ ë³µì‚¬
cp MlangPrintAuto/shop/file_*.php /server/path/
cp includes/file_upload_component.php /server/path/

# ê¶Œí•œ ì„¤ì •
chmod 755 MlangPrintAuto/shop/file_*.php
chmod 755 includes/file_upload_component.php
```

#### **3ë‹¨ê³„: ê¸°ì¡´ ì½”ë“œ ì ì§„ì  ì—…ê·¸ë ˆì´ë“œ**

**ê¸°ì¡´ add_to_basket.php ìˆ˜ì • ì˜ˆì‹œ:**
```php
// ê¸°ì¡´ ì½”ë“œ
if (addMstickerToCart($db, $session_id, $cart_data)) {
    success_response(['message' => 'ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.']);
}

// ìƒˆë¡œìš´ ì½”ë“œ (íŒŒì¼ ì§€ì›)
if ($cart_item_no = addMstickerToCart($db, $session_id, $cart_data)) {
    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    $uploaded_files = [];
    if (isset($_FILES['files'])) {
        $uploaded_files = handleFileUpload($db, $cart_item_no, $_FILES['files']);
    }
    
    success_response([
        'cart_item_no' => $cart_item_no,
        'uploaded_files' => $uploaded_files,
        'message' => 'ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'
    ]);
}
```

### ğŸ”€ **í˜¸í™˜ì„± ìœ ì§€ ì „ëµ**

#### **1. ê¸°ì¡´ parentList ë°©ì‹ ë³‘í–‰**
```javascript
// ê¸°ì¡´ ë°©ì‹ (íŒì—…)
function uploadFileLegacy() {
    const url = `../../PHPClass/MultyUpload/FileUp.php?...`;
    window.open(url, 'FileUpload', 'width=500,height=400');
}

// ìƒˆë¡œìš´ ë°©ì‹ (AJAX)
function uploadFileModern(cartItemNo, files) {
    const formData = new FormData();
    formData.append('cart_item_no', cartItemNo);
    for (let file of files) {
        formData.append('files[]', file);
    }
    
    fetch('file_upload_handler.php', {
        method: 'POST',
        body: formData
    }).then(response => response.json());
}
```

#### **2. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**
```php
// ê¸°ì¡´ img í•„ë“œ ë°ì´í„°ë¥¼ ìƒˆ êµ¬ì¡°ë¡œ ë³€í™˜
function migrateExistingFiles($db) {
    $query = "SELECT no, img, session_id FROM shop_temp WHERE img IS NOT NULL AND file_info IS NULL";
    $result = mysqli_query($db, $query);
    
    while ($row = mysqli_fetch_assoc($result)) {
        if (!empty($row['img'])) {
            $files = explode(',', $row['img']);
            $file_info = [];
            
            foreach ($files as $file) {
                $file_info[] = [
                    'original_name' => $file,
                    'saved_name' => $file,
                    'file_size' => 0,
                    'file_type' => 'unknown',
                    'upload_time' => time()
                ];
            }
            
            $update_query = "UPDATE shop_temp SET file_info = ? WHERE no = ?";
            $stmt = mysqli_prepare($db, $update_query);
            mysqli_stmt_bind_param($stmt, 'si', json_encode($file_info), $row['no']);
            mysqli_stmt_execute($stmt);
        }
    }
}
```

---

## ğŸš€ ì„±ëŠ¥ ë° ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### âš¡ **ì„±ëŠ¥ ìµœì í™”**

#### **1. íŒŒì¼ ì—…ë¡œë“œ ìµœì í™”**
```php
// ì²­í¬ ì—…ë¡œë“œ ì§€ì›
function handleChunkedUpload($file, $chunk_index, $total_chunks) {
    $temp_dir = sys_get_temp_dir() . '/chunked_uploads/';
    $chunk_file = $temp_dir . $file['name'] . '.part' . $chunk_index;
    
    move_uploaded_file($file['tmp_name'], $chunk_file);
    
    // ëª¨ë“  ì²­í¬ê°€ ì—…ë¡œë“œë˜ë©´ í•©ì¹˜ê¸°
    if ($chunk_index == $total_chunks - 1) {
        return mergeChunks($file['name'], $total_chunks);
    }
    
    return false;
}
```

#### **2. ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ìµœì í™”**
```sql
-- íŒŒì¼ ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ
CREATE INDEX idx_file_search ON shop_temp (session_id, product_type, file_path);
CREATE INDEX idx_log_cleanup ON shop_temp (log_y, log_md, regdate);

-- íŒŒì¼ ì •ë³´ JSON ê²€ìƒ‰ (MySQL 5.7+)
ALTER TABLE shop_temp ADD INDEX idx_file_info ((CAST(file_info AS JSON)));
```

### ğŸ”’ **ë³´ì•ˆ ê°•í™”**

#### **1. íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ**
```php
// íŒŒì¼ íƒ€ì… ê²€ì¦ (MIME íƒ€ì… + í™•ì¥ì)
function validateFileType($file) {
    $allowed_types = [
        'image/jpeg' => ['jpg', 'jpeg'],
        'image/png' => ['png'],
        'application/pdf' => ['pdf'],
        'application/postscript' => ['ai']
    ];
    
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mime_type = finfo_file($finfo, $file['tmp_name']);
    $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
    
    return isset($allowed_types[$mime_type]) && 
           in_array($extension, $allowed_types[$mime_type]);
}

// íŒŒì¼ëª… ìƒˆë‹ˆíƒ€ì´ì§•
function sanitizeFileName($filename) {
    // ìœ„í—˜í•œ ë¬¸ì ì œê±°
    $filename = preg_replace('/[^a-zA-Z0-9._-]/', '_', $filename);
    
    // ì—°ì†ëœ ì  ì œê±° (ë””ë ‰í† ë¦¬ íƒìƒ‰ ë°©ì§€)
    $filename = preg_replace('/\.+/', '.', $filename);
    
    // ê¸¸ì´ ì œí•œ
    if (strlen($filename) > 100) {
        $filename = substr($filename, 0, 100);
    }
    
    return $filename;
}
```

#### **2. ì„¸ì…˜ ê¸°ë°˜ ì ‘ê·¼ ì œì–´**
```php
// íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ê²€ì¦
function validateFileAccess($db, $cart_item_no, $session_id) {
    $query = "SELECT no FROM shop_temp WHERE no = ? AND session_id = ?";
    $stmt = mysqli_prepare($db, $query);
    mysqli_stmt_bind_param($stmt, 'is', $cart_item_no, $session_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    
    return mysqli_num_rows($result) > 0;
}
```

#### **3. íŒŒì¼ ì €ì¥ ê²½ë¡œ ë³´ì•ˆ**
```php
// ì›¹ ë£¨íŠ¸ ì™¸ë¶€ì— íŒŒì¼ ì €ì¥
$secure_upload_path = '/var/uploads/mlang_files/';

// ì§ì ‘ ì ‘ê·¼ ë°©ì§€ë¥¼ ìœ„í•œ .htaccess
file_put_contents($upload_dir . '/.htaccess', 'Deny from all');

// íŒŒì¼ ë‹¤ìš´ë¡œë“œëŠ” ë³„ë„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ì„œë§Œ
function secureFileDownload($file_path, $original_name) {
    if (!file_exists($file_path)) {
        http_response_code(404);
        exit;
    }
    
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . $original_name . '"');
    header('Content-Length: ' . filesize($file_path));
    
    readfile($file_path);
    exit;
}
```

---

## ğŸ“ˆ ëª¨ë‹ˆí„°ë§ ë° ìœ ì§€ë³´ìˆ˜

### ğŸ“Š **íŒŒì¼ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§**

#### **1. ì €ì¥ ê³µê°„ ì‚¬ìš©ëŸ‰ ì¶”ì **
```php
// ì¼ì¼ íŒŒì¼ ì‚¬ìš©ëŸ‰ ì²´í¬
function checkDailyFileUsage($db) {
    $today = date('Y-m-d');
    
    $query = "
        SELECT 
            product_type,
            COUNT(*) as file_count,
            SUM(JSON_EXTRACT(file_info, '$[*].file_size')) as total_size
        FROM shop_temp 
        WHERE DATE(FROM_UNIXTIME(regdate)) = ?
        GROUP BY product_type
    ";
    
    $stmt = mysqli_prepare($db, $query);
    mysqli_stmt_bind_param($stmt, 's', $today);
    mysqli_stmt_execute($stmt);
    
    return mysqli_stmt_get_result($stmt);
}
```

#### **2. íŒŒì¼ ì •ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬**
```php
// ì˜¤ë˜ëœ ì„ì‹œ íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ìƒ)
function cleanupOldFiles($db) {
    $cutoff_date = time() - (7 * 24 * 60 * 60); // 7ì¼ ì „
    
    $query = "
        SELECT file_info, file_path 
        FROM shop_temp 
        WHERE regdate < ? AND order_id IS NULL
    ";
    
    $stmt = mysqli_prepare($db, $query);
    mysqli_stmt_bind_param($stmt, 'i', $cutoff_date);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    
    while ($row = mysqli_fetch_assoc($result)) {
        $files = json_decode($row['file_info'], true);
        if ($files) {
            foreach ($files as $file) {
                if (isset($file['upload_path']) && file_exists($file['upload_path'])) {
                    unlink($file['upload_path']);
                }
            }
        }
    }
    
    // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë„ ì‚­ì œ
    $delete_query = "DELETE FROM shop_temp WHERE regdate < ? AND order_id IS NULL";
    $stmt = mysqli_prepare($db, $delete_query);
    mysqli_stmt_bind_param($stmt, 'i', $cutoff_date);
    mysqli_stmt_execute($stmt);
}
```

### ğŸ”§ **ì—ëŸ¬ ë¡œê¹… ë° ë””ë²„ê¹…**

#### **1. íŒŒì¼ ì—…ë¡œë“œ ì—ëŸ¬ ë¡œê¹…**
```php
function logFileUploadError($error_type, $details) {
    $log_entry = [
        'timestamp' => date('Y-m-d H:i:s'),
        'error_type' => $error_type,
        'details' => $details,
        'user_ip' => $_SERVER['REMOTE_ADDR'] ?? 'unknown',
        'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? 'unknown'
    ];
    
    $log_file = '/var/log/mlang_file_uploads.log';
    file_put_contents($log_file, json_encode($log_entry) . "\n", FILE_APPEND);
}
```

#### **2. íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦**
```php
function verifyFileIntegrity($db) {
    $query = "SELECT no, file_info FROM shop_temp WHERE file_info IS NOT NULL";
    $result = mysqli_query($db, $query);
    
    $issues = [];
    
    while ($row = mysqli_fetch_assoc($result)) {
        $files = json_decode($row['file_info'], true);
        if ($files) {
            foreach ($files as $file) {
                if (isset($file['upload_path']) && !file_exists($file['upload_path'])) {
                    $issues[] = [
                        'cart_item' => $row['no'],
                        'missing_file' => $file['upload_path']
                    ];
                }
            }
        }
    }
    
    return $issues;
}
```

---

## ğŸ¯ ê²°ë¡  ë° í–¥í›„ ê³„íš

### âœ… **êµ¬í˜„ ì™„ë£Œ ì‚¬í•­**

1. **ğŸ“Š ì‹œìŠ¤í…œ ë¶„ì„**: ê¸°ì¡´ íŒŒì¼ ì—…ë¡œë“œ êµ¬ì¡° ì™„ì „ ë¶„ì„
2. **ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„**: shop_temp í…Œì´ë¸” í™•ì¥ ì„¤ê³„
3. **ğŸ”§ í•µì‹¬ í•¨ìˆ˜ êµ¬í˜„**: íŒŒì¼ ê´€ë¦¬ í—¬í¼ í•¨ìˆ˜ë“¤ ì™„ì„±
4. **ğŸŒ AJAX API êµ¬ì¶•**: íŒŒì¼ ì—…ë¡œë“œ/ì‚­ì œ/ì¡°íšŒ API ì™„ì„±
5. **ğŸ¨ UI ì»´í¬ë„ŒíŠ¸**: ê³µí†µ íŒŒì¼ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸ ì™„ì„±
6. **ğŸ“‹ ì˜ˆì‹œ ì½”ë“œ**: ì‹¤ì œ ì ìš© ê°€ëŠ¥í•œ ì˜ˆì‹œ ì½”ë“œ ì œê³µ

### ğŸš€ **ì£¼ìš” ê°œì„  íš¨ê³¼**

#### **ì‚¬ìš©ì ê²½í—˜**
- âœ… **íŒŒì¼ ì†ì‹¤ ë°©ì§€**: ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨í•´ë„ íŒŒì¼ ìœ ì§€
- âœ… **ì‹¤ì‹œê°„ ê´€ë¦¬**: ì¥ë°”êµ¬ë‹ˆì—ì„œ ë°”ë¡œ íŒŒì¼ ì¶”ê°€/ì‚­ì œ
- âœ… **ì§ê´€ì  UI**: ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì§€ì›

#### **ê°œë°œì í¸ì˜ì„±**
- âœ… **ì¼ê´€ëœ API**: ëª¨ë“  ìƒí’ˆì—ì„œ ë™ì¼í•œ íŒŒì¼ ê´€ë¦¬
- âœ… **ì½”ë“œ ì¬ì‚¬ìš©**: ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¡œ ê°œë°œ ì‹œê°„ ë‹¨ì¶•
- âœ… **í™•ì¥ì„±**: ìƒˆë¡œìš´ ê¸°ëŠ¥ ì‰½ê²Œ ì¶”ê°€ ê°€ëŠ¥

#### **ì‹œìŠ¤í…œ ì•ˆì •ì„±**
- âœ… **ë°ì´í„° ë¬´ê²°ì„±**: íŒŒì¼ê³¼ ì£¼ë¬¸ ì •ë³´ ì™„ì „ ì—°ë™
- âœ… **ë³´ì•ˆ ê°•í™”**: ì„¸ì…˜ ê¸°ë°˜ íŒŒì¼ ì ‘ê·¼ ì œì–´
- âœ… **í˜¸í™˜ì„±**: ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ ë³‘í–‰ ìš´ì˜ ê°€ëŠ¥

### ğŸ“… **í–¥í›„ ê°œë°œ ê³„íš**

#### **ë‹¨ê¸° ê³„íš (1-2ì£¼)**
1. **í…Œì´ë¸” ì—…ê·¸ë ˆì´ë“œ ì ìš©**
2. **msticker í˜ì´ì§€ì— íŒŒì¼ ì‹œìŠ¤í…œ ì ìš©**
3. **ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ë²„ê·¸ ìˆ˜ì •**

#### **ì¤‘ê¸° ê³„íš (1ê°œì›”)**
1. **ëª¨ë“  í’ˆëª© í˜ì´ì§€ì— íŒŒì¼ ì‹œìŠ¤í…œ ì ìš©**
2. **ì£¼ë¬¸ ì‹œìŠ¤í…œê³¼ ì™„ì „ ì—°ë™**
3. **íŒŒì¼ ì •ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬ êµ¬í˜„**

#### **ì¥ê¸° ê³„íš (3ê°œì›”)**
1. **íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ ì¶”ê°€**
2. **ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ìë™í™”**
3. **í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ ì—°ë™ ê²€í† **

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ğŸ“– **ê´€ë ¨ ë¬¸ì„œ**
- `MlangPrintAuto/ê³µí†µíŒŒì¼ì—…ë¡œë“œ_ì„¤ê³„ì„œ.md` - ì´ˆê¸° ì„¤ê³„ ë¬¸ì„œ
- `MlangPrintAuto/ê³µí†µí•¨ìˆ˜_ì‚¬ìš©ê°€ì´ë“œ.md` - ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©ë²•
- `MlangPrintAuto/í†µí•©ì¥ë°”êµ¬ë‹ˆ_ê°œë°œì§„í–‰ìƒí™©.md` - ì¥ë°”êµ¬ë‹ˆ ì‹œìŠ¤í…œ í˜„í™©

### ğŸ”§ **í•µì‹¬ íŒŒì¼**
- `MlangPrintAuto/shop/file_management_helper.php` - íŒŒì¼ ê´€ë¦¬ í•µì‹¬ í•¨ìˆ˜
- `MlangPrintAuto/shop/upgrade_shop_temp_for_files.sql` - í…Œì´ë¸” ì—…ê·¸ë ˆì´ë“œ SQL
- `includes/file_upload_component.php` - ê³µí†µ ì—…ë¡œë“œ ì»´í¬ë„ŒíŠ¸

### ğŸŒ **API ì—”ë“œí¬ì¸íŠ¸**
- `POST /MlangPrintAuto/shop/file_upload_handler.php` - íŒŒì¼ ì—…ë¡œë“œ
- `POST /MlangPrintAuto/shop/file_delete_handler.php` - íŒŒì¼ ì‚­ì œ
- `GET /MlangPrintAuto/shop/get_cart_files.php` - íŒŒì¼ ëª©ë¡ ì¡°íšŒ

---

**ì‘ì„±ì**: Kiro AI Assistant  
**ìµœì¢… ìˆ˜ì •ì¼**: 2025ë…„ 8ì›” 4ì¼  
**ë²„ì „**: v1.0  
**ìƒíƒœ**: âœ… êµ¬í˜„ ì™„ë£Œ, í…ŒìŠ¤íŠ¸ ì¤€ë¹„