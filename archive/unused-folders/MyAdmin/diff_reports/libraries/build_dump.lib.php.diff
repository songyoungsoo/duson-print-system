--- build_dump.lib.php (original)
+++ build_dump.lib.php (modified)
@@ -66,7 +66,7 @@
                 PMA_mysql_query('SET SQL_QUOTE_SHOW_CREATE = 0');
             }
             $result = PMA_mysql_query('SHOW CREATE TABLE ' . PMA_backquote($db) . '.' . PMA_backquote($table));
-            if ($result != FALSE && mysql_num_rows($result) > 0) {
+            if ($result != FALSE && mysqli_num_rows($result) > 0) {
                 $tmpres        = PMA_mysql_fetch_array($result);
                 // Fix for case problems with winwin, thanks to
                 // Pawe Szczepaski <pauluz at users.sourceforge.net>
@@ -92,7 +92,7 @@
                                . substr($tmpres[1], $pos);
                 $schema_create .= str_replace("\n", $crlf, PMA_htmlFormat($tmpres[1]));
             }
-            mysql_free_result($result);
+            mysqli_free_result($result);
             return $schema_create;
         } // end if MySQL >= 3.23.21
 
@@ -114,8 +114,8 @@
             }
             $schema_create     .= ',' . $crlf;
         } // end while
-        mysql_free_result($result);
-        $schema_create         = ereg_replace(',' . $crlf . '$', '', $schema_create);
+        mysqli_free_result($result);
+        $schema_create         = preg_replace(',' . $crlf . '$', '', $schema_create);
 
         $local_query = 'SHOW KEYS FROM ' . PMA_backquote($table) . ' FROM ' . PMA_backquote($db);
         $result      = PMA_mysql_query($local_query) or PMA_mysqlDie('', $local_query, '', $error_url);
@@ -140,7 +140,7 @@
                 $index[$kname][] = PMA_htmlFormat(PMA_backquote($row['Column_name'], $use_backquotes));
             }
         } // end while
-        mysql_free_result($result);
+        mysqli_free_result($result);
 
         while (list($x, $columns) = @each($index)) {
             $schema_create     .= ',' . $crlf;
@@ -200,8 +200,8 @@
         $local_query = 'SELECT * FROM ' . PMA_backquote($db) . '.' . PMA_backquote($table) . $add_query;
         $result      = PMA_mysql_query($local_query) or PMA_mysqlDie('', $local_query, '', $error_url);
         if ($result != FALSE) {
-            $fields_cnt = mysql_num_fields($result);
-            $rows_cnt   = mysql_num_rows($result);
+            $fields_cnt = mysqli_num_fields($result);
+            $rows_cnt   = mysqli_num_rows($result);
 
             // Checks whether the field is an integer or not
             for ($j = 0; $j < $fields_cnt; $j++) {
@@ -285,7 +285,7 @@
                 } // end if
             } // end while
         } // end if ($result != FALSE)
-        mysql_free_result($result);
+        mysqli_free_result($result);
 
         return TRUE;
     } // end of the 'PMA_getTableContentFast()' function
@@ -327,8 +327,8 @@
         $local_query  = 'SELECT * FROM ' . PMA_backquote($db) . '.' . PMA_backquote($table) . $add_query;
         $result       = PMA_mysql_query($local_query) or PMA_mysqlDie('', $local_query, '', $error_url);
         $current_row  = 0;
-        $fields_cnt   = mysql_num_fields($result);
-        $rows_cnt     = mysql_num_rows($result);
+        $fields_cnt   = mysqli_num_fields($result);
+        $rows_cnt     = mysqli_num_rows($result);
 
         @set_time_limit($GLOBALS['cfg']['ExecTimeLimit']); // HaRa
 
@@ -394,7 +394,7 @@
                     $schema_insert .= "'', ";
                 } // end if
             } // end for
-            $schema_insert = ereg_replace(', $', '', $schema_insert);
+            $schema_insert = preg_replace(', $', '', $schema_insert);
             $schema_insert .= ')';
             $handler(trim($schema_insert));
 
@@ -408,7 +408,7 @@
                 }
             } // end if
         } // end while
-        mysql_free_result($result);
+        mysqli_free_result($result);
 
         return TRUE;
     } // end of the 'PMA_getTableContentOld()' function
@@ -541,7 +541,7 @@
         // Gets the data from the database
         $local_query = 'SELECT * FROM ' . PMA_backquote($db) . '.' . PMA_backquote($table) . $add_query;
         $result      = PMA_mysql_query($local_query) or PMA_mysqlDie('', $local_query, '', $error_url);
-        $fields_cnt  = mysql_num_fields($result);
+        $fields_cnt  = mysqli_num_fields($result);
 
         @set_time_limit($GLOBALS['cfg']['ExecTimeLimit']);
 
@@ -556,7 +556,7 @@
                 else if ($row[$j] == '0' || $row[$j] != '') {
                     // loic1 : always enclose fields
                     if ($what == 'excel') {
-                        $row[$j]       = ereg_replace("\015(\012)?", "\012", $row[$j]);
+                        $row[$j]       = preg_replace("\015(\012)?", "\012", $row[$j]);
                     }
                     if ($enc_by == '') {
                         $schema_insert .= $row[$j];
@@ -586,7 +586,7 @@
                 header('Expires: ' . $GLOBALS['now']);
             }
         } // end while
-        mysql_free_result($result);
+        mysqli_free_result($result);
 
         return TRUE;
     } // end of the 'PMA_getTableCsv()' function
@@ -614,7 +614,7 @@
         }
         $columns_cnt     = count($columns);
         unset($i);
-        mysql_free_result($result);
+        mysqli_free_result($result);
 
         // Defines the offsets to use
         if ($limit_to > 0 && $limit_from >= 0) {
@@ -639,7 +639,7 @@
             }
             $buffer         .= '    </' . $table . '>' . $crlf;
         }
-        mysql_free_result($result);
+        mysqli_free_result($result);
 
         return $buffer;
     } // end of the 'PMA_getTableXML()' function