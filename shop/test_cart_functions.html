<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="../css/modern-style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>
            <p>ì‚­ì œ ê¸°ëŠ¥ê³¼ ê°€ê²© ê³„ì‚° ì¼ì¹˜ ì—¬ë¶€ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤</p>
        </div>
        
        <!-- 1. ìƒí’ˆ ì¶”ê°€ í…ŒìŠ¤íŠ¸ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">1. ìƒí’ˆ ì¶”ê°€ í…ŒìŠ¤íŠ¸</h3>
            </div>
            
            <form id="testForm">
                <div class="form-group">
                    <label class="form-label">ì¬ì§ˆ</label>
                    <select name="jong" class="form-control">
                        <option value="jil ì•„íŠ¸ìœ ê´‘ì½”íŒ…">jil ì•„íŠ¸ìœ ê´‘ì½”íŒ…</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ê°€ë¡œ (mm)</label>
                    <input type="number" name="garo" class="form-control" value="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ì„¸ë¡œ (mm)</label>
                    <input type="number" name="sero" class="form-control" value="150">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ìˆ˜ëŸ‰</label>
                    <select name="mesu" class="form-control">
                        <option value="1000">1000ë§¤</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">í¸ì§‘</label>
                    <select name="uhyung" class="form-control">
                        <option value="0">ì¸ì‡„ë§Œ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ë„ë¬´ì†¡</label>
                    <select name="domusong" class="form-control">
                        <option value="08000 ì›í˜•">08000 ì›í˜•</option>
                    </select>
                </div>
                
                <div class="text-center">
                    <button type="button" onclick="testCalculatePrice()" class="btn btn-info">ğŸ’° ê°€ê²© ê³„ì‚°</button>
                    <button type="button" onclick="testAddToBasket()" class="btn btn-primary">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€</button>
                </div>
            </form>
            
            <div id="priceResult" class="alert alert-info" style="display: none; margin-top: 1rem;">
                <h4>ê°€ê²© ê³„ì‚° ê²°ê³¼:</h4>
                <div id="priceDisplay"></div>
            </div>
        </div>
        
        <!-- 2. ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">2. ì¥ë°”êµ¬ë‹ˆ ëª©ë¡</h3>
                <button onclick="loadBasketItems()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            
            <div id="basketContent">
                <p>ì¥ë°”êµ¬ë‹ˆë¥¼ ë¡œë“œí•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
            </div>
        </div>
        
        <!-- 3. ê²°ê³¼ ë¡œê·¸ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">3. í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
                <button onclick="clearLog()" class="btn btn-danger">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>
            
            <div id="testLog" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                í…ŒìŠ¤íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <script>
    function log(message) {
        const logDiv = document.getElementById('testLog');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.textContent += `[${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function clearLog() {
        document.getElementById('testLog').textContent = 'í…ŒìŠ¤íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...\n';
    }
    
    // ê°€ê²© ê³„ì‚° í…ŒìŠ¤íŠ¸
    function testCalculatePrice() {
        log('ğŸ§® ê°€ê²© ê³„ì‚° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
        
        const form = document.getElementById('testForm');
        const formData = new FormData(form);
        formData.set('action', 'calculate');
        
        fetch('calculate_price.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                log(`âœ… ê°€ê²© ê³„ì‚° ì„±ê³µ: ${data.price}ì› (VAT: ${data.price_vat}ì›)`);
                document.getElementById('priceDisplay').innerHTML = 
                    `<strong>ê°€ê²©:</strong> ${data.price}ì›<br><strong>VAT í¬í•¨:</strong> ${data.price_vat}ì›`;
                document.getElementById('priceResult').style.display = 'block';
            } else {
                log(`âŒ ê°€ê²© ê³„ì‚° ì‹¤íŒ¨: ${data.message}`);
            }
        })
        .catch(error => {
            log(`âŒ ê°€ê²© ê³„ì‚° ì˜¤ë¥˜: ${error.message}`);
        });
    }
    
    // ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ í…ŒìŠ¤íŠ¸
    function testAddToBasket() {
        log('ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
        
        const form = document.getElementById('testForm');
        const formData = new FormData(form);
        formData.set('action', 'add_to_basket');
        formData.set('no', '');
        
        fetch('add_to_basket_safe.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                log(`âœ… ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì„±ê³µ: ${data.price}ì› (VAT: ${data.price_vat}ì›)`);
                loadBasketItems();
            } else {
                log(`âŒ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì‹¤íŒ¨: ${data.message}`);
            }
        })
        .catch(error => {
            log(`âŒ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì˜¤ë¥˜: ${error.message}`);
        });
    }
    
    // ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ë¡œë“œ
    function loadBasketItems() {
        log('ğŸ“‹ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ë¡œë“œ ì¤‘...');
        
        fetch('get_basket_items.php')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                log(`âœ… ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì„±ê³µ: ${data.items.length}ê°œ ì•„ì´í…œ`);
                displayBasketItems(data.items, data.total, data.total_vat);
            } else {
                log(`âŒ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì‹¤íŒ¨: ${data.message}`);
                document.getElementById('basketContent').innerHTML = 
                    '<div class="alert alert-warning">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
            }
        })
        .catch(error => {
            log(`âŒ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`);
        });
    }
    
    // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ í‘œì‹œ
    function displayBasketItems(items, total, totalVat) {
        if (items.length === 0) {
            document.getElementById('basketContent').innerHTML = 
                '<div class="alert alert-info">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        let html = '<table class="modern-table">';
        html += '<thead><tr>';
        html += '<th>NO</th><th>ì¬ì§ˆ</th><th>í¬ê¸°</th><th>ìˆ˜ëŸ‰</th><th>ë„ë¬´ì†¡</th>';
        html += '<th>ê°€ê²©</th><th>VATí¬í•¨</th><th>ì‚­ì œ</th>';
        html += '</tr></thead><tbody>';
        
        items.forEach(item => {
            html += '<tr>';
            html += `<td>${item.no}</td>`;
            html += `<td>${item.jong_short}</td>`;
            html += `<td>${item.garo}Ã—${item.sero}mm</td>`;
            html += `<td>${item.mesu}ë§¤</td>`;
            html += `<td>${item.domusong_short}</td>`;
            html += `<td><strong>${item.st_price}ì›</strong></td>`;
            html += `<td><strong>${item.st_price_vat}ì›</strong></td>`;
            html += `<td><button onclick="testRemoveItem(${item.no})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">ì‚­ì œ</button></td>`;
            html += '</tr>';
        });
        
        html += '<tr class="total-row">';
        html += `<td colspan="5"><strong>í•©ê³„</strong></td>`;
        html += `<td><strong>ï¿¦${total}</strong></td>`;
        html += `<td><strong>ï¿¦${totalVat}</strong></td>`;
        html += '<td></td>';
        html += '</tr>';
        html += '</tbody></table>';
        
        document.getElementById('basketContent').innerHTML = html;
    }
    
    // ì•„ì´í…œ ì‚­ì œ í…ŒìŠ¤íŠ¸
    function testRemoveItem(itemNo) {
        log(`ğŸ—‘ï¸ ì•„ì´í…œ ì‚­ì œ í…ŒìŠ¤íŠ¸ ì‹œì‘ (NO: ${itemNo})...`);
        
        if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            log('âŒ ì‚¬ìš©ìê°€ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
            return;
        }
        
        fetch('remove_from_basket.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'no=' + itemNo
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                log(`âœ… ì•„ì´í…œ ì‚­ì œ ì„±ê³µ: ${data.message}`);
                loadBasketItems(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                log(`âŒ ì•„ì´í…œ ì‚­ì œ ì‹¤íŒ¨: ${data.message}`);
            }
        })
        .catch(error => {
            log(`âŒ ì•„ì´í…œ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
        loadBasketItems();
        log('ğŸš€ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
    </script>
</body>
</html>