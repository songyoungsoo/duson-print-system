# 📎 품목별 파일 업로드 기능 적용 완전 가이드

## 📅 작성일: 2025년 8월 4일
## ✅ 기준 품목: msticker (성공적으로 적용 완료)

---

## 🎯 **적용 대상 품목들**

### **✅ 완료:**
- **msticker** - 파일 업로드 기능 적용 완료 ✅

### **🔄 적용 예정:**
- **ncrflambeau** - 양식지/NCR
- **littleprint** - 소량포스터  
- **envelope** - 봉투
- **namecard** - 명함
- **merchandisebond** - 상품권
- **cadarok** - 카다록/리플렛

---

## 🔧 **단계별 적용 방법 (msticker 기준)**

### **1단계: add_to_basket.php 파일 수정**

#### **1-1. 파일 관리 헬퍼 포함 추가**
```php
// 기존 include 문들 다음에 추가
include "../shop/file_management_helper.php";
```

#### **1-2. 장바구니 추가 성공 후 파일 처리 로직 추가**
```php
// 기존 장바구니 추가 성공 부분을 다음과 같이 수정:

if (mysqli_stmt_execute($stmt)) {
    $cart_item_no = mysqli_insert_id($db);
    
    // 파일 업로드 처리 (있는 경우)
    $uploaded_files = [];
    if (isset($_FILES['files']) && !empty($_FILES['files']['name'][0])) {
        try {
            $log_info = generateFileLogInfo('품목명'); // 품목명 변경 필요
            $upload_dir = createFileUploadDirectory($log_info);
            
            $files = $_FILES['files'];
            $file_count = count($files['name']);
            
            for ($i = 0; $i < $file_count; $i++) {
                if ($files['error'][$i] !== UPLOAD_ERR_OK) continue;
                
                $original_name = $files['name'][$i];
                $tmp_name = $files['tmp_name'][$i];
                $file_size = $files['size'][$i];
                $file_type = $files['type'][$i];
                
                // 파일 검증
                $file_ext = strtolower(pathinfo($original_name, PATHINFO_EXTENSION));
                $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'ai', 'psd'];
                
                if (!in_array($file_ext, $allowed_extensions) || $file_size > 50 * 1024 * 1024) {
                    continue;
                }
                
                // 안전한 파일명 생성
                $safe_name = preg_replace('/[^a-zA-Z0-9._-]/', '_', $original_name);
                $saved_name = date('His') . '_' . $safe_name;
                $upload_path = "$upload_dir/$saved_name";
                
                if (move_uploaded_file($tmp_name, $upload_path)) {
                    $file_info = [
                        'original_name' => $original_name,
                        'saved_name' => $saved_name,
                        'file_size' => $file_size,
                        'file_type' => $file_type,
                        'upload_path' => $upload_path
                    ];
                    
                    if (addFileToCartItem($db, $cart_item_no, $file_info, $log_info)) {
                        $uploaded_files[] = $original_name;
                    }
                }
            }
        } catch (Exception $e) {
            // 파일 업로드 실패해도 장바구니 추가는 성공으로 처리
            error_log("파일 업로드 오류: " . $e->getMessage());
        }
    }
    
    success_response([
        'cart_item_no' => $cart_item_no,
        'uploaded_files' => $uploaded_files,
        'file_count' => count($uploaded_files)
    ], '장바구니에 추가되었습니다.');
}
```

### **2단계: index.php 파일에 파일 업로드 UI 추가**

#### **2-1. HTML 구조 추가**
견적 결과 섹션과 버튼 섹션 사이에 다음 HTML 추가:

```html
<!-- 파일 업로드 섹션 -->
<div class="file-upload-section">
    <h4>📎 디자인 파일 첨부</h4>
    <p class="file-description">디자인 파일을 첨부해주세요. (JPG, PNG, PDF, AI, PSD 지원, 최대 50MB)</p>
    
    <div class="file-drop-zone" id="fileDropZone">
        <div class="drop-zone-content">
            <span class="upload-icon">📎</span>
            <p>파일을 드래그하거나 클릭하여 업로드</p>
            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.ai,.psd" style="display: none;">
            <button type="button" class="btn-upload" onclick="document.getElementById('fileInput').click()">파일 선택</button>
        </div>
    </div>
    
    <div class="uploaded-files-list" id="uploadedFilesList">
        <div class="no-files-message">첨부된 파일이 없습니다.</div>
    </div>
</div>
```

#### **2-2. CSS 스타일 추가**
`<style>` 섹션에 다음 CSS 추가:

```css
/* 파일 업로드 섹션 스타일 */
.file-upload-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    margin: 30px 0;
}

.file-upload-section h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
}

.file-description {
    color: #6c757d;
    margin-bottom: 20px;
    font-size: 0.9rem;
}

.file-drop-zone {
    border: 2px dashed #e9ecef;
    border-radius: 8px;
    padding: 30px 20px;
    text-align: center;
    background: white;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 15px;
}

.file-drop-zone:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.drop-zone-content p {
    margin: 10px 0;
    color: #6c757d;
}

.upload-icon {
    font-size: 2rem;
    display: block;
    margin-bottom: 10px;
}

.btn-upload {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-upload:hover {
    background: #0056b3;
}

.uploaded-files-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    background: white;
}

.no-files-message {
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-size: 0.9rem;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid #f1f3f4;
}

.file-info {
    display: flex;
    align-items: center;
    flex: 1;
}

.file-name {
    font-weight: 500;
    color: #495057;
}

.file-size {
    font-size: 0.8rem;
    color: #6c757d;
    margin-left: 10px;
}

.btn-remove-file {
    background: #dc3545;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
}
```

### **3단계: JavaScript 파일 업로드 기능 추가**

#### **3-1. 파일 관리 변수 및 초기화 함수 추가**
기존 JavaScript 섹션에 다음 코드 추가:

```javascript
// 파일 업로드 관련 변수
let selectedFiles = [];

// 파일 업로드 초기화
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('fileDropZone');
    
    if (fileInput && dropZone) {
        // 파일 선택 시
        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });
        
        // 드래그 앤 드롭 이벤트
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.style.borderColor = '#007bff';
            dropZone.style.backgroundColor = '#f8f9ff';
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dropZone.style.borderColor = '#e9ecef';
            dropZone.style.backgroundColor = 'white';
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.style.borderColor = '#e9ecef';
            dropZone.style.backgroundColor = 'white';
            handleFiles(e.dataTransfer.files);
        });
    }
});

// 파일 처리 함수
function handleFiles(files) {
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // 파일 크기 검증 (50MB)
        if (file.size > 50 * 1024 * 1024) {
            alert(`파일 "${file.name}"이 너무 큽니다. 최대 50MB까지 업로드 가능합니다.`);
            continue;
        }
        
        // 파일 타입 검증
        const allowedTypes = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'ai', 'psd'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExt)) {
            alert(`파일 "${file.name}"은 지원하지 않는 형식입니다.`);
            continue;
        }
        
        selectedFiles.push(file);
    }
    
    updateFileList();
}

// 파일 목록 업데이트
function updateFileList() {
    const filesList = document.getElementById('uploadedFilesList');
    
    if (selectedFiles.length === 0) {
        filesList.innerHTML = '<div class="no-files-message">첨부된 파일이 없습니다.</div>';
        return;
    }
    
    let html = '';
    selectedFiles.forEach((file, index) => {
        const fileSize = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        html += `
            <div class="file-item">
                <div class="file-info">
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${fileSize}</span>
                </div>
                <button type="button" class="btn-remove-file" onclick="removeFile(${index})">삭제</button>
            </div>
        `;
    });
    
    filesList.innerHTML = html;
}

// 파일 삭제
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}
```

#### **3-2. 기존 addToBasket 함수 수정**
기존 addToBasket 함수에서 파일 전송 부분 추가:

```javascript
// 기존 formData 생성 후 다음 코드 추가:

// 선택된 파일들 추가
selectedFiles.forEach((file, index) => {
    formData.append('files[]', file);
});

// 기존 성공 처리 부분에서 메시지 수정:
if (response.success) {
    let message = '장바구니에 추가되었습니다! 🛒';
    if (response.data && response.data.file_count > 0) {
        message += `\n파일 ${response.data.file_count}개도 함께 업로드되었습니다.`;
    }
    alert(message);
    
    // 폼 초기화 시 파일도 초기화
    selectedFiles = [];
    updateFileList();
}
```

---

## 📋 **품목별 적용 체크리스트**

### **적용 전 준비사항:**
- [ ] 해당 품목의 `test_file_integration.php` 실행하여 기반 시스템 확인
- [ ] 기존 `add_to_basket.php`와 `index.php` 파일 백업

### **적용 단계:**
- [ ] **1단계**: `add_to_basket.php` 파일 수정
  - [ ] 파일 관리 헬퍼 포함 추가
  - [ ] 파일 업로드 처리 로직 추가
  - [ ] 품목명 변경 (`generateFileLogInfo('품목명')`)
  
- [ ] **2단계**: `index.php` 파일 수정
  - [ ] HTML 파일 업로드 섹션 추가
  - [ ] CSS 스타일 추가
  
- [ ] **3단계**: JavaScript 기능 추가
  - [ ] 파일 관리 변수 및 함수 추가
  - [ ] 기존 addToBasket 함수 수정

### **적용 후 테스트:**
- [ ] 페이지 로드 확인
- [ ] 파일 업로드 UI 표시 확인
- [ ] 파일 선택/드래그앤드롭 기능 테스트
- [ ] 장바구니 추가 시 파일 업로드 확인
- [ ] 파일이 ImgFolder에 저장되는지 확인

---

## 🔧 **품목별 주의사항**

### **1. 품목명 변경 필수:**
```php
// 각 품목에 맞게 변경
$log_info = generateFileLogInfo('msticker');    // 자석스티커
$log_info = generateFileLogInfo('ncrflambeau'); // 양식지
$log_info = generateFileLogInfo('littleprint'); // 포스터
$log_info = generateFileLogInfo('envelope');    // 봉투
$log_info = generateFileLogInfo('namecard');    // 명함
```

### **2. 폼 ID 확인:**
```javascript
// 각 품목의 폼 ID에 맞게 변경
const form = document.getElementById('mstickerForm');     // 자석스티커
const form = document.getElementById('ncrflambeauForm');  // 양식지
const form = document.getElementById('littleprintForm'); // 포스터
```

### **3. 파일 업로드 섹션 위치:**
- 견적 결과 섹션 다음
- 버튼 섹션 이전
- 각 품목의 레이아웃에 맞게 조정

### **4. 기존 함수명 확인:**
- `addToBasket()` 함수명이 다를 수 있음
- `calculatePrice()` 함수와의 연동 확인
- `window.currentPriceData` 변수 사용 여부 확인

---

## 🧪 **테스트 시나리오**

### **기본 테스트:**
1. 페이지 로드 → 파일 업로드 섹션 표시 확인
2. 파일 선택 → 파일 목록 업데이트 확인
3. 드래그앤드롭 → 시각적 피드백 및 파일 추가 확인
4. 파일 삭제 → 목록에서 제거 확인
5. 견적 계산 → 가격 표시 확인
6. 장바구니 추가 → 파일과 함께 업로드 확인

### **에러 테스트:**
1. 큰 파일 업로드 → 크기 제한 메시지 확인
2. 지원하지 않는 파일 → 형식 오류 메시지 확인
3. 파일 없이 장바구니 추가 → 정상 작동 확인

---

## 📊 **적용 우선순위**

### **1순위 (단순 구조):**
- **msticker** ✅ 완료
- **envelope** - 4단계 드롭다운
- **merchandisebond** - 5단계 드롭다운

### **2순위 (복잡 구조):**
- **ncrflambeau** - 5단계 드롭다운 + 완성도 높음
- **namecard** - 5단계 드롭다운 + 특수 필드

### **3순위 (고급 구조):**
- **littleprint** - 6단계 드롭다운 + 복잡한 로직
- **cadarok** - 4단계 드롭다운 + 페이지 수 계산

---

## 🎯 **성공 기준**

### **기능적 성공:**
- ✅ 파일 업로드 UI가 정상 표시
- ✅ 드래그앤드롭 기능 작동
- ✅ 파일 검증 및 목록 관리 정상
- ✅ 장바구니 추가 시 파일 함께 업로드
- ✅ 파일이 ImgFolder에 저장
- ✅ shop_temp 테이블과 파일 연동

### **사용자 경험:**
- ✅ 직관적인 파일 업로드 인터페이스
- ✅ 실시간 파일 목록 업데이트
- ✅ 명확한 오류 메시지
- ✅ 업로드 완료 피드백

---

## 📚 **참조 파일들**

### **성공 사례:**
- `MlangPrintAuto/msticker/index.php` - 완성된 UI 구조
- `MlangPrintAuto/msticker/add_to_basket.php` - 완성된 백엔드 로직

### **공통 시스템:**
- `MlangPrintAuto/shop/file_management_helper.php` - 파일 관리 함수들
- `MlangPrintAuto/shop/test_file_system.php` - 시스템 테스트

### **가이드 문서:**
- `MlangPrintAuto/파일업로드_시스템_완전정리.md` - 전체 시스템 개요
- `MlangPrintAuto/공통함수_사용가이드.md` - 공통 함수 사용법

---

## 🚀 **다음 단계**

1. **ncrflambeau 적용** - 이미 완성도가 높은 페이지
2. **envelope 적용** - 단순한 구조로 빠른 적용 가능
3. **나머지 품목들 순차 적용**
4. **장바구니 페이지 파일 표시 기능 추가**
5. **주문 시스템과 파일 연동 완성**

---

**이 가이드를 따라하면 모든 품목에 동일한 파일 업로드 기능을 적용할 수 있습니다!** 🎉

**다음 작업**: ncrflambeau 품목부터 이 가이드를 적용해보세요.