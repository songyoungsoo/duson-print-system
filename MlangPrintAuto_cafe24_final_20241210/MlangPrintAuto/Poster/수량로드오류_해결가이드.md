# 🔧 수량 로드 오류 해결 가이드

## 📋 문제 상황
- littleprint 페이지에서 구분 → 종이종류 → 종이규격 선택 후 수량이 로드되지 않는 오류 발생
- JavaScript 콘솔에서 "수량 로드 오류" 메시지 표시

## 🔍 원인 분석

### 1. AJAX 응답 형식 불일치
- `get_quantities.php`: `success_response()` 함수 사용 → `{success: true, data: [...]}` 형식
- `get_paper_types.php`, `get_paper_sizes.php`: `success_response()` 함수 사용
- JavaScript에서 응답 처리 방식이 일관되지 않음

### 2. JavaScript 응답 처리 오류
```javascript
// 잘못된 처리 방식
.then(data => {
    data.forEach(option => { ... }); // data는 {success: true, data: [...]} 형식
});

// 올바른 처리 방식
.then(response => {
    response.data.forEach(option => { ... }); // response.data 사용
});
```

### 3. 이벤트 리스너 누락
- 드롭다운 변경 시 자동으로 수량이 업데이트되지 않음
- 수동으로 함수를 호출해야 하는 불편함

## ✅ 해결 방법

### 1. AJAX 응답 형식 통일
모든 AJAX 파일에서 `success_response()` 함수 사용:

```php
// includes/functions.php에 정의된 공통 함수 사용
function success_response($data = null, $message = '성공') {
    json_response(true, $data, $message);
}

// 각 AJAX 파일에서 사용
mysqli_close($db);
success_response($quantities); // 또는 $options
```

### 2. JavaScript 응답 처리 통일
모든 AJAX 호출에서 일관된 응답 처리:

```javascript
fetch('ajax_file.php?params')
.then(response => response.json())
.then(response => {
    // 성공 여부 확인
    if (!response.success || !response.data) {
        console.error('로드 실패:', response.message);
        return;
    }
    
    // 데이터 처리
    response.data.forEach(option => {
        // 옵션 추가 로직
    });
    
    console.log('업데이트 완료:', response.data.length, '개');
})
.catch(error => {
    console.error('AJAX 오류:', error);
});
```

### 3. 이벤트 리스너 추가
드롭다운 변경 시 자동 업데이트:

```javascript
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('select[name="MY_type"]');
    const paperTypeSelect = document.querySelector('select[name="TreeSelect"]');
    const paperSizeSelect = document.querySelector('select[name="PN_type"]');
    
    // 구분 변경 시
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            changeCategoryType(this.value);
        });
    }
    
    // 종이종류 변경 시
    if (paperTypeSelect) {
        paperTypeSelect.addEventListener('change', function() {
            updateQuantities();
        });
    }
    
    // 종이규격 변경 시
    if (paperSizeSelect) {
        paperSizeSelect.addEventListener('change', function() {
            updateQuantities();
        });
    }
});
```

## 📁 수정된 파일 목록

### 1. `get_quantities.php`
```php
<?php
include "../../includes/functions.php";
include "../../db.php";

check_db_connection($db);
mysqli_set_charset($db, "utf8");

$style = $_GET['style'] ?? '';
$Section = $_GET['Section'] ?? '';
$TreeSelect = $_GET['TreeSelect'] ?? '';

if (empty($style) || empty($Section) || empty($TreeSelect)) {
    error_response('필수 파라미터가 누락되었습니다.');
}

$TABLE = "MlangPrintAuto_littleprint";
$query = "SELECT DISTINCT quantity 
          FROM $TABLE 
          WHERE style='" . mysqli_real_escape_string($db, $style) . "' 
          AND Section='" . mysqli_real_escape_string($db, $Section) . "' 
          AND TreeSelect='" . mysqli_real_escape_string($db, $TreeSelect) . "'
          AND quantity IS NOT NULL 
          ORDER BY CAST(quantity AS UNSIGNED) ASC";

$result = mysqli_query($db, $query);
$quantities = [];

if ($result) {
    while ($row = mysqli_fetch_array($result)) {
        $quantities[] = [
            'value' => $row['quantity'],
            'text' => format_number($row['quantity']) . '매'
        ];
    }
}

mysqli_close($db);
success_response($quantities);
?>
```

### 2. `index.php` JavaScript 부분
- `updatePaperTypes()` 함수 수정
- `updatePaperSizes()` 함수 수정  
- `updateQuantities()` 함수 수정
- 이벤트 리스너 추가

## 🔄 적용 순서 (다른 품목에 적용 시)

### 1단계: 공통 함수 확인
- `includes/functions.php`에 필요한 함수들이 있는지 확인
- `success_response()`, `error_response()`, `format_number()` 등

### 2단계: AJAX 파일 생성/수정
- `get_paper_types.php`
- `get_paper_sizes.php`  
- `get_quantities.php`
- `calculate_price_ajax.php`

### 3단계: JavaScript 함수 구현
- `updatePaperTypes()`
- `updatePaperSizes()`
- `updateQuantities()`
- `calculatePrice()`

### 4단계: 이벤트 리스너 추가
- DOMContentLoaded 이벤트에서 모든 select 요소에 change 이벤트 추가

### 5단계: 테스트 및 디버깅
- 각 AJAX 파일을 직접 URL로 테스트
- 브라우저 개발자 도구에서 네트워크 탭 확인
- 콘솔 로그로 데이터 흐름 확인

## 🚨 주의사항

### 1. 데이터베이스 테이블명 확인
각 품목별로 테이블명이 다름:
- littleprint: `MlangPrintAuto_littleprint`
- namecard: `MlangPrintAuto_namecard`
- envelope: `MlangPrintAuto_envelope`

### 2. 필드명 확인
품목별로 필드명이 다를 수 있음:
- `style`, `Section`, `TreeSelect` 등의 의미와 사용법 확인

### 3. 응답 형식 일관성
- 모든 AJAX 파일에서 동일한 응답 형식 사용
- JavaScript에서도 일관된 방식으로 처리

### 4. 에러 처리
- 필수 파라미터 검증
- 데이터베이스 오류 처리
- JavaScript에서 네트워크 오류 처리

## 📊 테스트 방법

### 1. 직접 URL 테스트
```bash
curl "http://localhost/MlangPrintAuto/littleprint/get_quantities.php?style=590&Section=610&TreeSelect=679"
```

### 2. 브라우저 개발자 도구
- Network 탭에서 AJAX 요청/응답 확인
- Console 탭에서 JavaScript 오류 확인

### 3. 디버그 파일 생성
- 각 단계별로 데이터를 확인할 수 있는 디버그 파일 생성
- 데이터베이스 쿼리 결과 직접 확인

## 📝 체크리스트

- [ ] `includes/functions.php`에 필요한 함수들 정의됨
- [ ] 모든 AJAX 파일이 `success_response()` 사용
- [ ] JavaScript에서 `response.data` 형식으로 처리
- [ ] 드롭다운 변경 시 자동 업데이트 이벤트 추가
- [ ] 에러 처리 및 로깅 구현
- [ ] 각 AJAX 파일 개별 테스트 완료
- [ ] 전체 플로우 테스트 완료

---

**작성일**: 2025년 8월 4일  
**적용 품목**: littleprint (소량포스터)  
**다음 적용 예정**: envelope, msticker, cadarok 등