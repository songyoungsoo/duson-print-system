# 🔧 공통함수 사용 가이드

## 📋 개요
`includes/functions.php`에 정의된 공통함수들을 사용하여 코드 중복을 줄이고 일관성을 유지하는 방법을 설명합니다.

## 📁 파일 위치
- **공통함수 파일**: `includes/functions.php`
- **사용 방법**: 각 PHP 파일 상단에 `include "../../includes/functions.php";` 추가

## 🔧 주요 공통함수 목록

### 1. 응답 관련 함수

#### `success_response($data, $message)`
성공 응답을 JSON 형태로 반환
```php
// 사용 예시
$options = [...]; // 데이터 배열
success_response($options, '조회 성공');

// 출력 결과
{"success":true,"message":"조회 성공","data":[...]}
```

#### `error_response($message, $code)`
오류 응답을 JSON 형태로 반환
```php
// 사용 예시
error_response('필수 파라미터가 누락되었습니다.', 400);

// 출력 결과
{"success":false,"message":"필수 파라미터가 누락되었습니다."}
```

### 2. 데이터베이스 관련 함수

#### `check_db_connection($db)`
데이터베이스 연결 상태 확인
```php
// 사용 예시
include "../../db.php";
check_db_connection($db);
```

#### `getDropdownOptions($db, $table, $where_conditions, $order_by)`
범용 드롭다운 옵션 조회
```php
// 사용 예시
$options = getDropdownOptions($db, 'MlangPrintAuto_transactionCate', [
    'Ttable' => 'LittlePrint',
    'BigNo' => '0'
], 'no ASC');
```

#### `getCategoryOptions($db, $table, $page)`
카테고리 옵션 조회 (BigNo = '0')
```php
// 사용 예시
$categories = getCategoryOptions($db, 'MlangPrintAuto_transactionCate', 'LittlePrint');
```

#### `getPaperTypes($db, $table, $category_no)`
종이종류 옵션 조회 (BigNo 기준)
```php
// 사용 예시
$paper_types = getPaperTypes($db, 'MlangPrintAuto_transactionCate', '590');
```

#### `getPaperSizes($db, $table, $category_no)`
종이규격 옵션 조회 (TreeNo 기준)
```php
// 사용 예시
$paper_sizes = getPaperSizes($db, 'MlangPrintAuto_transactionCate', '590');
```

### 3. 포맷팅 함수

#### `format_number($number)`
숫자에 천단위 콤마 추가
```php
// 사용 예시
echo format_number(1000); // "1,000"
echo format_number(50000); // "50,000"
```

#### `format_price($price)`
가격 포맷팅 (원 단위 추가)
```php
// 사용 예시
echo format_price(15000); // "15,000원"
```

#### `safe_html($text)`
HTML 특수문자 이스케이프
```php
// 사용 예시
echo safe_html($user_input); // XSS 방지
```

### 4. 유틸리티 함수

#### `generateLogInfo()`
로그 정보 생성
```php
// 사용 예시
$log_info = generateLogInfo();
// 결과: ['url' => '...', 'y' => '2025', 'md' => '0804', 'ip' => '...', 'time' => ...]
```

#### `getUserIP()`
사용자 IP 주소 가져오기
```php
// 사용 예시
$user_ip = getUserIP();
```

## 📝 AJAX 파일 표준 템플릿

### 기본 구조
```php
<?php
// 공통 함수 포함
include "../../includes/functions.php";
include "../../db.php";

// 데이터베이스 연결 체크
check_db_connection($db);
mysqli_set_charset($db, "utf8");

// 파라미터 받기 및 검증
$param1 = $_GET['param1'] ?? '';
$param2 = $_GET['param2'] ?? '';

if (empty($param1) || empty($param2)) {
    error_response('필수 파라미터가 누락되었습니다.');
}

// 데이터 조회
$options = getDropdownOptions($db, 'table_name', [
    'field1' => $param1,
    'field2' => $param2
]);

// 연결 종료 및 응답
mysqli_close($db);
success_response($options);
?>
```

### 수량 조회 전용 템플릿
```php
<?php
include "../../includes/functions.php";
include "../../db.php";

check_db_connection($db);
mysqli_set_charset($db, "utf8");

$style = $_GET['style'] ?? '';
$Section = $_GET['Section'] ?? '';
$TreeSelect = $_GET['TreeSelect'] ?? '';

if (empty($style) || empty($Section) || empty($TreeSelect)) {
    error_response('필수 파라미터가 누락되었습니다.');
}

$TABLE = "MlangPrintAuto_[품목명]"; // 품목별 테이블명 변경

$query = "SELECT DISTINCT quantity 
          FROM $TABLE 
          WHERE style='" . mysqli_real_escape_string($db, $style) . "' 
          AND Section='" . mysqli_real_escape_string($db, $Section) . "' 
          AND TreeSelect='" . mysqli_real_escape_string($db, $TreeSelect) . "'
          AND quantity IS NOT NULL 
          ORDER BY CAST(quantity AS UNSIGNED) ASC";

$result = mysqli_query($db, $query);
$quantities = [];

if ($result) {
    while ($row = mysqli_fetch_array($result)) {
        $quantities[] = [
            'value' => $row['quantity'],
            'text' => format_number($row['quantity']) . '매'
        ];
    }
}

mysqli_close($db);
success_response($quantities);
?>
```

## 🔄 JavaScript 표준 응답 처리

### 기본 패턴
```javascript
fetch('ajax_file.php?param1=value1&param2=value2')
.then(response => response.json())
.then(response => {
    // 성공 여부 확인
    if (!response.success || !response.data) {
        console.error('로드 실패:', response.message);
        return;
    }
    
    // 드롭다운 초기화
    selectElement.innerHTML = '';
    
    // 옵션 추가
    response.data.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.no || option.value;
        optionElement.textContent = option.title || option.text;
        selectElement.appendChild(optionElement);
    });
    
    console.log('업데이트 완료:', response.data.length, '개');
})
.catch(error => {
    console.error('AJAX 오류:', error);
    selectElement.innerHTML = '<option value="">로드 오류</option>';
});
```

## 🚨 주의사항

### 1. 함수 중복 정의 방지
```php
// 잘못된 방법 - 함수 재정의
function format_number($number) {
    return number_format($number);
}

// 올바른 방법 - 공통함수 사용
include "../../includes/functions.php";
echo format_number($number);
```

### 2. 일관된 응답 형식 사용
```php
// 잘못된 방법 - 직접 JSON 출력
echo json_encode($data);

// 올바른 방법 - 공통함수 사용
success_response($data);
```

### 3. 에러 처리 표준화
```php
// 잘못된 방법 - 직접 에러 출력
die("오류 발생");

// 올바른 방법 - 공통함수 사용
error_response('오류 발생');
```

## 📊 품목별 적용 현황

### ✅ 적용 완료
- **littleprint**: 모든 AJAX 파일에 공통함수 적용
- **namecard**: 부분 적용 (추가 작업 필요)
- **envelope**: 부분 적용 (추가 작업 필요)

### 🔄 적용 예정
- **msticker**: 미적용
- **cadarok**: 미적용
- **merchandisebond**: 미적용
- **ncrflambeau**: 미적용

## 🔧 새 품목 추가 시 체크리스트

- [ ] `includes/functions.php` 포함
- [ ] `check_db_connection($db)` 사용
- [ ] `success_response()` / `error_response()` 사용
- [ ] `format_number()`, `format_price()` 사용
- [ ] `safe_html()` 사용 (사용자 입력 처리 시)
- [ ] 표준 AJAX 템플릿 사용
- [ ] JavaScript 표준 응답 처리 패턴 사용

## 💡 장점

### 1. 코드 중복 제거
- 동일한 로직을 여러 파일에서 반복 작성할 필요 없음
- 유지보수 시 한 곳만 수정하면 모든 곳에 적용

### 2. 일관성 유지
- 모든 AJAX 응답이 동일한 형식
- JavaScript에서 예측 가능한 응답 처리

### 3. 오류 감소
- 검증된 함수 사용으로 버그 발생 확률 감소
- 표준화된 에러 처리

### 4. 개발 속도 향상
- 템플릿 기반 빠른 개발
- 테스트된 코드 재사용

---

**작성일**: 2025년 8월 4일  
**최종 업데이트**: includes/functions.php v1.0  
**다음 업데이트 예정**: 가격 계산 공통함수 추가