# dsp114.com 테이블과 호환성 유지

## 개요

dsp114.com(PHP 5.2, EUC-KR)에서 dsp1830.shop(PHP 7.4, UTF-8) 및 로컬 개발환경으로 데이터를 마이그레이션하는 과정에서 테이블 구조 호환성을 유지하기 위한 작업 내용입니다.

---

## 마이그레이션 작업 (2025-12-12)

### 작업 대상
- **원본**: dsp114.com `MlangOrder_PrintAuto` 테이블
- **대상**: 로컬 DB + dsp1830.shop `mlangorder_printauto` 테이블
- **데이터 범위**: 주문번호 84228번 이후 (84231 ~ 84285)

### 작업 결과

| 대상 | 삽입된 레코드 | 결과 |
|------|-------------|------|
| 로컬 DB (localhost) | 49개 | ✅ 성공 |
| dsp1830.shop | 49개 | ✅ 성공 |

### 삽입된 데이터 상세
- **시작 번호**: 84231 (84229는 이미 존재, 84230은 원본에 없음)
- **종료 번호**: 84285
- **주문 기간**: 2025-12-03 ~ 2025-12-12

---

## 테이블 구조 차이점

### dsp114.com 테이블 (원본)
```sql
CREATE TABLE MlangOrder_PrintAuto (
  no mediumint(12) unsigned NOT NULL auto_increment,
  Type varchar(250) default NULL,
  ImgFolder text,
  Type_1 text,
  money_1 varchar(20) default NULL,
  money_2 varchar(20) default NULL,
  money_3 varchar(20) default NULL,
  money_4 varchar(20) default NULL,
  money_5 varchar(20) default NULL,
  name varchar(250) default NULL,
  email text,
  zip varchar(10) default NULL,
  zip1 varchar(250) default NULL,
  zip2 varchar(250) default NULL,
  phone varchar(20) default NULL,
  Hendphone varchar(20) default NULL,
  delivery varchar(30) default NULL,
  bizname varchar(50) default NULL,
  bank varchar(30) default NULL,
  bankname varchar(30) default NULL,
  cont text,
  date datetime NOT NULL default '0000-00-00 00:00:00',
  OrderStyle varchar(100) default 'no',
  ThingCate varchar(250) default NULL,
  pass varchar(100) default NULL,
  Gensu int(12) NOT NULL default '0',
  Designer varchar(16) default NULL,
  logen_box_qty int(11) default NULL,
  logen_delivery_fee int(11) default NULL,
  logen_fee_type varchar(10) default NULL,
  PRIMARY KEY (no)
) TYPE=MyISAM;
```

**컬럼 수**: 30개

### dsp1830.shop / 로컬 테이블 (대상)
- **컬럼 수**: 60개+ (추가 기능용 컬럼 포함)
- **테이블명**: `mlangorder_printauto` (소문자)
- **문자셋**: utf8mb4

### 주요 차이점

| 항목 | dsp114.com | dsp1830.shop / 로컬 |
|------|------------|---------------------|
| 테이블명 | `MlangOrder_PrintAuto` | `mlangorder_printauto` |
| 컬럼 수 | 30개 | 60개+ |
| 문자셋 | EUC-KR | UTF-8 (utf8mb4) |
| PHP 버전 | 5.2 | 7.4+ |
| 엔진 | MyISAM | InnoDB |

---

## 호환성 유지를 위한 작업

### 1. 누락 컬럼 추가

dsp114.com에만 있던 logen(로젠택배) 관련 컬럼을 로컬/dsp1830.shop에 추가:

```sql
ALTER TABLE mlangorder_printauto ADD COLUMN logen_box_qty int(11) DEFAULT NULL;
ALTER TABLE mlangorder_printauto ADD COLUMN logen_delivery_fee int(11) DEFAULT NULL;
ALTER TABLE mlangorder_printauto ADD COLUMN logen_fee_type varchar(10) DEFAULT NULL;
```

### 2. 테이블명 매핑

`db.php`의 `safe_mysqli_query()` 함수가 자동으로 테이블명을 매핑:
- `MlangOrder_PrintAuto` → `mlangorder_printauto`

### 3. 문자셋 변환

SQL 파일을 EUC-KR에서 UTF-8로 변환 후 import:
```bash
# 또는 에디터에서 UTF-8로 저장
```

---

## 데이터 마이그레이션 방법

### 1. SQL 파일 준비
dsp114.com phpMyAdmin에서 `MlangOrder_PrintAuto` 테이블 내보내기 후 UTF-8로 변환하여 저장:
```
all_sql/MlangOrder_PrintAuto_114.sql
```

### 2. 마이그레이션 스크립트 실행

```php
<?php
// 원본 컬럼 순서 (30개)
$columns = [
    'no', 'Type', 'ImgFolder', 'Type_1',
    'money_1', 'money_2', 'money_3', 'money_4', 'money_5',
    'name', 'email', 'zip', 'zip1', 'zip2', 'phone', 'Hendphone',
    'delivery', 'bizname', 'bank', 'bankname', 'cont',
    'date', 'OrderStyle', 'ThingCate', 'pass', 'Gensu', 'Designer',
    'logen_box_qty', 'logen_delivery_fee', 'logen_fee_type'
];

// INSERT 문에 컬럼 명시하여 삽입
$column_list = implode(', ', $columns);
$new_insert = "INSERT INTO mlangorder_printauto ($column_list) VALUES ($values)";
```

### 3. 대상별 연결 정보

| 대상 | 호스트 | 사용자 | 비밀번호 | 데이터베이스 |
|------|--------|--------|----------|--------------|
| 로컬 | localhost | dsp1830 | ds701018 | dsp1830 |
| dsp1830.shop | dsp1830.shop | dsp1830 | ds701018 | dsp1830 |
| dsp114.com | localhost | duson1830 | du1830 | duson1830 |

---

## 주의사항

### 1. 테이블명 대소문자
- dsp114.com: `MlangOrder_PrintAuto` (대소문자 혼합)
- 로컬/dsp1830.shop: `mlangorder_printauto` (소문자)
- SQL 파일에서 테이블명 변환 필요: `sed 's/MlangOrder_PrintAuto/mlangorder_printauto/g'`

### 2. 컬럼 수 불일치
- 원본 30개 vs 대상 60개+
- INSERT 시 반드시 컬럼명 명시 필요
- VALUES만 사용하면 "Column count doesn't match" 오류 발생

### 3. 중복 키 처리
- 이미 존재하는 주문번호는 건너뜀
- `Duplicate entry` 오류는 무시 가능

### 4. 인코딩
- 원본 SQL이 EUC-KR인 경우 UTF-8로 변환 필수
- 변환하지 않으면 한글 깨짐 발생

---

## 향후 동기화 계획

### 정기 동기화
1. dsp114.com에서 최신 데이터 내보내기
2. 마지막 동기화 이후 레코드만 추출
3. 로컬 및 dsp1830.shop에 삽입

### 자동화 스크립트 위치
```
/var/www/html/scripts/sync_orders.php
```

---

## 관련 파일

- `/var/www/html/db.php` - DB 연결 및 테이블명 매핑
- `/var/www/html/config.env.php` - 환경별 설정
- `/var/www/html/includes/table_mapper.php` - 테이블명 매핑 함수
- `/var/www/html/all_sql/MlangOrder_PrintAuto_114.sql` - dsp114.com 백업 SQL

---

## 변경 이력

| 날짜 | 작업 내용 | 담당 |
|------|----------|------|
| 2025-12-12 | 84228번 이후 49개 레코드 마이그레이션 | Claude |
| 2025-12-12 | logen 관련 컬럼 3개 추가 (로컬 DB) | Claude |
| 2025-12-12 | 호환성 유지 문서 작성 | Claude |

---

**마지막 업데이트**: 2025-12-12
**작성자**: Claude Code Assistant
