# 전단지 연/매수 표시 시스템

## 📋 개요
전단지는 다른 품목과 달리 **연(ream) 단위**로 주문하며, 1연당 매수가 다양합니다.
- 예: 0.5연 (2,000매), 1연 (4,000매), 1.5연 (6,000매)

이 시스템은 전단지의 수량을 **"0.5연 (2,000매)"** 형식으로 일관되게 표시하고, 단가 계산을 생략하여 공급가액만 표시합니다.

---

## 🎯 핵심 원칙

### 1. 데이터 저장 방식
- **`MY_amount`**: 연수 (0.5, 1, 1.5 등 소수점 포함)
- **`mesu`**: 매수 (2000, 4000, 6000 등 정수)
- **`unit`**: "연"

### 2. 화면 표시 방식
```
수량: 0.5연 (2,000매)
단위: 연
단가: (비어있음 또는 "-")
공급가액: 49,000원
```

### 3. 단가 처리
- **전단지**: 단가를 표시하지 않음 (0.5연 × 98,000원 = 49,000원 같은 혼란 방지)
- **다른 품목**: 단가 = 공급가액 ÷ 수량

---

## 📁 수정된 파일 목록

### 1. 전단지 계산기 (견적서 데이터 전송)
**파일**: `mlangprintauto/inserted/index.php`
**수정 위치**: 812-950번째 줄 (`sendToQuotation()` 함수)

**수정 내용**:
```javascript
// ❌ 이전: 매수(quantityTwo)를 quantity로 전송
const quantityValue = parseInt(myAmountSelect.value) || 1000;  // 1000매

// ✅ 수정: myAmountText에서 연수와 매수를 파싱
const myAmountText = myAmountSelect.options[myAmountSelect.selectedIndex].text;
// "0.5연(2,000매)" → quantity=0.5, mesu=2000

let quantityValue = 1;
let mesuValue = 0;

const reamMatch = myAmountText.match(/([0-9.]+)연/);
if (reamMatch && reamMatch[1]) {
    quantityValue = parseFloat(reamMatch[1]);  // 0.5
}

const mesuMatch = myAmountText.match(/\(([0-9,]+)매\)/);
if (mesuMatch && mesuMatch[1]) {
    mesuValue = parseInt(mesuMatch[1].replace(/,/g, ''));  // 2000
}

// 견적서로 전송
const quotationData = {
    product_name: '전단지',
    product_type: 'inserted',
    quantity: quantityValue,   // 0.5 (연수)
    mesu: mesuValue,           // 2000 (매수)
    unit: '연',
    supply_price: totalPrice
};
```

---

### 2. 견적서 계산기 모달 (폼 필드 입력)
**파일**: `mlangprintauto/quote/includes/calculator_modal.js`
**수정 위치**: 200-350번째 줄 (`fillCurrentRow()` 함수)

**수정 내용**:
```javascript
// 전단지 특수 처리: 규격 문자열에서 연수와 매수 파싱
let displayQuantity = data.quantity || 1;
let displayMesu = parseInt(data.mesu) || 0;

if ((this.productName === '전단지' || data.product_type === 'inserted') && data.specification) {
    const reamMatch = data.specification.match(/([0-9.]+)연/);
    if (reamMatch && reamMatch[1]) {
        displayQuantity = parseFloat(reamMatch[1]);
    }
    
    const mesuMatch = data.specification.match(/\(([0-9,]+)매\)/);
    if (mesuMatch && mesuMatch[1]) {
        displayMesu = parseInt(mesuMatch[1].replace(/,/g, ''));
    }
}

// 수량 입력 필드에 연수 설정
qtyInput.value = displayQuantity;  // 0.5

// 단위 입력 필드에 "연" + 매수 표시
unitInput.value = '연';
if (displayMesu > 0) {
    const mesuDiv = document.createElement('div');
    mesuDiv.textContent = '(' + displayMesu.toLocaleString() + '매)';
    unitInput.parentNode.appendChild(mesuDiv);
}

// ✅ 전단지는 단가를 비움
if (this.productName === '전단지' || data.product_type === 'inserted') {
    priceInput.value = '';
    priceInput.placeholder = '-';
}
```

---

### 3. 견적서 생성 페이지 (PHP 데이터 표시)
**파일**: `mlangprintauto/quote/create.php`

#### 3-1. 장바구니 품목 표시
**수정 위치**: 470-480번째 줄

**수정 내용**:
```php
// 전단지/리플렛: 1연당 매수 표시
$mesu = 0;
if (in_array($productType, ['inserted', 'leaflet'])) {
    $mesu = intval($item['mesu'] ?? 0);
}

// ✅ 단가 계산: 전단지는 단가를 비움
$unitPrice = 0;
if (!in_array($productType, ['inserted', 'leaflet'])) {
    $unitPrice = $qty > 0 ? intval($supply / $qty) : 0;
}
```

#### 3-2. quotation_temp 품목 표시
**수정 위치**: 520-530번째 줄

**수정 내용**: (장바구니와 동일)

#### 3-3. JavaScript 행 계산 함수
**수정 위치**: 815-845번째 줄 (`calculateRow()` 함수)

**수정 내용**:
```javascript
function calculateRow(row) {
    const qty = parseFloat(qtyInput.value) || 0;
    const unitPrice = parseInt(priceInput.value) || 0;
    const unit = unitInput ? unitInput.value : '';

    let supply = 0;
    if (unit === '연') {
        // ✅ 전단지: 공급가를 그대로 사용 (단가 × 수량 계산 안 함)
        supply = parseInt(supplyInput.value) || 0;
    } else {
        // 다른 품목: 수량 × 단가
        supply = Math.round(qty * unitPrice);
        supplyInput.value = supply;
    }

    const vat = Math.round(supply * 0.1);
    const total = supply + vat;
    // ...
}
```

#### 3-4. JavaScript 단가 역계산 함수
**수정 위치**: 840-865번째 줄 (`calculateUnitPrice()` 함수)

**수정 내용**:
```javascript
function calculateUnitPrice(row) {
    const quantity = parseFloat(qtyInput.value) || 0;
    const supplyPrice = parseFloat(supplyInput.value) || 0;
    const unit = unitInput ? unitInput.value : '';

    // ✅ 전단지(연 단위)는 단가 계산 안 함
    if (unit !== '연' && quantity > 0) {
        const unitPrice = Math.floor(supplyPrice / quantity);
        priceInput.value = unitPrice;
    }
    // ...
}
```

---

## 🔄 데이터 흐름

### 1. 전단지 계산기 → 견적서
```
사용자 선택: "0.5연(2,000매)" 드롭다운
    ↓
sendToQuotation() 함수에서 파싱
    ↓ quantity: 0.5, mesu: 2000, unit: '연'
postMessage로 부모창 전송
    ↓
calculator_modal.js의 fillCurrentRow()에서 수신
    ↓
견적서 폼 필드에 입력
    - 수량: 0.5
    - 단위: 연 (2,000매)
    - 단가: (비어있음)
    - 공급가액: 49,000원
```

### 2. 장바구니 → 견적서
```
shop_temp 테이블
    - MY_amount: 0.5 (연수)
    - mesu: 2000 (매수)
    ↓
create.php에서 조회
    ↓
ProductSpecFormatter::getQuantity() → 0.5
ProductSpecFormatter::getUnit() → "연"
$mesu = intval($item['mesu']) → 2000
    ↓
HTML 출력
    - 수량 입력: 0.5
    - 단위 입력: 연
    - 단위 아래 표시: (2,000매)
    - 단가 입력: (비어있음)
```

---

## 📊 데이터베이스 구조

### shop_temp / quotation_temp / mlangorder_printauto
```sql
MY_amount VARCHAR  -- 연수 (0.5, 1, 1.5 등)
mesu      VARCHAR  -- 매수 (2000, 4000, 6000 등)
unit      VARCHAR  -- 단위 ("연")
st_price  INT      -- 공급가액 (49000)
```

---

## 🎨 화면 표시 예시

### 견적서 생성 페이지
```
┌────┬────────┬──────────────┬──────────────┬────────┬──────┬──────────┬────────┬──────────┐
│ NO │  품명  │   규격/사양  │     수량     │  단위  │ 단가 │ 공급가액 │  VAT   │   합계   │
├────┼────────┼──────────────┼──────────────┼────────┼──────┼──────────┼────────┼──────────┤
│ 1  │ 전단지 │ 칼라/아트지/ │     0.5      │   연   │      │  49,000  │ 4,900  │  53,900  │
│    │        │ A4/단면      │              │(2,000매)│      │          │        │          │
└────┴────────┴──────────────┴──────────────┴────────┴──────┴──────────┴────────┴──────────┘
```

### 장바구니
```
📄 전단지
상품번호: #696
색상: 칼라인쇄(CMYK)
종류: 100g아트지
규격: A4 (210x297)
인쇄: 단면
타입: 인쇄만

0.5연 (2,000매)

부가세별도 49,000원
부가세포함 53,900원
```

---

## ⚠️ 주의사항

### 1. 전단지 판별 조건
다음 조건 중 하나라도 만족하면 전단지로 판별:
- `product_type === 'inserted'`
- `unit === '연'`
- `productName === '전단지'`

### 2. 소수점 수량 처리
```javascript
// 0.5 → "0.5"
// 1.0 → "1"
// 1.5 → "1.5"
const qtyDisplay = (qty == Math.floor(qty)) 
    ? parseInt(qty) 
    : parseFloat(qty.toFixed(2)).toString().replace(/\.?0+$/, '');
```

### 3. 매수 표시 형식
```javascript
// 2000 → "2,000매"
// 4000 → "4,000매"
const mesuDisplay = displayMesu.toLocaleString() + '매';
```

---

## 🔧 추가 적용 필요 파일 (향후 작업)

### 1. 견적서 상세/PDF 출력
- `mlangprintauto/quote/view.php`
- `mlangprintauto/quote/pdf.php`

### 2. 견적서 이메일 발송
- `mlangprintauto/quote/send_email.php`

### 3. 관리자 주문 상세
- `admin/mlangprintauto/admin.php` (OrderView 모드)

### 4. 주문서 출력
- `mlangorder_printauto/OrderFormOrderTree.php` (이미 구현됨)

---

## 📝 테스트 체크리스트

- [ ] 전단지 계산기에서 "✅ 견적서에 적용" 클릭 시 연수/매수 정상 전송
- [ ] 견적서 생성 페이지에서 "0.5연 (2,000매)" 형식으로 표시
- [ ] 전단지 단가 필드가 비어있거나 "-" 표시
- [ ] 전단지 공급가액 변경 시 단가 역계산 안 됨
- [ ] 다른 품목(명함, 봉투 등)은 단가 정상 계산
- [ ] 장바구니에서 견적서로 불러올 때 정상 표시
- [ ] 소수점 수량 (0.5, 1.5 등) 정상 처리

---

## 📅 작업 이력

### 2024-12-08
- 전단지 계산기 `sendToQuotation()` 함수 수정 (매수 → 연수 파싱)
- `calculator_modal.js` 전단지 단가 비우기 로직 추가
- `create.php` 전단지 단가 계산 제외 로직 추가
- JavaScript 행 계산/단가 역계산 함수 전단지 예외 처리

---

## 🎯 결론

이 시스템을 통해:
1. ✅ 전단지 수량이 "0.5연 (2,000매)" 형식으로 일관되게 표시
2. ✅ 혼란스러운 단가(98,000원) 표시 제거
3. ✅ 공급가액만 명확하게 표시
4. ✅ 장바구니, 견적서, 주문서 전체 시스템 통일

**핵심**: 전단지는 `unit === '연'` 조건으로 판별하여 특수 처리!
