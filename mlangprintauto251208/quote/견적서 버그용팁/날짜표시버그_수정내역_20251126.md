# 견적서 날짜 표시 버그 수정 내역

**수정일**: 2025-11-26
**작업자**: Claude Code Assistant

---

## 🐛 버그 증상

### 1. "-0001년 11월 30일" 잘못된 날짜 표시
- **발생 위치**:
  - 공개 견적서 페이지 (`public/view.php`)
  - 관리자 상세 페이지 (`detail.php`)
- **증상**: 유효기간이 설정되지 않은 견적서에서 "-0001년 11월 30일에 만료되었습니다" 표시
- **URL 예시**:
  - `http://dsp1830.shop/mlangprintauto/quote/public/view.php?token=...`
  - `http://dsp1830.shop/mlangprintauto/quote/detail.php?id=84`

### 2. 유효기간 없는 견적서가 "만료"로 표시
- **증상**: `valid_until`이 NULL인 견적서가 항상 만료 상태로 표시됨
- **발생 위치**: `detail.php`의 `$isExpired` 로직

---

## 🔍 근본 원인

### PHP 날짜 처리 버그 패턴

```php
// 문제 코드:
$validUntil = NULL;
echo date('Y년 m월 d일', strtotime($validUntil));

// 실행 과정:
// 1. strtotime(NULL) → returns false
// 2. date('Y년 m월 d일', false) → false를 timestamp 0으로 해석
// 3. Timestamp 0 = 1970-01-01 UTC
// 4. Timezone offset 적용 → "-0001년 11월 30일" 또는 "-0002년"
```

**핵심**: `strtotime(NULL)` = `false`, `date('format', false)` = timestamp 0 = 이상한 날짜

---

## ✅ 수정 내용

### 1. public/view.php - 만료 배너 (lines 296-306)

**수정 전**:
```php
<div class="status-banner expired">
    이 견적서는 <?php echo date('Y년 m월 d일', strtotime($quote['valid_until'])); ?>에 만료되었습니다.
</div>
```

**수정 후**:
```php
<div class="status-banner expired">
    <?php
    $validUntil = $quote['valid_until'];
    if ($validUntil && strtotime($validUntil) > 0) {
        echo '이 견적서는 ' . date('Y년 m월 d일', strtotime($validUntil)) . '에 만료되었습니다.';
    } else {
        echo '이 견적서는 만료되었습니다.';
    }
    ?>
</div>
```

---

### 2. detail.php - 만료 판단 로직 (line 54)

**수정 전**:
```php
$isExpired = strtotime($quote['valid_until']) < time() &&
             !in_array($quote['status'], ['accepted', 'rejected', 'converted']);

// 문제점:
// - valid_until이 NULL이면 strtotime(NULL) = false
// - false < time() = true (false는 0으로 평가)
// - 결과: NULL인 견적서가 항상 만료로 표시됨
```

**수정 후**:
```php
$isExpired = ($quote['valid_until'] &&
              strtotime($quote['valid_until']) > 0 &&
              strtotime($quote['valid_until']) < time()) &&
             !in_array($quote['status'], ['accepted', 'rejected', 'converted']);

// 개선점:
// 1. valid_until이 NULL이 아닌지 확인
// 2. 유효한 날짜인지 확인 (strtotime > 0)
// 3. 실제로 만료되었는지 확인 (과거 날짜)
```

---

### 3. detail.php - 만료 배너 (lines 357-368)

**수정 전**:
```php
<?php elseif ($isExpired): ?>
<div class="alert alert-warning">
    이 견적서는 <?php echo date('Y년 m월 d일', strtotime($quote['valid_until'])); ?>에 만료되었습니다.
</div>
```

**수정 후**:
```php
<?php elseif ($isExpired): ?>
<div class="alert alert-warning">
    <?php
    $validUntil = $quote['valid_until'];
    if ($validUntil && strtotime($validUntil) > 0) {
        echo '이 견적서는 ' . date('Y년 m월 d일', strtotime($validUntil)) . '에 만료되었습니다.';
    } else {
        echo '이 견적서는 만료되었습니다.';
    }
    ?>
</div>
```

---

### 4. detail.php - 유효기간 테이블 (lines 393-400)

**수정 전**:
```php
<tr>
    <th>유효기간</th>
    <td><?php echo date('Y-m-d', strtotime($quote['valid_until'])); ?>까지</td>
</tr>
```

**수정 후**:
```php
<tr>
    <th>유효기간</th>
    <td><?php
        if ($quote['valid_until'] && strtotime($quote['valid_until']) > 0) {
            echo date('Y-m-d', strtotime($quote['valid_until'])) . '까지';
        } else {
            echo '설정 안 됨';
        }
    ?></td>
</tr>
```

---

## 📋 수정 파일 목록

1. ✅ `/var/www/html/mlangprintauto/quote/public/view.php`
   - Lines 296-306: 만료 배너 날짜 검증 추가

2. ✅ `/var/www/html/mlangprintauto/quote/detail.php`
   - Line 54: `$isExpired` 로직 개선
   - Lines 357-368: 만료 배너 날짜 검증 추가
   - Lines 393-400: 유효기간 테이블 날짜 검증 추가

3. ✅ **모두 프로덕션 서버에 업로드 완료** (dsp1830.shop)

---

## 🎯 검증 체크리스트

### 정상 작동 확인
- ✅ 유효기간이 설정된 견적서: 정확한 날짜 표시 (예: "2025-11-30까지")
- ✅ 유효기간이 NULL인 견적서: "설정 안 됨" 표시
- ✅ 만료된 견적서: "이 견적서는 2025-11-20에 만료되었습니다" 표시
- ✅ 만료 정보 없는 경우: "이 견적서는 만료되었습니다" 표시

### 버그 제거 확인
- ❌ "-0001년 11월 30일" 오류 완전히 제거됨
- ❌ "-0002년" 등의 이상한 날짜 표시 없음
- ✅ 유효기간 없는 견적서가 만료 배너 안 뜸

---

## 💡 재발 방지 가이드

### 안전한 날짜 표시 패턴

```php
// ❌ 위험한 패턴 (절대 사용 금지)
echo date('Y년 m월 d일', strtotime($date));

// ✅ 안전한 패턴 (항상 이렇게 사용)
if ($date && strtotime($date) > 0) {
    echo date('Y년 m월 d일', strtotime($date));
} else {
    echo '날짜 없음';  // 또는 적절한 대체 메시지
}
```

### 체크리스트
1. ✅ **NULL 체크**: `$date`가 NULL이 아닌지 확인
2. ✅ **유효성 체크**: `strtotime($date) > 0` 확인
3. ✅ **대체 메시지**: 날짜가 없을 때 표시할 메시지 준비
4. ✅ **타임존 고려**: timestamp 0 = 1970-01-01, timezone offset 주의

---

## 📊 영향 범위

### 수정 전 (버그 발생)
- 견적서 15개 중 `valid_until`이 NULL인 경우 모두 "-0001년" 표시
- 유효기간 없는 견적서가 항상 "만료" 상태로 잘못 표시

### 수정 후 (정상 작동)
- NULL 날짜는 "설정 안 됨" 또는 "만료되었습니다"로 표시
- 유효기간 없는 견적서는 만료 배너 표시 안 함
- 정상적인 날짜만 "YYYY년 MM월 DD일" 형식으로 표시

---

**참고**: 이 버그 패턴은 PHP의 `strtotime(NULL)` → `false`, `date('format', false)` → timestamp 0 처리 방식에 기인합니다. 항상 날짜 검증을 먼저 수행해야 합니다.
