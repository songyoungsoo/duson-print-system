# 테스트 의존성 분석 및 병렬 그룹화

## 🎯 병렬화 핵심 원칙

### ✅ 병렬 실행 가능
- 상태 공유 없음 (독립적인 브라우저 컨텍스트)
- 서로 다른 DB 레코드 접근
- 읽기 전용 작업
- 서로 다른 세션/파일 경로 사용

### ❌ 순차 실행 필요
- 이전 단계 결과에 의존 (예: 로그인 → 조회 → 수정)
- 동일 DB 레코드 변경
- 공유 세션/쿠키 사용
- 동일 파일 경로 접근

---

## 📊 그룹화 전략 요약

| 그룹 | 병렬도 | 워커 수 | 의존성 유형 | 실행 시간 |
|------|--------|---------|-------------|-----------|
| **🟢 Group A** | 최대 | 11 | 없음 (읽기 전용) | ~2분 |
| **🟡 Group B** | 최대 | 11 | 없음 (계산만) | ~2분 |
| **🟠 Group C** | 제한 | 5 | 세션 격리 | ~3분 |
| **🔴 Group D** | 제품별 | 3 | 단계별 순차 | ~5분 |
| **🔵 Group E** | 순차 | 1 | 세션 공유 | ~2분 |

**총 실행 시간**: ~8분 (순차 대비 70% 감소)

---

## 🟢 Group A: 읽기 전용 테스트 (최대 병렬)

### 특징
- ✅ DB 읽기만 수행
- ✅ 파일 시스템 읽기만 수행
- ✅ 상태 변경 없음
- ✅ 완전 독립적 실행

### 병렬 가능 이유
같은 페이지를 테스트하더라도 **서로 다른 검증 항목**을 확인하므로 독립적:

```yaml
예시_1_병렬_가능:
  테스트_A: 전단지_페이지_로딩 → 제목, 가격표 검증
  테스트_B: 전단지_갤러리_표시 → 썸네일, 버튼 검증
  테스트_C: 전단지_옵션_목록 → 드롭다운 검증

  이유: 같은 URL(/mlangprintauto/inserted/)이지만
       서로 다른 DOM 요소를 읽기만 함
       상태 변경 없음
```

### 테스트 목록 (33개)

#### A-1: 페이지 로딩 (11개 병렬)
```
전단지, 명함, 봉투, 스티커, 자석스티커, 카다록,
포스터, 상품권, 양식지, 리플렛 페이지 로딩
```

#### A-2: 갤러리 표시 (11개 병렬)
```
각 제품별 갤러리 이미지, 라이트박스 검증
```

#### A-3: 옵션 목록 (11개 병렬)
```
각 제품별 드롭다운, 입력 필드 검증
```

### 파일 구조
```
tests/group-a-readonly/
├── page-loading.group-a.spec.ts      # 11개 테스트
├── gallery-display.group-a.spec.ts   # 11개 테스트
└── option-lists.group-a.spec.ts      # 11개 테스트
```

### 실행 예시
```bash
# 33개 테스트가 11개 워커로 병렬 실행
npx playwright test --grep="group-a" --workers=11
```

---

## 🟡 Group B: 가격 계산 테스트 (최대 병렬)

### 특징
- ✅ AJAX 호출만 수행 (calculate_price_ajax.php)
- ✅ DB 읽기만 수행 (가격표 조회)
- ✅ 상태 변경 없음
- ✅ 제품별 독립적

### 병렬 가능 이유
```yaml
예시_2_병렬_가능:
  테스트_A: 전단지_기본_가격_계산 → AJAX → DB 읽기
  테스트_B: 명함_기본_가격_계산 → AJAX → DB 읽기
  테스트_C: 전단지_코팅_가격_계산 → AJAX → DB 읽기

  이유: 각 AJAX 요청은 독립적
       DB 읽기만 수행 (INSERT/UPDATE 없음)
       서로 다른 product_code 사용
```

### 테스트 목록 (22개)

#### B-1: 기본 가격 계산 (11개 병렬)
```
각 제품별 기본 옵션 가격 계산 및 검증
```

#### B-2: 추가 옵션 가격 (11개 병렬)
```
코팅, 오시, 접지, 테이프 등 추가 옵션 가격 검증
```

### 파일 구조
```
tests/group-b-calculation/
├── basic-price.group-b.spec.ts       # 11개 테스트
└── option-price.group-b.spec.ts      # 11개 테스트
```

---

## 🟠 Group C: 단일 기능 테스트 (제한 병렬)

### 특징
- ⚠️ 세션 스토리지 사용 (파일 업로드)
- ⚠️ 임시 파일 생성
- ✅ DB 변경 없음 (아직 주문 전)
- ✅ 제품별 독립 세션

### 병렬 가능 조건
```yaml
예시_3_조건부_병렬:
  테스트_A: 전단지_파일_업로드
    세션: session_flyer_1
    파일: /tmp/test_flyer_001.pdf

  테스트_B: 명함_파일_업로드
    세션: session_namecard_1
    파일: /tmp/test_namecard_001.jpg

  이유: 독립 세션 + 서로 다른 파일 경로
       5개로 제한하는 이유: 디스크 I/O 부하
```

### 순차 실행 필요한 경우
```yaml
예시_4_순차_필요:
  테스트_A: 동일_세션_파일_업로드
    단계_1: 파일1 업로드 → 세션에 저장
    단계_2: 파일2 추가 업로드 → 이전 세션 필요
    단계_3: 파일 목록 확인 → 이전 단계 결과 의존

  이유: 단계별 의존성 존재
```

### 테스트 목록 (22개)

#### C-1: 파일 업로드 (5개 워커로 병렬)
```
제품별 파일 업로드, 독립 세션 사용
```

#### C-2: 옵션 변경 인터랙션 (11개 병렬)
```
드롭다운 변경 시 UI 업데이트 검증 (클라이언트 상태만)
```

### 파일 구조
```
tests/group-c-features/
├── file-upload.group-c.spec.ts       # 독립 세션 사용
└── option-interaction.group-c.spec.ts # 클라이언트만
```

---

## 🔴 Group D: E2E 플로우 (제품별 순차, 제품 간 병렬)

### 특징
- ❌ 시나리오 내부는 순차 의존
- ✅ 제품 간은 병렬 가능
- ⚠️ DB INSERT/UPDATE 발생
- ⚠️ 세션 공유 (8단계 전체)

### 병렬 구조
```yaml
병렬_전략:
  동시_실행_제품: 3개 (리소스 고려)

  워커_1:
    전단지_E2E: [단계1→2→3→4→5→6→7→8] 순차

  워커_2:
    명함_E2E: [단계1→2→3→4→5→6→7→8] 순차

  워커_3:
    봉투_E2E: [단계1→2→3→4→5→6→7→8] 순차

  이유: 각 제품은 독립 DB 레코드 생성
       제품 간 충돌 없음
```

### 순차 실행 이유
```yaml
예시_5_순차_의존성:
  전단지_E2E_플로우:
    단계_1: 제품_선택 → 가격 확인
    단계_2: 옵션_추가 → 단계1 선택 필요
    단계_3: 파일_업로드 → 단계2 완료 필요
    단계_4: 장바구니_추가 → DB INSERT (shop_temp)
    단계_5: 장바구니_확인 → 단계4 INSERT 결과 필요
    단계_6: 주문서_작성 → 단계5 데이터 필요
    단계_7: 주문_제출 → DB INSERT (mlangorder_printauto)
    단계_8: 주문_완료_확인 → 단계7 INSERT 결과 필요

  이유: 각 단계가 이전 단계 결과에 의존
       동일 세션/쿠키 공유
       DB 트랜잭션 순서 보장 필요
```

### 테스트 목록 (11개 제품 × 8단계)

#### D-1 ~ D-11: 제품별 E2E
```
각 제품별 전체 주문 플로우 (선택→옵션→업로드→장바구니→주문→완료)
```

### 파일 구조
```
tests/group-d-e2e/
├── flyer-e2e.group-d.spec.ts         # 순차
├── namecard-e2e.group-d.spec.ts      # 순차
├── envelope-e2e.group-d.spec.ts      # 순차
└── ...                                # 나머지 8개
```

### 실행 예시
```bash
# 3개 제품 E2E가 동시 실행, 각 제품 내부는 순차
npx playwright test --grep="group-d" --workers=3
```

---

## 🔵 Group E: 관리자 기능 (순차 실행)

### 특징
- ❌ 완전 순차 실행 필요
- ❌ 인증 세션 공유
- ❌ 단계별 의존성

### 순차 실행 이유
```yaml
예시_6_세션_공유:
  관리자_워크플로우:
    단계_1: 로그인 → 세션 생성 (쿠키)
    단계_2: 주문_조회 → 단계1 세션 필요
    단계_3: 상세_확인 → 단계2 세션 필요
    단계_4: 파일_다운로드 → 단계3 세션 필요

  이유: 모든 단계가 동일 인증 세션 사용
       병렬 불가능 (세션 충돌)
```

### 테스트 목록 (4단계)
```
로그인 → 주문 조회 → 상세 확인 → 파일 다운로드
```

### 파일 구조
```
tests/group-e-admin/
└── admin-workflow.group-e.spec.ts    # 순차 전용
```

---

## 📋 의존성 매트릭스

### 리소스 사용 현황

| 그룹 | DB 읽기 | DB 쓰기 | 파일 읽기 | 파일 쓰기 | 세션 | 병렬도 |
|------|:-------:|:-------:|:---------:|:---------:|:----:|:------:|
| A-1  | ✅ | ❌ | ❌ | ❌ | ❌ | **11** |
| A-2  | ✅ | ❌ | ✅ | ❌ | ❌ | **11** |
| A-3  | ✅ | ❌ | ❌ | ❌ | ❌ | **11** |
| B-1  | ✅ | ❌ | ❌ | ❌ | ❌ | **11** |
| B-2  | ✅ | ❌ | ❌ | ❌ | ❌ | **11** |
| C-1  | ❌ | ❌ | ❌ | ✅ | ✅ | **5** |
| C-2  | ❌ | ❌ | ❌ | ❌ | ❌ | **11** |
| D-*  | ✅ | ✅ | ✅ | ✅ | ✅ | **3** |
| E-1  | ✅ | ❌ | ✅ | ❌ | ✅ | **1** |

### 충돌 가능성 분석

| 테스트 조합 | 충돌 여부 | 이유 |
|------------|:--------:|------|
| A-1 ∥ A-2 | ✅ 안전 | 서로 다른 DOM 요소 검증 |
| A-1 ∥ B-1 | ✅ 안전 | 읽기 vs 계산 (DB 읽기만) |
| B-1 ∥ B-2 | ✅ 안전 | 서로 다른 제품/옵션 |
| C-1 ∥ C-1 | ⚠️ 제한 | 파일 I/O 부하 (5개로 제한) |
| D-1 ∥ D-2 | ✅ 안전 | 독립 DB 레코드 |
| D-1 내부 | ❌ 충돌 | 순차 의존성 |
| E-1 내부 | ❌ 충돌 | 세션 공유 |

---

## 🚀 최적화된 실행 전략

### 전략 1: 최대 병렬화 (빠른 피드백)
```bash
# 1단계: 읽기 전용 + 계산 (33 + 22 = 55개 동시)
npx playwright test --grep="group-[ab]" --workers=11

# 2단계: 기능 테스트 (22개, 일부 제한)
npx playwright test --grep="group-c" --workers=5

# 3단계: E2E (3개 제품 동시)
npx playwright test --grep="group-d" --workers=3

# 4단계: 관리자 (순차)
npx playwright test --grep="group-e" --workers=1
```

**예상 시간**: 2분 + 3분 + 5분 + 2분 = **12분**

### 전략 2: 하이브리드 (권장, 리소스 균형)
```bash
# 모든 그룹을 한 번에 실행, Playwright가 자동 조정
npx playwright test --workers=10

# 각 프로젝트는 독립적으로 워커 수 조정:
# - Group A, B: 11개 워커
# - Group C: 5개 워커
# - Group D: 3개 워커
# - Group E: 1개 워커
```

**예상 시간**: **~8분** (병렬 최적화)

### 전략 3: CI/CD 환경 (안정성 우선)
```bash
# GitHub Actions, GitLab CI 등
CI=true npx playwright test --workers=5 --retries=2
```

**예상 시간**: **~15분** (재시도 포함)

---

## 🎯 핵심 규칙 요약

### 1️⃣ 같은 페이지, 다른 기능 → 병렬 가능
```
✅ 전단지_페이지_로딩 ∥ 전단지_갤러리_표시
   이유: 같은 URL이지만 서로 다른 DOM 검증
```

### 2️⃣ 같은 기능, 다른 제품 → 병렬 가능
```
✅ 전단지_가격_계산 ∥ 명함_가격_계산
   이유: 서로 다른 product_code, 독립 AJAX
```

### 3️⃣ 읽기만 하면 → 최대 병렬
```
✅ 모든 Group A, B 테스트
   이유: DB/파일 변경 없음
```

### 4️⃣ 쓰기 있어도 독립적이면 → 제한 병렬
```
⚠️ 파일_업로드 (독립 세션 + 다른 파일명)
   이유: 리소스 부하만 고려, 5개로 제한
```

### 5️⃣ 단계별 의존성 → 순차 실행
```
❌ E2E 플로우 내부 (단계1→2→3→...)
   이유: 이전 단계 결과 필요
```

### 6️⃣ 세션 공유 → 순차 실행
```
❌ 관리자 워크플로우 (로그인→조회→...)
   이유: 동일 인증 세션 사용
```

---

## 📊 성능 벤치마크

### 순차 실행 (worst case)
```
33 (Group A) + 22 (Group B) + 22 (Group C) +
11×8분 (Group D) + 2분 (Group E) = ~90분
```

### 병렬 실행 (best case)
```
2분 (Group A,B) + 3분 (Group C) +
5분 (Group D, 3개 동시) + 2분 (Group E) = ~12분
```

### 하이브리드 (권장)
```
병렬 최적화 + 리소스 균형 = ~8분
```

**개선율**: 순차 대비 **88% 시간 단축** ⚡

---

## ✅ 체크리스트

병렬 실행 전 확인사항:

- [ ] 각 테스트는 독립 브라우저 컨텍스트 사용
- [ ] E2E 테스트는 고유 주문 ID 생성 (타임스탬프/UUID)
- [ ] 업로드 파일명에 테스트 ID 포함
- [ ] DB 트랜잭션 격리 수준 확인
- [ ] 로컬: 10-11개 워커, CI: 5개 워커
- [ ] 재시도 전략 설정 (CI: 2회)
- [ ] 타임아웃 적절히 설정 (Group D: 60초)

---

*Last Updated: 2025-01-03*
*Based on: TEST_PARALLELIZATION_PLAN.md*
