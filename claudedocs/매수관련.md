# 매수(연수) 표시 관련 수정 작업

**작업일**: 2025-12-10
**작업자**: Claude Code Assistant

---

## 1. 문제 요약

### 1.1 봉투 재질 미표시
- **증상**: "소봉투 / / 1,000매" - 재질 부분이 비어있음
- **원인**: 봉투는 `Section` 필드에 재질+사이즈 저장, 코드는 `PN_type` 검색
- **해결**: `getElementById('Section')` 사용하도록 수정

### 1.2 견적서 매수 미표시
- **증상**: "0.5 연" 뒤에 "(2,000매)" 표시 안됨, 단가 0원
- **원인**: `source_data` JSON에 mesu가 저장되지 않음
- **해결**: QuoteManager에서 source_data에 mesu 포함하여 저장

### 1.3 관리자 페이지 수량 "1" 표시
- **증상**: 수량이 "0.5"가 아닌 "1"로 표시
- **원인**: JSON에 `quantity: "0.50"` 저장, 코드는 `MY_amount` 검색
- **해결**: `quantity` 필드도 함께 확인하도록 수정

---

## 2. 수정 파일 목록

| 파일 | 수정 내용 |
|------|----------|
| `mlangprintauto/envelope/index.php` | Section 필드 사용하도록 수정 |
| `mlangprintauto/quote/includes/ProductSpecFormatter.php` | formatEnvelope에서 Section 우선 확인 |
| `mlangprintauto/quote/includes/QuoteManager.php` | addItemFromQuoteTemp, addManualItem에서 source_data 저장 |
| `mlangprintauto/quote/includes/calculator_modal.js` | mesu, product_type, source_type hidden 필드 추가 |
| `mlangprintauto/quote/detail.php` | inserted/leaflet 매수 표시 로직 |
| `mlangprintauto/quote/api/generate_pdf.php` | PDF 매수 표시 로직 |
| `mlangprintauto/quote/api/save.php` | 에러 핸들링 추가 |
| `mlangorder_printauto/OrderFormOrderTree.php` | quantity 필드 확인 추가 |

---

## 3. 상세 수정 내용

### 3.1 봉투 index.php (envelope/index.php)

**변경 전:**
```javascript
const pnTypeSelect = document.getElementById('PN_type');
const pnTypeText = pnTypeSelect ? pnTypeSelect.options[pnTypeSelect.selectedIndex].text : '';
```

**변경 후:**
```javascript
const sectionSelect = document.getElementById('Section');  // 재질+사이즈
const sectionText = sectionSelect ? sectionSelect.options[sectionSelect.selectedIndex].text : '';
```

### 3.2 QuoteManager.php - addItemFromQuoteTemp

**추가된 코드:**
```php
// source_data에 원본 데이터 저장 (mesu 포함)
$sourceData = json_encode($tempItem, JSON_UNESCAPED_UNICODE);

$query = "INSERT INTO quote_items (..., source_data, notes) VALUES (...)";
```

### 3.3 QuoteManager.php - addManualItem

**추가된 코드:**
```php
// mesu 처리
$mesu = intval($item['mesu'] ?? 0);

// 전단지 단가 계산 (mesu 기준)
if (in_array($productType, ['inserted', 'leaflet']) && $mesu > 0) {
    $unitPrice = round($supplyPrice / $mesu, 1);
}

// source_data에 mesu 저장
$sourceDataArray = [
    'mesu' => $mesu,
    'product_type' => $productType,
    'source_type' => $item['source_type'] ?? 'manual'
];
$sourceData = json_encode($sourceDataArray, JSON_UNESCAPED_UNICODE);
```

### 3.4 calculator_modal.js - Hidden 필드 추가

```javascript
// mesu hidden field
let mesuInput = row.querySelector('input[name*="[mesu]"]');
if (!mesuInput && displayMesu > 0) {
    mesuInput = document.createElement('input');
    mesuInput.type = 'hidden';
    mesuInput.name = `items[${itemIndex}][mesu]`;
    row.appendChild(mesuInput);
}
if (mesuInput) mesuInput.value = displayMesu;

// product_type hidden field
let productTypeInput = row.querySelector('input[name*="[product_type]"]');
if (!productTypeInput) {
    productTypeInput = document.createElement('input');
    productTypeInput.type = 'hidden';
    productTypeInput.name = `items[${itemIndex}][product_type]`;
    row.appendChild(productTypeInput);
}
productTypeInput.value = productType;

// source_type hidden field
let sourceTypeInput = row.querySelector('input[name*="[source_type]"]');
if (!sourceTypeInput) {
    sourceTypeInput = document.createElement('input');
    sourceTypeInput.type = 'hidden';
    sourceTypeInput.name = `items[${itemIndex}][source_type]`;
    row.appendChild(sourceTypeInput);
}
sourceTypeInput.value = 'calculator';
```

### 3.5 OrderFormOrderTree.php - quantity 필드 확인

**변경 전:**
```php
if ($is_flyer && isset($json_data['MY_amount']) && floatval($json_data['MY_amount']) > 0) {
    $quantity_num = floatval($json_data['MY_amount']);
    $unit = '연';
}
```

**변경 후:**
```php
// 전단지/리플렛: quantity 또는 MY_amount 필드에서 연수 추출
$flyer_quantity = $json_data['quantity'] ?? $json_data['MY_amount'] ?? null;
if ($is_flyer && $flyer_quantity !== null && floatval($flyer_quantity) > 0) {
    $quantity_num = floatval($flyer_quantity);
    $unit = '연';
}
```

---

## 4. 데이터 구조

### 4.1 Type_1 JSON (mlangorder_printauto 테이블)

```json
{
  "product_type": "inserted",
  "MY_type": "802",
  "MY_Fsd": "626",
  "PN_type": "821",
  "POtype": "1",
  "quantity": "0.50",       // ← 연수 (소수점)
  "mesu": "2000",           // ← 매수 (정수)
  "unit": "연",
  "ordertype": "print",
  "formatted_display": "인쇄색상: 칼라(CMYK)\n용지: 90g아트지(합판전단)\n규격: A4 (210x297)\n인쇄면: 단면\n수량: 0.50연 (2,000매)\n디자인: 인쇄만",
  "created_at": "2025-12-10 20:49:48"
}
```

### 4.2 source_data JSON (quote_items 테이블)

```json
{
  "mesu": 2000,
  "product_type": "inserted",
  "source_type": "calculator"
}
```

---

## 5. 필드명 매핑

| 용도 | 필드명 | 위치 | 설명 |
|------|--------|------|------|
| 연수 | `quantity` | Type_1 JSON | 0.5, 1, 1.5 등 소수점 |
| 연수 (레거시) | `MY_amount` | Type_1 JSON | 이전 버전 호환용 |
| 매수 | `mesu` | Type_1 JSON | 1000, 2000, 4000 등 정수 |
| 매수 (레거시) | `quantityTwo` | Type_1 JSON | 이전 버전 호환용 |

---

## 6. 수정된 위치 (OrderFormOrderTree.php)

3곳에서 동일한 패턴 수정:

1. **789행 부근**: 첫 번째 JSON 처리 블록 (`$json_data`)
2. **1119행 부근**: 두 번째 JSON 처리 블록 (`$json_data`)
3. **1469행 부근**: 세 번째 JSON 처리 블록 (`$type1_data`)

---

## 7. 테스트 체크리스트

- [x] 봉투 주문: 재질 표시 확인
- [x] 전단지 견적: 매수 표시 확인 (예: "0.5연 (2,000매)")
- [x] 전단지 견적: 단가 계산 확인 (공급가액 ÷ 매수)
- [x] 관리자 페이지: 수량 소수점 표시 확인 (0.5연)
- [x] PDF 생성: 매수 표시 확인

---

## 8. 관련 URL

- 견적서 상세: `http://localhost/mlangprintauto/quote/detail.php?id=XXX`
- 관리자 주문조회: `http://localhost/admin/mlangprintauto/admin.php?mode=OrderView&no=XXXXX`

---

**마지막 업데이트**: 2025-12-10
