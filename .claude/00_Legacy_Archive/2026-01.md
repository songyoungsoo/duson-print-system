# Changelog - 2026년 1월

## 2026-01-14: 주문서 출력 정석 형식 수정 및 레거시 코드 정리

### 주문서 출력 형식 수정 (OrderFormPrint.php)

#### 변경 전 (비표준)
```
품목  규격  수량  공급가액
───────────────────────────
전단지  ...  0.5연  ₩50,000
                   총액: ₩55,000
                   (VAT ₩5,000 포함)
```

#### 변경 후 (정석)
```
품목  규격  수량  공급가액
───────────────────────────
전단지  ...  0.5연  ₩50,000
명함    ...  1,000매 ₩15,000
───────────────────────────
         공급가액 합계: ₩65,000
         부가세(VAT):   ₩6,500
         ─────────────────────
         합계 (VAT 포함): ₩71,500
```

#### 수정 내용
- 각 행: 공급가액만 표시 (VAT 제외)
- 테이블 하단 tfoot: 공급가액 합계 → 부가세 → 합계 순서

### 레거시 코드 정리 (Grand Design Phase)

#### 1. 레거시 파일 격리
- **195개 파일 (4.7MB)** → `/legacy_old_backup/` 이동
- 날짜 붙은 통합 주문 파일 11개 (OrderFormOrderTree251210.php 등)
- Admin 백업 디렉토리 2개
- Admin 테스트 파일 16개
- Member 폼 변형 11개

#### 2. 코어 로직 모듈화
- **`lib/core_print_logic.php`** 생성 (SSOT 중앙 진입점)
- `PrintCore` 파사드 클래스
- 전역 헬퍼: `duson_format_qty()`, `duson_lookup_sheets()`, `duson_get_unit()`

#### 3. 무결성 검증 시스템
- **`CLAUDE_DOCS/DATA_LINEAGE.md`** - 수량 데이터 흐름도 문서
- **`check/verify_data_lineage.php`** - Cross-Check 22개 테스트 (100% 통과)

#### 4. Dead Code 삭제 (~150줄)
- `OrderComplete_universal.php`: deprecated `extractQuantity()` 제거
- `OrderComplete_universal.php`: Gemini Debug Block 제거
- `ProcessOrder_unified.php`: 디버그 로깅 제거

### 수정된 파일
```
/mlangorder_printauto/OrderFormPrint.php       (주문서 출력 형식)
/mlangorder_printauto/OrderComplete_universal.php (Dead Code 삭제)
/mlangorder_printauto/ProcessOrder_unified.php    (Dead Code 삭제)
/lib/core_print_logic.php                         (신규 생성)
/CLAUDE_DOCS/DATA_LINEAGE.md                      (신규 생성)
/check/verify_data_lineage.php                    (신규 생성)
```

---

## 2026-01-13: 스티커 규격/수량 표시 근본 해결

### 문제 현상
- **프로덕션**: 스티커 주문 규격이 "인쇄만"만 표시, 수량이 "-"로 표시
- **로컬**: 정상 표시 (사각 / 아트유광코팅 / 90mm x 50mm / 1,000매 / 인쇄만)

### 근본 원인 분석
1. **Type_1 JSON 중첩 구조**: 레거시 데이터가 `{"order_details": {"jong": "...", "garo": 90, ...}}` 형태로 저장
2. **코드는 flat 구조만 처리**: `json_data['jong']`을 직접 읽으려 했으나 `json_data['order_details']['jong']`에 있음
3. **표준 필드 미저장**: 과거 ProcessOrder_unified.php가 표준 필드(spec_type 등)를 DB에 저장하지 않음
4. **스티커 mesu 필드 무시**: 수량 추출 로직이 MY_amount만 확인하고 sticker의 mesu 필드 미처리

### 수정 내용

#### 1. ProductSpecFormatter.php
```php
// order_details 중첩 구조 자동 풀기
if (isset($type1Data['order_details']) && is_array($type1Data['order_details'])) {
    $type1Data = array_merge($type1Data, $type1Data['order_details']);
}

// formatSticker(): 표준 필드 우선, 레거시 폴백
$shape = $item['spec_type'] ?? '';
if (empty($shape)) {
    $domusong = $item['domusong'] ?? '';
    // ... 레거시 폴백
}
```

#### 2. OrderFormOrderTree.php
```php
// order_details 중첩 구조 처리 (getOrderItemInfo 함수)
if (isset($json_data['order_details']) && is_array($json_data['order_details'])) {
    $json_data = array_merge($json_data, $json_data['order_details']);
}

// 스티커 mesu 필드 수량 인식
elseif ($product_type === 'sticker' && isset($json_data['mesu']) && intval($json_data['mesu']) > 0) {
    $quantity_num = intval($json_data['mesu']);
    $unit = '매';
}
```

#### 3. ProcessOrder_unified.php
```php
// 새 주문 시 Type_1 JSON에 레거시 필드 포함
if ($item['product_type'] === 'sticker') {
    $product_data['jong'] = $item['jong'] ?? '';
    $product_data['garo'] = $item['garo'] ?? '';
    $product_data['sero'] = $item['sero'] ?? '';
    $product_data['domusong'] = $item['domusong'] ?? '';
    $product_data['mesu'] = $item['mesu'] ?? '';
}
```

### 수정된 파일
```
/includes/ProductSpecFormatter.php
/mlangorder_printauto/OrderFormOrderTree.php
/mlangorder_printauto/ProcessOrder_unified.php
```

### 진단 도구 추가
```
/admin/mlangprintauto/check_sticker_data.php   - 주문 데이터 상태 확인
/admin/mlangprintauto/migrate_sticker_data.php - 기존 데이터 마이그레이션
```

### 프로덕션 배포
- 모든 수정 파일 FTP 배포 완료
- 기존 레거시 데이터도 정상 표시됨

---

## 2026-01-12: 규격/수량 표시 통합 및 컬럼 너비 조정

### 변경 사항

#### 1. 소수점 수량 표시 수정
- **문제**: 프로덕션에서 "10.00권", "1000.00부" 등 소수점 표시
- **원인**: 레거시 Type_1 텍스트에 소수점 포함된 상태로 저장
- **해결**: `SpecDisplayService::parseLegacyType1()`에서 자동 정리
  - `10.00권` → `10권`
  - `1000.00부` → `1,000부`

#### 2. 레거시 필드 파싱 추가
- **파일**: `/includes/SpecDisplayService.php`
- **추가된 필드 파싱**:
  - `구분` → `spec_type`
  - `규격` → `spec_size`
  - `색상` → `spec_sides`
  - `종이종류` → `spec_material`
  - `주문방법` → `spec_design`

#### 3. 견적서 시스템 파일 동기화
- **문제**: 견적서용 ProductSpecFormatter가 구버전 (611줄 vs 1183줄)
- **해결**: `/mlangprintauto/quote/includes/ProductSpecFormatter.php` 최신화

#### 4. 테이블 컬럼 너비 조정 (OrderFormOrderTree.php)
- **변경 전**: 규격/옵션 35%, 공급가액 22%
- **변경 후**: 규격/옵션 44%, 공급가액 13%
- **적용 위치**:
  - 관리자 주문 상세 테이블
  - 영수증 출력
  - 거래명세표 출력

#### 5. 부가세포함 금액 폰트 크기 조정
- **변경 전**: 12pt
- **변경 후**: 9pt (한 줄 표시를 위해)

#### 6. 양식지(NCR) 단위 분석 완료
- **분석 결과**: 양식지는 항상 '권' 단위만 사용
- **이유**: 제본 형태 (100매철, 50매철) 판매
- **DB 문제**: `unit` 컬럼에 '매' 기본값 잘못 저장됨
- **해결**: `SpecDisplayService::getUnit()`이 PRODUCT_UNITS 우선 적용

### 수정된 파일
```
/includes/SpecDisplayService.php
/includes/ProductSpecFormatter.php
/mlangprintauto/quote/includes/ProductSpecFormatter.php
/mlangorder_printauto/OrderFormOrderTree.php
```

### 프로덕션 배포
- 모든 수정 파일 FTP 배포 완료

---

## 2026-01-11: Playwright E2E 테스트

### 변경 사항
- Playwright E2E 테스트 전체 통과 (44 passed, 6 skipped)
- quotation_temp 7일 이상 데이터 자동 정리 기능 추가

---

## 2026-01-08: 견적서 템플릿

### 변경 사항
- 견적서 A4 용지 스타일 및 colspan 수정
- 견적서 표준 템플릿 및 이메일 발송 기능 추가
