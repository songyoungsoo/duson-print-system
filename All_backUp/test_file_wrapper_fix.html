<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŒŒì¼ ë˜í¼ ê°ì²´ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>íŒŒì¼ ë˜í¼ ê°ì²´ ìˆ˜ì • í…ŒìŠ¤íŠ¸</h1>

    <div class="test-section">
        <h2>1. íŒŒì¼ ì„ íƒ</h2>
        <input type="file" id="testFile" multiple>
        <button onclick="testUpload()">ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="test-section">
        <h2>2. í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
        <div id="testResults"></div>
    </div>

    <script>
        // upload_modal.jsì™€ ë™ì¼í•œ êµ¬ì¡°ë¡œ íŒŒì¼ ì €ì¥
        window.uploadedFiles = [];

        function processFiles(files) {
            window.uploadedFiles = [];

            files.forEach(file => {
                // upload_modal.jsì™€ ë™ì¼í•œ ë˜í¼ ê°ì²´ ìƒì„±
                const fileObj = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    file: file,  // â† ì‹¤ì œ File ê°ì²´
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: '.' + file.name.split('.').pop().toLowerCase()
                };

                window.uploadedFiles.push(fileObj);
            });

            console.log('ğŸ“¦ uploadedFiles:', window.uploadedFiles);
        }

        function testUpload() {
            const fileInput = document.getElementById('testFile');
            const files = Array.from(fileInput.files);

            if (files.length === 0) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            // íŒŒì¼ ì²˜ë¦¬ (upload_modal.js íŒ¨í„´)
            processFiles(files);

            // FormData ìƒì„± (inserted/index.php íŒ¨í„´)
            const formData = new FormData();
            formData.append('test', 'hello');
            formData.append('MY_type', '123');

            let results = '<h3>í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:</h3>';

            // âŒ ì˜ëª»ëœ ë°©ë²• (ìˆ˜ì • ì „)
            results += '<h4 class="error">âŒ ìˆ˜ì • ì „ (fileObj ì „ì²´ ì „ì†¡):</h4>';
            const wrongFormData = new FormData();
            wrongFormData.append('test', 'hello');
            window.uploadedFiles.forEach((fileObj, index) => {
                wrongFormData.append('uploaded_files[]', fileObj);  // ë˜í¼ ê°ì²´ ì „ì²´
            });

            results += '<pre>';
            results += 'ì½”ë“œ: formData.append("uploaded_files[]", fileObj);\n\n';
            results += 'FormData entries:\n';
            for (let [key, value] of wrongFormData.entries()) {
                if (value instanceof File) {
                    results += `  ${key}: [File] ${value.name} (${value.size} bytes)\n`;
                } else if (typeof value === 'object') {
                    results += `  ${key}: [Object] ${JSON.stringify(value)}\n`;
                } else {
                    results += `  ${key}: ${value}\n`;
                }
            }
            results += '</pre>';

            // âœ… ì˜¬ë°”ë¥¸ ë°©ë²• (ìˆ˜ì • í›„)
            results += '<h4 class="success">âœ… ìˆ˜ì • í›„ (fileObj.file ì „ì†¡):</h4>';
            const correctFormData = new FormData();
            correctFormData.append('test', 'hello');
            window.uploadedFiles.forEach((fileObj, index) => {
                correctFormData.append('uploaded_files[]', fileObj.file);  // ì‹¤ì œ File ê°ì²´
            });

            results += '<pre>';
            results += 'ì½”ë“œ: formData.append("uploaded_files[]", fileObj.file);\n\n';
            results += 'FormData entries:\n';
            for (let [key, value] of correctFormData.entries()) {
                if (value instanceof File) {
                    results += `  ${key}: [File] ${value.name} (${value.size} bytes) âœ…\n`;
                } else if (typeof value === 'object') {
                    results += `  ${key}: [Object] ${JSON.stringify(value)}\n`;
                } else {
                    results += `  ${key}: ${value}\n`;
                }
            }
            results += '</pre>';

            // ì‹¤ì œ ì „ì†¡ í…ŒìŠ¤íŠ¸
            results += '<h4>ğŸš€ ì‹¤ì œ ì „ì†¡ í…ŒìŠ¤íŠ¸:</h4>';
            results += '<p>test_file_upload_receiver.phpë¡œ ì „ì†¡ ì¤‘...</p>';

            document.getElementById('testResults').innerHTML = results;

            // ìˆ˜ì •ëœ FormDataë¡œ ì‹¤ì œ ì „ì†¡
            fetch('test_file_upload_receiver.php', {
                method: 'POST',
                body: correctFormData
            })
            .then(response => response.text())
            .then(text => {
                results += '<h4 class="success">âœ… ì„œë²„ ì‘ë‹µ:</h4>';
                results += '<pre>' + text + '</pre>';
                document.getElementById('testResults').innerHTML = results;
            })
            .catch(error => {
                results += '<h4 class="error">âŒ ì „ì†¡ ì‹¤íŒ¨:</h4>';
                results += '<pre>' + error + '</pre>';
                document.getElementById('testResults').innerHTML = results;
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
