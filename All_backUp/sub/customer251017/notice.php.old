<?php
/**
 * ê³µì§€ì‚¬í•­
 * ë‘ì†ê¸°íšì¸ì‡„ ê³µì§€ì‚¬í•­ ê²Œì‹œíŒ
 */

// ì„¸ì…˜ ì‹œì‘
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
require_once $_SERVER['DOCUMENT_ROOT'] . '/db.php';

// í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
$page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
$perPage = 10;
$offset = ($page - 1) * $perPage;

// ê²€ìƒ‰ ì²˜ë¦¬
$search = isset($_GET['search']) ? trim($_GET['search']) : '';
$searchQuery = '';
$searchParams = [];

if (!empty($search)) {
    $searchQuery = " WHERE notice_title LIKE ? OR notice_content LIKE ?";
    $searchTerm = "%{$search}%";
    $searchParams = [$searchTerm, $searchTerm];
}

// ì „ì²´ ê³µì§€ì‚¬í•­ ìˆ˜ ì¡°íšŒ
$countSql = "SELECT COUNT(*) as total FROM customer_notices" . $searchQuery;
$countStmt = mysqli_prepare($db, $countSql);
if (!empty($searchParams)) {
    mysqli_stmt_bind_param($countStmt, "ss", ...$searchParams);
}
mysqli_stmt_execute($countStmt);
$countResult = mysqli_stmt_get_result($countStmt);
$totalCount = mysqli_fetch_assoc($countResult)['total'];
$totalPages = ceil($totalCount / $perPage);

// ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ
$sql = "SELECT notice_id, notice_title, notice_content, is_important, created_at, views
        FROM customer_notices" . $searchQuery . "
        ORDER BY is_important DESC, created_at DESC
        LIMIT ? OFFSET ?";

$stmt = mysqli_prepare($db, $sql);
if (!empty($searchParams)) {
    mysqli_stmt_bind_param($stmt, "ssii", $searchParams[0], $searchParams[1], $perPage, $offset);
} else {
    mysqli_stmt_bind_param($stmt, "ii", $perPage, $offset);
}
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$notices = mysqli_fetch_all($result, MYSQLI_ASSOC);

// ê³µí†µ í—¤ë” í¬í•¨
include_once $_SERVER['DOCUMENT_ROOT'] . '/includes/header-ui.php';
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì§€ì‚¬í•­ - ë‘ì†ê¸°íšì¸ì‡„ ê³ ê°ì„¼í„°</title>

    <link rel="stylesheet" href="/css/common-styles.css">
    <link rel="stylesheet" href="/css/customer-center.css">
    <style>
        /* ê³µì§€ì‚¬í•­ ì „ìš© ìŠ¤íƒ€ì¼ */
        .notice-list {
            margin: 30px 0;
        }

        .notice-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fff;
            transition: all 0.2s;
            cursor: pointer;
        }

        .notice-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .notice-item.important {
            border-color: #ff5722;
            background: #fff3e0;
        }

        .notice-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
        }

        .important-badge {
            flex-shrink: 0;
            padding: 6px 12px;
            background: #ff5722;
            color: #fff;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .notice-title {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .notice-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #999;
        }

        .notice-content-preview {
            padding: 0 20px 20px 20px;
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            display: none;
        }

        .notice-item.expanded .notice-content-preview {
            display: block;
        }

        .toggle-icon {
            color: #999;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .notice-item.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* ê²€ìƒ‰ ë°•ìŠ¤ */
        .notice-search {
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .search-btn {
            padding: 12px 30px;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .search-btn:hover {
            background: #1976D2;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 40px;
        }

        .page-link {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #333;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .page-link:hover {
            background: #f5f5f5;
        }

        .page-link.active {
            background: #2196F3;
            color: #fff;
            border-color: #2196F3;
        }

        .page-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="customer-center-container">
        <?php include $_SERVER['DOCUMENT_ROOT'] . '/includes/customer_sidebar.php'; ?>

        <main class="customer-content">
            <div class="breadcrumb">
                <a href="/">í™ˆ</a> &gt; <a href="/sub/customer/">ê³ ê°ì„¼í„°</a> &gt; <span>ê³µì§€ì‚¬í•­</span>
            </div>

            <div class="content-header">
                <h1>ğŸ“¢ ê³µì§€ì‚¬í•­</h1>
                <p class="subtitle">ë‘ì†ê¸°íšì¸ì‡„ì˜ ìƒˆë¡œìš´ ì†Œì‹ê³¼ ì¤‘ìš”í•œ ê³µì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>

            <div class="content-body">
                <!-- ê²€ìƒ‰ -->
                <div class="notice-search">
                    <form method="get" action="" class="search-form">
                        <input
                            type="text"
                            name="search"
                            class="search-input"
                            placeholder="ê³µì§€ì‚¬í•­ ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰..."
                            value="<?php echo htmlspecialchars($search); ?>"
                        >
                        <button type="submit" class="search-btn">ğŸ” ê²€ìƒ‰</button>
                    </form>
                    <?php if (!empty($search)): ?>
                        <p style="margin-top: 10px; color: #666;">
                            '<strong><?php echo htmlspecialchars($search); ?></strong>' ê²€ìƒ‰ ê²°ê³¼: <?php echo $totalCount; ?>ê±´
                            <a href="notice.php" style="margin-left: 10px; color: #2196F3;">ì „ì²´ë³´ê¸°</a>
                        </p>
                    <?php endif; ?>
                </div>

                <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ -->
                <div class="notice-list">
                    <?php if (count($notices) > 0): ?>
                        <?php foreach ($notices as $notice): ?>
                            <div class="notice-item <?php echo $notice['is_important'] ? 'important' : ''; ?>"
                                 data-notice-id="<?php echo $notice['notice_id']; ?>">
                                <div class="notice-header">
                                    <?php if ($notice['is_important']): ?>
                                        <span class="important-badge">ì¤‘ìš”</span>
                                    <?php endif; ?>

                                    <h3 class="notice-title">
                                        <?php echo htmlspecialchars($notice['notice_title']); ?>
                                    </h3>

                                    <div class="notice-meta">
                                        <span>ğŸ“… <?php echo date('Y.m.d', strtotime($notice['created_at'])); ?></span>
                                        <span>ğŸ‘ï¸ <?php echo number_format($notice['views']); ?></span>
                                    </div>

                                    <span class="toggle-icon">â–¼</span>
                                </div>

                                <div class="notice-content-preview">
                                    <?php echo nl2br(htmlspecialchars($notice['notice_content'])); ?>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <h3>ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    <?php endif; ?>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <?php if ($totalPages > 1): ?>
                    <div class="pagination">
                        <?php if ($page > 1): ?>
                            <a href="?page=<?php echo ($page - 1); ?><?php echo !empty($search) ? '&search=' . urlencode($search) : ''; ?>"
                               class="page-link">â—€ ì´ì „</a>
                        <?php endif; ?>

                        <?php
                        $startPage = max(1, $page - 2);
                        $endPage = min($totalPages, $page + 2);

                        for ($i = $startPage; $i <= $endPage; $i++):
                        ?>
                            <a href="?page=<?php echo $i; ?><?php echo !empty($search) ? '&search=' . urlencode($search) : ''; ?>"
                               class="page-link <?php echo $i === $page ? 'active' : ''; ?>">
                                <?php echo $i; ?>
                            </a>
                        <?php endfor; ?>

                        <?php if ($page < $totalPages): ?>
                            <a href="?page=<?php echo ($page + 1); ?><?php echo !empty($search) ? '&search=' . urlencode($search) : ''; ?>"
                               class="page-link">ë‹¤ìŒ â–¶</a>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>
            </div>
        </main>
    </div>

    <script src="/js/customer-center.js"></script>
    <script>
        // ê³µì§€ì‚¬í•­ ì•„ì½”ë””ì–¸
        document.querySelectorAll('.notice-item').forEach(item => {
            item.querySelector('.notice-header').addEventListener('click', function() {
                item.classList.toggle('expanded');

                // ì¡°íšŒìˆ˜ ì¦ê°€ (í•œ ë²ˆë§Œ)
                if (item.classList.contains('expanded') && !item.dataset.viewed) {
                    const noticeId = item.dataset.noticeId;
                    fetch('/api/increment_notice_view.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({notice_id: noticeId})
                    });
                    item.dataset.viewed = 'true';
                }
            });
        });
    </script>
</body>
</html>
