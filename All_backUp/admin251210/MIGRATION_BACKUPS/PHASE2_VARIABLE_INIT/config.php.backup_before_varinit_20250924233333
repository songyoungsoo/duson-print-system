<?php
declare(strict_types=1);
////////////////// 관리자 로그인 ////////////////////
function authenticate()
{
  HEADER("WWW-authenticate: basic realm=\"MlangWeb관리프로그램-관리자 전용!.. ♥ WEBSIL.net ♥\" ");
  HEADER("HTTP/1.0 401 Unauthorized");
  echo("<html><head><script>
       <!--
        function pop()
        { alert('관리자 인증 실패');
             history.go(-1);}
       //--->
        </script>
        </head>
        <body onLoad='pop()'></body>
        </html>
       ");
exit;
}

// ✅ PHP 7.4 호환: 변수 초기화
$auth_user = $_SERVER['PHP_AUTH_USER'] ?? '';
$auth_pw = $_SERVER['PHP_AUTH_PW'] ?? '';

if (empty($auth_user) || empty($auth_pw))
{
 authenticate();
}

else
{
    include"../db.php";

    // ✅ Prepared Statement 적용 (보안 강화)
    $stmt = mysqli_prepare($db, "SELECT id, pass FROM member WHERE no = ? LIMIT 1");
    if ($stmt) {
        $admin_no = 1;
        mysqli_stmt_bind_param($stmt, "i", $admin_no);
        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);

        if ($result && $row = mysqli_fetch_assoc($result)) {
            $adminid = $row['id'] ?? '';
            $adminpasswd = $row['pass'] ?? '';

            // ✅ 안전한 문자열 비교 (타이밍 공격 방지)
            if (!hash_equals($auth_user, $adminid) || !hash_equals($auth_pw, $adminpasswd)) {
                authenticate();
            }
        } else {
            authenticate();
        }

        mysqli_stmt_close($stmt);
    } else {
        error_log("Database prepare statement failed: " . mysqli_error($db));
        authenticate();
    }
}
?>