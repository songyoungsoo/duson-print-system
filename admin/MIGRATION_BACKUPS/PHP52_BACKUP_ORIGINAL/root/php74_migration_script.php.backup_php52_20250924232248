<?php
/**
 * PHP 5.2 â†’ 7.4 ë§ˆì´ê·¸ë ˆì´ì…˜ ìë™í™” ìŠ¤í¬ë¦½íŠ¸
 *
 * ì•ˆì „í•˜ê³  ì²´ê³„ì ì¸ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìœ„í•œ 3ë‹¨ê³„ ì ‘ê·¼ë²•
 * - Phase 1: ê¸°ë³¸ êµ¬ë¬¸ í˜¸í™˜ì„±
 * - Phase 2: ë°ì´í„°ë² ì´ìŠ¤ ë ˆì´ì–´ í˜„ëŒ€í™”
 * - Phase 3: ë³´ì•ˆ ê°•í™”
 */

declare(strict_types=1);

// ë¡œê·¸ íŒŒì¼ ì„¤ì •
$logFile = __DIR__ . '/php74_migration_log_' . date('Y-m-d_H-i-s') . '.txt';

class PHP74Migrator {
    private string $logFile;
    private array $stats = [
        'total_files' => 0,
        'migrated_files' => 0,
        'errors' => 0,
        'skipped_files' => 0
    ];

    public function __construct(string $logFile) {
        $this->logFile = $logFile;
    }

    public function writeLog(string $message): void {
        $timestamp = date('Y-m-d H:i:s');
        $logMessage = "[$timestamp] $message" . PHP_EOL;
        file_put_contents($this->logFile, $logMessage, FILE_APPEND | LOCK_EX);
        echo $logMessage;
    }

    public function migrateFile(string $filePath, bool $dryRun = false): bool {
        if (!file_exists($filePath)) {
            $this->writeLog("âŒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $filePath");
            $this->stats['errors']++;
            return false;
        }

        $originalContent = file_get_contents($filePath);
        if ($originalContent === false) {
            $this->writeLog("âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: $filePath");
            $this->stats['errors']++;
            return false;
        }

        // Phase 1: ê¸°ë³¸ êµ¬ë¬¸ í˜¸í™˜ì„±
        $migratedContent = $this->applyPhase1($originalContent, $filePath);

        // Phase 2: ë°ì´í„°ë² ì´ìŠ¤ ë ˆì´ì–´ (ê¸°ë³¸ ë³€í™˜)
        $migratedContent = $this->applyPhase2($migratedContent, $filePath);

        // Phase 3: ê¸°ë³¸ ë³´ì•ˆ ê°•í™”
        $migratedContent = $this->applyPhase3($migratedContent, $filePath);

        // ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if ($originalContent === $migratedContent) {
            $this->writeLog("â­ï¸  ë³€ê²½ì‚¬í•­ ì—†ìŒ: $filePath");
            $this->stats['skipped_files']++;
            return true;
        }

        if (!$dryRun) {
            // ë°±ì—… ìƒì„±
            $backupPath = $filePath . '.backup_php52_' . date('YmdHis');
            if (!copy($filePath, $backupPath)) {
                $this->writeLog("âŒ ë°±ì—… ìƒì„± ì‹¤íŒ¨: $filePath");
                $this->stats['errors']++;
                return false;
            }
            $this->writeLog("ğŸ’¾ ë°±ì—… ìƒì„±: $backupPath");

            // ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ì½”ë“œ ì €ì¥
            if (file_put_contents($filePath, $migratedContent) === false) {
                $this->writeLog("âŒ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: $filePath");
                $this->stats['errors']++;
                return false;
            }
            $this->writeLog("âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: $filePath");
        } else {
            $this->writeLog("ğŸ” [DRY RUN] ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì •: $filePath");
        }

        $this->stats['migrated_files']++;
        return true;
    }

    /**
     * Phase 1: ê¸°ë³¸ êµ¬ë¬¸ í˜¸í™˜ì„±
     */
    private function applyPhase1(string $content, string $filePath): string {
        $changes = [];

        // 1.1 ì§§ì€ PHP íƒœê·¸ â†’ ì™„ì „í•œ PHP íƒœê·¸
        if (preg_match('/^<\?[^p]/', $content)) {
            $content = preg_replace('/^<\?/', '<?php' . PHP_EOL . 'declare(strict_types=1);', $content);
            $changes[] = "ì§§ì€ PHP íƒœê·¸ ë³€í™˜";
        }

        // 1.2 ì „ì—­ ë³€ìˆ˜ í˜„ëŒ€í™”
        if (strpos($content, '$PHP_AUTH_USER') !== false) {
            $content = str_replace(
                ['!$PHP_AUTH_USER', '$PHP_AUTH_USER'],
                ['empty($_SERVER[\'PHP_AUTH_USER\'])', '$_SERVER[\'PHP_AUTH_USER\'] ?? \'\''],
                $content
            );
            $changes[] = '$PHP_AUTH_USER â†’ $_SERVER ë³€í™˜';
        }

        if (strpos($content, '$PHP_AUTH_PW') !== false) {
            $content = str_replace(
                ['!$PHP_AUTH_PW', '$PHP_AUTH_PW'],
                ['empty($_SERVER[\'PHP_AUTH_PW\'])', '$_SERVER[\'PHP_AUTH_PW\'] ?? \'\''],
                $content
            );
            $changes[] = '$PHP_AUTH_PW â†’ $_SERVER ë³€í™˜';
        }

        // 1.3 ë³€ìˆ˜ ì´ˆê¸°í™” (ê¸°ë³¸ì ì¸ ê²½ìš°)
        $commonVars = ['$mode', '$no', '$search', '$id', '$name'];
        foreach ($commonVars as $var) {
            if (strpos($content, $var) !== false && !preg_match("/\{$var}\s*=/", $content)) {
                // GET/POST ë³€ìˆ˜ëŠ” null ë³‘í•© ì—°ì‚°ìë¡œ ì´ˆê¸°í™”
                $content = preg_replace(
                    '/(\$' . substr($var, 1) . '\s*=\s*\$_[GP])/i',
                    '$1OST[\'' . substr($var, 1) . '\'] ?? \'\'',
                    $content
                );
            }
        }

        if (!empty($changes)) {
            $this->writeLog("ğŸ“ Phase 1 ì ìš© ($filePath): " . implode(', ', $changes));
        }

        return $content;
    }

    /**
     * Phase 2: ë°ì´í„°ë² ì´ìŠ¤ ë ˆì´ì–´ í˜„ëŒ€í™”
     */
    private function applyPhase2(string $content, string $filePath): string {
        $changes = [];

        // 2.1 MySQL í•¨ìˆ˜ â†’ MySQLi ë³€í™˜ (ê¸°ë³¸ì ì¸ ê²½ìš°)
        $mysqlReplacements = [
            'mysql_query(' => 'mysqli_query($db, ',
            'mysql_fetch_array(' => 'mysqli_fetch_array(',
            'mysql_fetch_row(' => 'mysqli_fetch_row(',
            'mysql_close()' => 'mysqli_close($db)',
            'mysql_close(' => 'mysqli_close('
        ];

        foreach ($mysqlReplacements as $old => $new) {
            if (strpos($content, $old) !== false) {
                $content = str_replace($old, $new, $content);
                $changes[] = "$old â†’ $new";
            }
        }

        if (!empty($changes)) {
            $this->writeLog("ğŸ—„ï¸ Phase 2 ì ìš© ($filePath): " . implode(', ', $changes));
        }

        return $content;
    }

    /**
     * Phase 3: ê¸°ë³¸ ë³´ì•ˆ ê°•í™”
     */
    private function applyPhase3(string $content, string $filePath): string {
        $changes = [];

        // 3.1 strcmp â†’ hash_equals (ë¹„ë°€ë²ˆí˜¸ ë¹„êµ)
        if (strpos($content, 'strcmp(') !== false && strpos($content, 'password') !== false) {
            $content = preg_replace(
                '/strcmp\(\$([^,]+),\s*\$([^)]+)\)\s*==\s*0/',
                'hash_equals($1, $2)',
                $content
            );
            $changes[] = 'strcmp â†’ hash_equals (ë³´ì•ˆ ê°•í™”)';
        }

        if (!empty($changes)) {
            $this->writeLog("ğŸ›¡ï¸ Phase 3 ì ìš© ($filePath): " . implode(', ', $changes));
        }

        return $content;
    }

    public function scanAndMigrate(string $directory, bool $dryRun = false): array {
        $this->writeLog("ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: $directory");

        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::LEAVES_ONLY
        );

        foreach ($iterator as $file) {
            if ($file->isFile() && $file->getExtension() === 'php') {
                $this->stats['total_files']++;
                $filePath = $file->getRealPath();
                $this->migrateFile($filePath, $dryRun);
            }
        }

        $this->printStats();
        return $this->stats;
    }

    private function printStats(): void {
        $this->writeLog("=== ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ìš”ì•½ ===");
        $this->writeLog("ì´ íŒŒì¼ ìˆ˜: {$this->stats['total_files']}");
        $this->writeLog("ë§ˆì´ê·¸ë ˆì´ì…˜ëœ íŒŒì¼: {$this->stats['migrated_files']}");
        $this->writeLog("ë³€ê²½ì‚¬í•­ ì—†ëŠ” íŒŒì¼: {$this->stats['skipped_files']}");
        $this->writeLog("ì—ëŸ¬ ë°œìƒ: {$this->stats['errors']}");
    }
}

// ë©”ì¸ ì‹¤í–‰
$migrator = new PHP74Migrator($logFile);

echo "=== PHP 5.2 â†’ 7.4 ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ ===" . PHP_EOL;
echo "ëŒ€ìƒ ë””ë ‰í† ë¦¬: " . __DIR__ . PHP_EOL;

$dryRun = isset($argv[1]) && $argv[1] === '--dry-run';

if ($dryRun) {
    echo "ğŸ” DRY RUN ëª¨ë“œ: ì‹¤ì œ ë³€ê²½í•˜ì§€ ì•Šê³  ë¯¸ë¦¬ë³´ê¸°ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤." . PHP_EOL;
} else {
    echo "âš ï¸  ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë°±ì—…ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤." . PHP_EOL;
    echo "ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...";
    fgets(STDIN);
}

$result = $migrator->scanAndMigrate(__DIR__, $dryRun);

echo PHP_EOL . "ë¡œê·¸ íŒŒì¼: $logFile" . PHP_EOL;
if (!$dryRun) {
    echo "ë°±ì—… íŒŒì¼ë“¤ì€ *.backup_php52_YYYYMMDDHHMMSS í˜•ì‹ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤." . PHP_EOL;
}
?>