<?php
/**
 * Ï£ºÎ¨∏ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ
 * Í≤ΩÎ°ú: /account/orders/detail.php
 */

session_start();
include "../../db.php";

// Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
$is_logged_in = isset($_SESSION['user_id']) || isset($_SESSION['id_login_ok']) || isset($_COOKIE['id_login_ok']);

if (!$is_logged_in) {
    header('Location: /member/login.php?redirect=' . urlencode($_SERVER['REQUEST_URI']));
    exit;
}

// ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏÑ§Ï†ï
if (isset($_SESSION['user_id'])) {
    $user_id = $_SESSION['user_id'];
    $user_name = $_SESSION['user_name'] ?? '';
} elseif (isset($_SESSION['id_login_ok'])) {
    $user_name = $_SESSION['id_login_ok']['id'] ?? '';
    $user_id = $user_name;
} elseif (isset($_COOKIE['id_login_ok'])) {
    $user_name = $_COOKIE['id_login_ok'];
    $user_id = $user_name;
}

// Ï£ºÎ¨∏Î≤àÌò∏ ÌååÎùºÎØ∏ÌÑ∞
$order_no = $_GET['order_no'] ?? '';

if (empty($order_no)) {
    header('Location: /account/orders.php?error=order_not_found');
    exit;
}

// Ï£ºÎ¨∏ Ï†ïÎ≥¥ Ï°∞Ìöå
$query = "SELECT 
    no as order_no,
    Type as product_code,
    Type as product_name,
    ThingCate as product_category,
    Gensu as quantity,
    money_1 as print_price,
    money_2 as design_price,
    money_3 as additional_price,
    money_4 as shipping_price,
    money_5 as total_price,
    name as customer_name,
    email,
    zip,
    zip1 as address1,
    zip2 as address2,
    phone,
    Hendphone as mobile,
    delivery as delivery_method,
    bizname as company_name,
    bank as payment_method,
    bankname as depositor_name,
    cont as memo,
    date as order_date,
    OrderStyle as status,
    Designer as designer,
    coating_enabled,
    coating_type,
    coating_price,
    folding_enabled,
    folding_type,
    folding_price,
    creasing_enabled,
    creasing_lines,
    creasing_price,
    additional_options_total
FROM mlangorder_printauto 
WHERE no = ? AND name = ?";

$stmt = mysqli_prepare($db, $query);
if ($stmt) {
    mysqli_stmt_bind_param($stmt, "is", $order_no, $user_name);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    $order = mysqli_fetch_assoc($result);
    
    if (!$order) {
        header('Location: /account/orders.php?error=access_denied');
        exit;
    }
} else {
    header('Location: /account/orders.php?error=database_error');
    exit;
}

$page_title = 'Ï£ºÎ¨∏ ÏÉÅÏÑ∏ - ÎëêÏÜêÍ∏∞ÌöçÏù∏ÏáÑ';

// ÏÉÅÌÉúÎ≥Ñ ÏÉâÏÉÅ
$status_colors = [
    'Í≤∞Ï†úÎåÄÍ∏∞' => 'bg-gray-100 text-gray-800',
    'Ï†ëÏàò' => 'bg-blue-100 text-blue-800',
    'ÍµêÏ†ïÏ§ë' => 'bg-indigo-100 text-indigo-800',
    'Ï†úÏûëÏ§ë' => 'bg-purple-100 text-purple-800',
    'Ï∂úÍ≥†' => 'bg-green-100 text-green-800',
    'ÏôÑÎ£å' => 'bg-green-100 text-green-800',
    'Ï∑®ÏÜå' => 'bg-red-100 text-red-800'
];
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo htmlspecialchars($page_title); ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .print-area {
            background: white;
            padding: 40px;
            margin: 20px auto;
            max-width: 800px;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-area {
                margin: 0;
                padding: 20px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Ìó§Îçî -->
            <div class="mb-6 no-print">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Ï£ºÎ¨∏ ÏÉÅÏÑ∏</h1>
                        <p class="mt-1 text-sm text-gray-600">Ï£ºÎ¨∏Î≤àÌò∏: <?php echo htmlspecialchars($order['order_no']); ?></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            üñ®Ô∏è Ïù∏ÏáÑ
                        </button>
                        <a href="/account/orders.php" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            Î™©Î°ùÏúºÎ°ú
                        </a>
                    </div>
                </div>
            </div>

            <!-- Ï£ºÎ¨∏ Ï†ïÎ≥¥ Ïπ¥Îìú -->
            <div class="print-area bg-white rounded-lg shadow-sm border border-gray-200">
                <!-- Ï£ºÎ¨∏ ÏÉÅÌÉú -->
                <div class="border-b border-gray-200 pb-4 mb-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Ï£ºÎ¨∏Î≤àÌò∏: <?php echo htmlspecialchars($order['order_no']); ?></h2>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <?php echo $status_colors[$order['status']] ?? 'bg-gray-100 text-gray-800'; ?>">
                            <?php echo htmlspecialchars($order['status'] ?? 'ÌôïÏù∏Ï§ë'); ?>
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">Ï£ºÎ¨∏Ïùº: <?php echo date('YÎÖÑ mÏõî dÏùº H:i', strtotime($order['order_date'])); ?></p>
                </div>

                <!-- ÏÉÅÌíà Ï†ïÎ≥¥ -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold mb-3">üì¶ ÏÉÅÌíà Ï†ïÎ≥¥</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">ÏÉÅÌíàÎ™Ö</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['product_name']); ?></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ïπ¥ÌÖåÍ≥†Î¶¨</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['product_category'] ?? '-'); ?></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ÏàòÎüâ</p>
                                <p class="font-medium"><?php echo number_format($order['quantity']); ?>Î∂Ä</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ÎîîÏûêÏù¥ÎÑà</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['designer'] ?? 'ÎØ∏Ï†ï'); ?></p>
                            </div>
                        </div>

                        <?php if ($order['coating_enabled'] || $order['folding_enabled'] || $order['creasing_enabled']): ?>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-sm font-semibold mb-2">Ï∂îÍ∞Ä ÏòµÏÖò</p>
                            <ul class="text-sm space-y-1">
                                <?php if ($order['coating_enabled']): ?>
                                <li>‚Ä¢ ÏΩîÌåÖ: <?php echo htmlspecialchars($order['coating_type']); ?> (<?php echo number_format($order['coating_price']); ?>Ïõê)</li>
                                <?php endif; ?>
                                <?php if ($order['folding_enabled']): ?>
                                <li>‚Ä¢ Ï†ëÏßÄ: <?php echo htmlspecialchars($order['folding_type']); ?> (<?php echo number_format($order['folding_price']); ?>Ïõê)</li>
                                <?php endif; ?>
                                <?php if ($order['creasing_enabled']): ?>
                                <li>‚Ä¢ Ïò§Ïãú: <?php echo $order['creasing_lines']; ?>Ï§Ñ (<?php echo number_format($order['creasing_price']); ?>Ïõê)</li>
                                <?php endif; ?>
                            </ul>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold mb-3">üë§ Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Ï£ºÎ¨∏ÏûêÎ™Ö</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['customer_name']); ?></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ÌöåÏÇ¨Î™Ö</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['company_name'] ?? '-'); ?></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ïù¥Î©îÏùº</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['email'] ?? '-'); ?></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ïó∞ÎùΩÏ≤ò</p>
                                <p class="font-medium"><?php echo htmlspecialchars($order['phone'] ?? $order['mobile'] ?? '-'); ?></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-600">Î∞∞ÏÜ°ÏßÄ</p>
                                <p class="font-medium">
                                    <?php echo htmlspecialchars($order['zip'] ?? ''); ?>
                                    <?php echo htmlspecialchars($order['address1'] ?? ''); ?>
                                    <?php echo htmlspecialchars($order['address2'] ?? ''); ?>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Í≤∞Ï†ú Ï†ïÎ≥¥ -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold mb-3">üí≥ Í≤∞Ï†ú Ï†ïÎ≥¥</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ïù∏ÏáÑÎπÑ</span>
                                <span class="font-medium"><?php echo number_format($order['print_price'] ?? 0); ?>Ïõê</span>
                            </div>
                            <?php if ($order['design_price'] > 0): ?>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ÎîîÏûêÏù∏ÎπÑ</span>
                                <span class="font-medium"><?php echo number_format($order['design_price']); ?>Ïõê</span>
                            </div>
                            <?php endif; ?>
                            <?php if ($order['additional_options_total'] > 0): ?>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ï∂îÍ∞ÄÏòµÏÖò</span>
                                <span class="font-medium"><?php echo number_format($order['additional_options_total']); ?>Ïõê</span>
                            </div>
                            <?php endif; ?>
                            <?php if ($order['shipping_price'] > 0): ?>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Î∞∞ÏÜ°ÎπÑ</span>
                                <span class="font-medium"><?php echo number_format($order['shipping_price']); ?>Ïõê</span>
                            </div>
                            <?php endif; ?>
                            <div class="pt-2 border-t border-gray-300">
                                <div class="flex justify-between">
                                    <span class="text-lg font-semibold">Ï¥ù Í≤∞Ï†úÍ∏àÏï°</span>
                                    <span class="text-lg font-bold text-blue-600"><?php echo number_format($order['total_price'] ?? 0); ?>Ïõê</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-sm text-gray-600">Í≤∞Ï†úÎ∞©Î≤ï</p>
                            <p class="font-medium"><?php echo htmlspecialchars($order['payment_method'] ?? 'Î¨¥ÌÜµÏû•ÏûÖÍ∏à'); ?></p>
                            <?php if ($order['depositor_name']): ?>
                            <p class="text-sm text-gray-600 mt-1">ÏûÖÍ∏àÏûêÎ™Ö: <?php echo htmlspecialchars($order['depositor_name']); ?></p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>

                <!-- Î©îÎ™® -->
                <?php if ($order['memo']): ?>
                <div class="mb-6">
                    <h3 class="text-md font-semibold mb-3">üìù Î©îÎ™®</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm"><?php echo nl2br(htmlspecialchars($order['memo'])); ?></p>
                    </div>
                </div>
                <?php endif; ?>

                <!-- Ïï°ÏÖò Î≤ÑÌäº -->
                <div class="mt-6 pt-6 border-t border-gray-200 no-print">
                    <div class="flex justify-center gap-3">
                        <?php if (in_array($order['status'], ['ÍµêÏ†ïÏ§ë', 'Ï†ëÏàò', 'Ï†úÏûëÏ§ë'])): ?>
                        <a href="/proof/view.php?order_no=<?php echo $order['order_no']; ?>" 
                           class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            üìã ÍµêÏ†ï Î≥¥Í∏∞
                        </a>
                        <?php endif; ?>
                        
                        <a href="/shop/generate_quote_pdf.php?order_no=<?php echo $order['order_no']; ?>" 
                           class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            üìÑ PDF Îã§Ïö¥Î°úÎìú
                        </a>
                        
                        <button onclick="reorderItem('<?php echo $order['order_no']; ?>')" 
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            üîÑ Ïû¨Ï£ºÎ¨∏
                        </button>
                        
                        <?php if (in_array($order['status'], ['Í≤∞Ï†úÎåÄÍ∏∞', 'Ï†ëÏàò'])): ?>
                        <button onclick="cancelOrder('<?php echo $order['order_no']; ?>')" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            ‚ùå Ï£ºÎ¨∏ Ï∑®ÏÜå
                        </button>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ïû¨Ï£ºÎ¨∏ Ìï®Ïàò
        function reorderItem(orderNo) {
            if (confirm('Ïù¥ Ï£ºÎ¨∏Í≥º ÎèôÏùºÌïú ÏÇ¨ÏñëÏúºÎ°ú Ïû¨Ï£ºÎ¨∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.location.href = '/api/orders/reorder.php?order_no=' + orderNo;
            }
        }

        // Ï£ºÎ¨∏ Ï∑®ÏÜå Ìï®Ïàò
        function cancelOrder(orderNo) {
            if (confirm('Ï†ïÎßêÎ°ú Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏ∑®ÏÜå ÌõÑÏóêÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')) {
                window.location.href = '/api/orders/cancel.php?order_no=' + orderNo;
            }
        }
    </script>
</body>
</html>