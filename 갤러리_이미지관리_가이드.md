# 교정 갤러리 이미지 관리 가이드

> **문서 버전**: 1.0  
> **최종 업데이트**: 2026-02-12  
> **담당 시스템**: `/popup/proof_gallery.php`

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [품목별 이미지 출처](#품목별-이미지-출처)
3. [이미지 소스 구조](#이미지-소스-구조)
4. [현재 설정 상태](#현재-설정-상태)
5. [관리 가이드](#관리-가이드)

---

## 시스템 개요

### 기본 정보
- **시스템 파일**: `/popup/proof_gallery.php`
- **호출 방식**: 제품 페이지 → "샘플더보기" 버튼 클릭
- **URL 형식**: `https://dsp114.co.kr/popup/proof_gallery.php?cate={품목명}`
- **표시 방식**: 모달 팝업 (24개/페이지)

### 이미지 출처 (듀얼 소스)

교정 갤러리는 **2가지 출처**에서 이미지를 가져옵니다:

| 출처 | 위치 | 설명 |
|------|------|------|
| 📁 **정적 갤러리** | `/ImgFolder/{품목}/gallery/` | 수동 업로드한 샘플 이미지 |
| 🗄️ **DB 주문 이미지** | `/mlangorder_printauto/upload/{주문번호}/` | 2022-2024년 실제 주문 교정 이미지 |

---

## 품목별 이미지 출처

### 전체 품목 상세 표

| # | 품목 (cate) | 갤러리 폴더 경로 | 정적 이미지 수 | DB 주문 이미지 (2022-2024) | 현재 상태 |
|---|------------|---------------|--------------|---------------------------|---------|
| 1 | **전단지** | `/ImgFolder/inserted/gallery/` | **101개** | ~~1,046개~~ | 🚧 DB 비활성화 |
| 2 | **스티커** | `/ImgFolder/sticker_new/gallery/` | **273개** | ~~4,000+개~~ | ✅ 경로 정리 완료<br>🚧 DB 비활성화 |
| 3 | **자석스티커** | `/ImgFolder/msticker/gallery/` | **5개** | ✅ 14개 | 활성 (듀얼) |
| 4 | **명함** | `/ImgFolder/namecard/gallery/` | **22개** | 🔒 차단 (개인정보) | 갤러리만 |
| 5 | **봉투** | `/ImgFolder/envelope/gallery/` | **16개** | 🔒 차단 (개인정보) | 갤러리만 |
| 6 | **포스터** | `/ImgFolder/littleprint/gallery/` | **1개** | ✅ 15개 | 활성 (듀얼) |
| 7 | **상품권** | `/ImgFolder/merchandisebond/gallery/` | **8개** | ✅ 23개 | 활성 (듀얼) |
| 8 | **카탈로그** | `/ImgFolder/cadarok/gallery/`<br>`/ImgFolder/leaflet/gallery/` | **55개**<br>(40 + 15) | ✅ 17개 | 활성 (듀얼) |
| 9 | **양식지** | `/ImgFolder/ncrflambeau/gallery/` | **13개** | 🔒 차단 (개인정보) | 갤러리만 |

### 범례 설명

| 아이콘 | 의미 |
|--------|------|
| ✅ | DB 이미지 활성 (듀얼 소스) |
| 🔒 | 개인정보 보호로 DB 차단 |
| 🚧 | 임시로 DB 비활성화 |
| ~~취소선~~ | 비활성화된 이미지 수 |

---

## 이미지 소스 구조

### 1️⃣ 정적 갤러리 이미지 (우선순위 높음)

**코드 위치**: `proof_gallery.php` lines 35-77

```php
$gallery_folders = [
    '명함' => ['/ImgFolder/namecard/gallery/'],
    '스티커' => ['/ImgFolder/sticker_new/gallery/'], // ✅ 제품 폴더와 일치
    '전단지' => ['/ImgFolder/inserted/gallery/'],
    '봉투' => ['/ImgFolder/envelope/gallery/'],
    '포스터' => ['/ImgFolder/littleprint/gallery/'],
    '상품권' => ['/ImgFolder/merchandisebond/gallery/'],
    '카탈로그' => ['/ImgFolder/cadarok/gallery/', '/ImgFolder/leaflet/gallery/'],
    '자석스티커' => ['/ImgFolder/msticker/gallery/'],
    '양식지' => ['/ImgFolder/ncrflambeau/gallery/'],
];
```

**동작 방식**:
- `scandir()`로 디렉토리 스캔
- 확장자 검사 (jpg, jpeg, png, gif, webp)
- 🎯 **스티커 특별 정렬**: "pro"로 시작하는 파일을 최우선 표시
- 모든 이미지를 `$all_images` 배열에 추가

**스티커 정렬 로직** (2026-02-12 추가):
```php
if ($cate === '스티커') {
    usort($files, function($a, $b) {
        $a_is_pro = (stripos($a, 'pro') === 0);
        $b_is_pro = (stripos($b, 'pro') === 0);
        
        if ($a_is_pro && !$b_is_pro) return -1;  // pro 파일 우선
        if (!$a_is_pro && $b_is_pro) return 1;
        return strcasecmp($a, $b);  // 같은 그룹 내 알파벳순
    });
}
```

**정렬 결과**:
1. **pro001.jpg, pro002.jpg, ...** (최우선)
2. 나머지 파일 (알파벳순)

### 2️⃣ DB 주문 이미지 (동적 로딩)

**코드 위치**: `proof_gallery.php` lines 80-205

**DB 쿼리 조건**:
```sql
SELECT No, ThingCate FROM mlangorder_printauto
WHERE OrderStyle > '0'
  AND ThingCate IS NOT NULL
  AND ThingCate != ''
  AND LENGTH(ThingCate) > 3
  AND ThingCate NOT LIKE '%test%'
  AND ThingCate NOT LIKE '%테스트%'
  AND date >= '2022-01-01'  -- 고정 기간
  AND date <= '2024-12-31'  -- 고정 기간
  AND {품목별 Type 조건}
ORDER BY 주문번호 DESC
```

**품목별 Type 매핑**:

| 품목 | DB Type 조건 | 검색 방식 |
|------|-------------|----------|
| 스티커 | `LIKE '%스티커%' OR LIKE '%스티카%'` (자석 제외) | LIKE 검색 |
| 자석스티커 | `LIKE '%자석%'` | LIKE 검색 |
| 전단지 | `Type = '전단지'` | 정확히 일치 |
| 상품권 | `Type IN ('쿠폰', '상품권', '금액쿠폰')` | IN 조건 |
| 포스터 | `Type IN ('포스터', 'LittlePrint', 'littleprint', ...)` | IN 조건 |
| 카탈로그 | `Type IN ('카다록', '카다로그', 'leaflet', 'cadarok')` | IN 조건 |

### 3️⃣ 개인정보 보호 카테고리

**코드 위치**: `proof_gallery.php` lines 83-85

```php
// 🔒 개인정보 보호: 명함, 봉투, 양식지는 갤러리 이미지만 사용
// 🚧 임시 제한 (2026-02-12): 스티커, 전단지도 DB 쿼리 비활성화
$privacy_protected_categories = ['명함', '봉투', '양식지', '스티커', '전단지'];
$skip_db_query = in_array($cate, $privacy_protected_categories);
```

**보호 대상**:
- **명함**: 개인 연락처 정보 포함
- **봉투**: 수신자 주소 정보 포함
- **양식지**: 거래처 정보 포함
- **스티커** (임시): 2026-02-12 비활성화
- **전단지** (임시): 2026-02-12 비활성화

---

## 현재 설정 상태

### ⚙️ 임시 제한 적용 (2026-02-12)

**변경 내역**:
```php
// 변경 전:
$privacy_protected_categories = ['명함', '봉투', '양식지'];

// 변경 후:
$privacy_protected_categories = ['명함', '봉투', '양식지', '스티커', '전단지'];
```

**변경 이유**:
- 스티커와 전단지의 DB 주문 이미지를 당분간 숨김
- 갤러리 폴더 이미지만 표시하여 안정성 확보

**영향 범위**:

| 품목 | 변경 전 이미지 수 | 변경 후 이미지 수 | 감소량 |
|------|-----------------|-----------------|--------|
| 스티커 | 4,155개 | 273개 | -3,882개 |
| 전단지 | 1,147개 | 101개 | -1,046개 |

### 🔙 복원 방법

DB 주문 이미지를 다시 활성화하려면:

```php
// proof_gallery.php line 83-85 수정:
$privacy_protected_categories = ['명함', '봉투', '양식지'];
// '스티커', '전단지' 제거
```

**복원 후 테스트 필수**:
```bash
# 브라우저에서 확인
https://dsp114.co.kr/popup/proof_gallery.php?cate=스티커
https://dsp114.co.kr/popup/proof_gallery.php?cate=전단지

# 이미지 개수 확인
https://dsp114.co.kr/popup/proof_gallery.php?cate=스티커&debug=1
```

---

## 관리 가이드

### 📁 갤러리 이미지 추가하기

#### 1단계: 이미지 업로드

```bash
# FTP 또는 로컬에서 파일 복사
# 대상 경로: /ImgFolder/{품목}/gallery/

# 예시: 스티커 샘플 추가
cp 새로운샘플.jpg /var/www/html/ImgFolder/sticker_new/gallery/

# 또는 FTP 업로드
curl -T 새로운샘플.jpg \
  ftp://dsp114.co.kr/httpdocs/ImgFolder/sticker_new/gallery/ \
  --user "dsp1830:cH*j@yzj093BeTtc"
```

#### 2단계: 파일 권한 확인

```bash
chmod 644 /var/www/html/ImgFolder/sticker_new/gallery/*.jpg
```

#### 3단계: 결과 확인

```
https://dsp114.co.kr/popup/proof_gallery.php?cate=스티커
```

### 🗄️ DB 주문 이미지 관리

**자동 로딩 조건**:
- 주문 완료 (`OrderStyle > '0'`)
- 교정파일 존재 (`ThingCate` 컬럼에 파일명)
- 2022-2024년 사이 주문
- 테스트 주문 제외

**수동 추가 불가**: DB 이미지는 주문 시스템에서 자동 생성

### 📊 이미지 현황 조회

#### 갤러리 폴더 이미지 개수

```bash
# 모든 품목의 갤러리 이미지 개수 확인
for dir in /var/www/html/ImgFolder/*/gallery; do
  echo "$dir: $(find "$dir" -type f \( -iname "*.jpg" -o -iname "*.png" \) | wc -l) images"
done
```

#### DB 주문 이미지 개수

```bash
mysql -udsp1830 -pds701018 dsp1830 -e "
SELECT Type, COUNT(*) as count 
FROM mlangorder_printauto 
WHERE OrderStyle > '0' 
  AND ThingCate IS NOT NULL 
  AND date >= '2022-01-01' 
  AND date <= '2024-12-31' 
GROUP BY Type 
ORDER BY count DESC 
LIMIT 10"
```

### 🔍 디버깅 모드

디버그 정보를 HTML 주석으로 출력:

```
https://dsp114.co.kr/popup/proof_gallery.php?cate=스티커&debug=1
```

**출력 예시**:
```html
<!-- DEBUG: Category = 스티커, Type WHERE = ((Type LIKE '%스티커%' OR Type LIKE '%스티카%') AND Type NOT LIKE '%자석%') -->
<!-- DEBUG: Gallery images = 155 -->
<!-- DEBUG: Order images = 0 -->
<!-- DEBUG: Total = 155, Pages = 7 -->
```

### ✅ 스티커 폴더 정리 완료 (2026-02-12)

**이전 상황**:
- **갤러리 구 폴더**: `ImgFolder/sticker/gallery/` → 155개 이미지
- **갤러리 신규 폴더**: `ImgFolder/sticker_new/gallery/` → 0개 (비어있음)

**정리 완료**:
1. ✅ 백업 생성: `sticker/gallery.backup/` (155개)
2. ✅ 이미지 이동: `sticker_new/gallery/` (155개 → 273개)
3. ✅ `proof_gallery.php` 경로 변경: `sticker_new/gallery/`만 사용
4. ✅ 제품 폴더(`mlangprintauto/sticker_new/`)와 갤러리 폴더 일치
5. ✅ 추가 이미지 업로드: 118개 추가 (총 273개)

**현재 상태**:
```php
'스티커' => ['/ImgFolder/sticker_new/gallery/'] // ✅ 단일 경로로 통일 (273개)
```

**백업 위치**: `/var/www/html/ImgFolder/sticker/gallery.backup/`

### ⚠️ 주의사항

1. **파일명 공백 금지**: 갤러리 이미지는 공백 없이 `_` 사용
   ```bash
   ✅ 좋음: 스티커_샘플_01.jpg
   ❌ 나쁨: 스티커 샘플 01.jpg
   ```

2. **확장자 제한**: jpg, jpeg, png, gif, webp만 허용

3. **파일 크기**: 이미지당 1MB 이하 권장 (로딩 속도)

4. **DB 기간 고정**: 2022-2024년 하드코딩 (변경 시 코드 수정 필요)

5. **개인정보 주의**: 명함/봉투/양식지는 영구 차단

---

## 📚 관련 파일

### 핵심 파일
| 파일 | 용도 |
|------|------|
| `/popup/proof_gallery.php` | 갤러리 메인 시스템 |
| `/js/common-gallery-popup.js` | 갤러리 팝업 오픈 함수 |
| `/AGENTS.md` | 시스템 전체 문서 |

### 갤러리 디렉토리
```
/ImgFolder/
├── sticker/gallery.backup/   (155개) 📦 백업
├── sticker_new/gallery/      (273개) ✅ 현재 사용중 (제품 폴더 일치)
├── inserted/gallery/         (101개)
├── cadarok/gallery/          (40개)
├── namecard/gallery/         (22개)
├── envelope/gallery/         (16개)
├── leaflet/gallery/          (15개)
├── ncrflambeau/gallery/      (13개)
├── merchandisebond/gallery/  (8개)
└── msticker/gallery/         (5개)
```

---

## 🔄 변경 이력

| 날짜 | 변경 내용 | 담당 |
|------|----------|------|
| 2026-02-12 | 🎯 스티커 갤러리 정렬: "pro" 접두어 우선 표시 | 시스템 관리 |
| 2026-02-12 | 스티커 이미지 118개 추가 (155 → 273개) | 관리자 |
| 2026-02-12 | ✅ 스티커 폴더 정리 완료 (sticker → sticker_new) | 시스템 관리 |
| 2026-02-12 | 스티커/전단지 DB 쿼리 임시 비활성화 | 시스템 관리 |
| 2026-02-10 | 다중 파일 업로드 JSON 파싱 추가 | 개발팀 |
| 2026-02-05 | 페이지네이션 개선 (24개/페이지) | 개발팀 |
| 2025-01-XX | 듀얼 소스 시스템 구현 | 개발팀 |

---

## 📞 문의

- **시스템 담당**: 개발팀
- **긴급 연락처**: 02-2632-1830
- **이메일**: dsp1830@naver.com

---

*최종 업데이트: 2026-02-12*  
*문서 관리: `/var/www/html/갤러리_이미지관리_가이드.md`*
