<?php
/**
 * Ï£ºÎ¨∏ÎÇ¥Ïó≠ Ïù¥Î©îÏùº Î∞úÏÜ° API
 * ÏÇ¨Î¨¥Ïö© ÌëúÌòïÌÉú Ï£ºÎ¨∏ÏôÑÎ£å ÌéòÏù¥ÏßÄÏö©
 * Created: 2025ÎÖÑ 8Ïõî (AI Assistant)
 */

// ÏóêÎü¨ Ï∂úÎ†• Ï†úÏñ¥ - JSON ÏùëÎãµ Î≥¥Ïû•
error_reporting(0);
ini_set('display_errors', 0);
ini_set('log_errors', 1);

// Ï∂úÎ†• Î≤ÑÌçº ÏãúÏûë - Î∂àÌïÑÏöîÌïú Ï∂úÎ†• Î∞©ÏßÄ
ob_start();

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-cache, must-revalidate');

// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞
include "../db.php";

// PHPMailer ÎùºÏù¥Î∏åÎü¨Î¶¨ Ìè¨Ìï®
require 'mailer.lib250802.php';

try {
    // POST Îç∞Ïù¥ÌÑ∞ Î∞õÍ∏∞
    $input = file_get_contents('php://input');
    $data = json_decode($input, true);
    
    if (!$data) {
        throw new Exception('ÏûòÎ™ªÎêú ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§.');
    }
    
    $orders = $data['orders'] ?? '';
    $email = $data['email'] ?? '';
    $name = $data['name'] ?? '';
    $orderList = $data['orderList'] ?? [];
    $totalAmount = $data['totalAmount'] ?? 0;
    $totalAmountVat = $data['totalAmountVat'] ?? 0;
    
    if (empty($email) || empty($name) || empty($orderList)) {
        throw new Exception('ÌïÑÏàò Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.');
    }
    
    // Ïù¥Î©îÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        throw new Exception('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº Ï£ºÏÜåÍ∞Ä ÏïÑÎãôÎãàÎã§.');
    }
    
    // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Ï°∞Ìöå Ìï®Ïàò
    function getCategoryName($connect, $category_no) {
        if (!$category_no) return '';
        
        $query = "SELECT title FROM MlangPrintAuto_transactionCate WHERE no = ? LIMIT 1";
        $stmt = mysqli_prepare($connect, $query);
        if (!$stmt) return $category_no;
        
        mysqli_stmt_bind_param($stmt, 's', $category_no);
        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);
        
        if ($row = mysqli_fetch_assoc($result)) {
            mysqli_stmt_close($stmt);
            return $row['title'];
        }
        
        mysqli_stmt_close($stmt);
        return $category_no;
    }
    
    // HTML Ïù¥Î©îÏùº ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
    $emailHtml = '
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ï£ºÎ¨∏ ÏôÑÎ£å ÏïàÎÇ¥</title>
        <style>
            body {
                font-family: "Noto Sans KR", "Malgun Gothic", sans-serif;
                line-height: 1.6;
                color: #333;
                margin: 0;
                padding: 20px;
                background-color: #f8f9fa;
            }
            .email-container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            .email-header {
                background: linear-gradient(135deg, #E6F3FF 0%, #F0E6FF 100%);
                padding: 30px 20px;
                text-align: center;
                border-bottom: 1px solid #e1e8ed;
            }
            .email-header h1 {
                margin: 0 0 10px 0;
                font-size: 1.8rem;
                color: #2c3e50;
                font-weight: 700;
            }
            .email-header p {
                margin: 0;
                font-size: 1.1rem;
                color: #566a7e;
            }
            .summary-section {
                padding: 20px;
                background: #f8f9fa;
                border-bottom: 1px solid #e1e8ed;
            }
            .summary-stats {
                display: flex;
                justify-content: space-around;
                text-align: center;
                flex-wrap: wrap;
                gap: 20px;
            }
            .summary-stat {
                flex: 1;
                min-width: 120px;
            }
            .summary-stat .value {
                font-size: 1.5rem;
                font-weight: 700;
                color: #2c3e50;
                margin-bottom: 5px;
            }
            .summary-stat .label {
                font-size: 0.9rem;
                color: #566a7e;
            }
            .order-table {
                width: 100%;
                border-collapse: collapse;
                margin: 0;
            }
            .order-table thead th {
                background: linear-gradient(135deg, #E6F3FF 0%, #E6FFF0 100%);
                color: #2c3e50;
                font-weight: 700;
                padding: 12px 8px;
                font-size: 0.9rem;
                text-align: center;
                border-bottom: 2px solid #e1e8ed;
            }
            .order-table tbody tr:nth-child(even) {
                background: #FFFCE6;
            }
            .order-table tbody tr:nth-child(odd) {
                background: #E6FFF0;
            }
            .order-table td {
                padding: 12px 8px;
                border-bottom: 1px solid #e1e8ed;
                font-size: 0.85rem;
                vertical-align: top;
            }
            .col-order-no {
                width: 10%;
                text-align: center;
                font-weight: 600;
                color: #667eea;
            }
            .col-product {
                width: 25%;
                font-weight: 600;
            }
            .col-details {
                width: 35%;
                line-height: 1.4;
            }
            .col-quantity {
                width: 10%;
                text-align: center;
            }
            .col-price {
                width: 15%;
                text-align: right;
                font-weight: 600;
                color: #e74c3c;
            }
            .col-date {
                width: 15%;
                text-align: center;
                font-size: 0.8rem;
            }
            .product-options {
                margin-top: 5px;
                padding: 8px;
                background: rgba(255,255,255,0.7);
                border-radius: 4px;
                font-size: 0.75rem;
                line-height: 1.3;
            }
            .option-item {
                display: inline-block;
                margin-right: 10px;
                margin-bottom: 3px;
                padding: 2px 6px;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 3px;
                color: #566a7e;
            }
            .request-note {
                margin-top: 5px;
                padding: 6px;
                background: #FFFCE6;
                border-left: 3px solid #ffc107;
                border-radius: 3px;
                font-size: 0.75rem;
                color: #856404;
            }
            .info-section {
                padding: 20px;
                display: flex;
                gap: 40px;
                background: #f8f9fa;
                border-top: 1px solid #e1e8ed;
            }
            .info-column {
                flex: 1;
            }
            .info-column h3 {
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                color: #2c3e50;
                font-weight: 600;
            }
            .info-row {
                display: flex;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }
            .info-label {
                width: 80px;
                font-weight: 600;
                color: #566a7e;
            }
            .info-value {
                flex: 1;
                color: #2c3e50;
            }
            .footer-section {
                padding: 20px;
                text-align: center;
                background: linear-gradient(135deg, #E6F3FF 0%, #F0E6FF 100%);
                color: #566a7e;
                font-size: 0.85rem;
                line-height: 1.5;
            }
            .company-info {
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #e1e8ed;
            }
            @media (max-width: 600px) {
                .summary-stats {
                    flex-direction: column;
                }
                .info-section {
                    flex-direction: column;
                    gap: 20px;
                }
                .order-table {
                    font-size: 0.75rem;
                }
                .order-table td {
                    padding: 8px 4px;
                }
            }
        </style>
    </head>
    <body>
        <div class="email-container">
            <!-- Ìó§Îçî -->
            <div class="email-header">
                <h1>üéâ Ï£ºÎ¨∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!</h1>
                <p>' . htmlspecialchars($name) . ' Í≥†Í∞ùÎãò, ÏÜåÏ§ëÌïú Ï£ºÎ¨∏ Í∞êÏÇ¨Ìï©ÎãàÎã§.</p>
            </div>
            
            <!-- ÏöîÏïΩ ÏÑπÏÖò -->
            <div class="summary-section">
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="value">' . count($orderList) . 'Í±¥</div>
                        <div class="label">Ï£ºÎ¨∏ Í±¥Ïàò</div>
                    </div>
                    <div class="summary-stat">
                        <div class="value">' . number_format($totalAmount) . 'Ïõê</div>
                        <div class="label">Ï¥ù Ï£ºÎ¨∏Í∏àÏï°</div>
                    </div>
                    <div class="summary-stat">
                        <div class="value">' . number_format($totalAmountVat) . 'Ïõê</div>
                        <div class="label">VAT Ìè¨Ìï® Ï¥ùÏï°</div>
                    </div>
                </div>
            </div>
            
            <!-- Ï£ºÎ¨∏ ÏÉÅÏÑ∏ ÌÖåÏù¥Î∏î -->
            <table class="order-table">
                <thead>
                    <tr>
                        <th class="col-order-no">Ï£ºÎ¨∏Î≤àÌò∏</th>
                        <th class="col-product">ÏÉÅÌíàÎ™Ö</th>
                        <th class="col-details">ÏÉÅÏÑ∏ ÏòµÏÖò</th>
                        <th class="col-quantity">ÏàòÎüâ</th>
                        <th class="col-price">Í∏àÏï°(VATÌè¨Ìï®)</th>
                        <th class="col-date">Ï£ºÎ¨∏ÏùºÏãú</th>
                    </tr>
                </thead>
                <tbody>';
    
    // Í∞Å Ï£ºÎ¨∏ Ìï≠Î™© Ï≤òÎ¶¨
    foreach ($orderList as $order) {
        $emailHtml .= '<tr>';
        
        // Ï£ºÎ¨∏Î≤àÌò∏
        $emailHtml .= '<td class="col-order-no">#' . htmlspecialchars($order['no']) . '</td>';
        
        // ÏÉÅÌíàÎ™Ö
        $emailHtml .= '<td class="col-product">' . htmlspecialchars($order['Type']) . '</td>';
        
        // ÏÉÅÏÑ∏ ÏòµÏÖò
        $emailHtml .= '<td class="col-details">';
        
        if (!empty($order['Type_1'])) {
            $type_data = $order['Type_1'];
            $json_data = json_decode($type_data, true);
            
            $emailHtml .= '<div class="product-options">';
            
            if ($json_data && is_array($json_data)) {
                // JSON Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                $product_type = $json_data['product_type'] ?? '';
                
                switch($product_type) {
                    case 'sticker':
                        // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏàòÏ†ï
                        $details = $json_data['order_details'] ?? $json_data;
                        if (isset($details['jong'])) $emailHtml .= '<span class="option-item">Ïû¨Ïßà: ' . htmlspecialchars($details['jong']) . '</span>';
                        if (isset($details['garo']) && isset($details['sero'])) {
                            $emailHtml .= '<span class="option-item">ÌÅ¨Í∏∞: ' . htmlspecialchars($details['garo']) . '√ó' . htmlspecialchars($details['sero']) . 'mm</span>';
                        }
                        if (isset($details['mesu'])) $emailHtml .= '<span class="option-item">ÏàòÎüâ: ' . number_format($details['mesu']) . 'Îß§</span>';
                        if (isset($details['uhyung'])) $emailHtml .= '<span class="option-item">Ìé∏Ïßë: ' . htmlspecialchars($details['uhyung']) . '</span>';
                        if (isset($details['domusong'])) $emailHtml .= '<span class="option-item">Î™®Ïñë: ' . htmlspecialchars($details['domusong']) . '</span>';
                        break;
                        
                    case 'envelope':
                        if (isset($json_data['MY_type'])) $emailHtml .= '<span class="option-item">ÌÉÄÏûÖ: ' . getCategoryName($db, $json_data['MY_type']) . '</span>';
                        if (isset($json_data['MY_Fsd'])) $emailHtml .= '<span class="option-item">Ïö©ÏßÄ: ' . getCategoryName($db, $json_data['MY_Fsd']) . '</span>';
                        if (isset($json_data['MY_amount'])) $emailHtml .= '<span class="option-item">ÏàòÎüâ: ' . number_format($json_data['MY_amount']) . 'Îß§</span>';
                        if (isset($json_data['POtype'])) $emailHtml .= '<span class="option-item">Ïù∏ÏáÑ: ' . ($json_data['POtype'] == '1' ? 'Îã®Î©¥' : 'ÏñëÎ©¥') . '</span>';
                        break;
                        
                    case 'namecard':
                        if (isset($json_data['MY_type'])) $emailHtml .= '<span class="option-item">ÌÉÄÏûÖ: ' . getCategoryName($db, $json_data['MY_type']) . '</span>';
                        if (isset($json_data['Section'])) $emailHtml .= '<span class="option-item">Ïö©ÏßÄ: ' . getCategoryName($db, $json_data['Section']) . '</span>';
                        if (isset($json_data['MY_amount'])) $emailHtml .= '<span class="option-item">ÏàòÎüâ: ' . number_format($json_data['MY_amount']) . 'Îß§</span>';
                        if (isset($json_data['POtype'])) $emailHtml .= '<span class="option-item">Ïù∏ÏáÑ: ' . ($json_data['POtype'] == '1' ? 'Îã®Î©¥' : 'ÏñëÎ©¥') . '</span>';
                        break;
                        
                    default:
                        foreach ($json_data as $key => $value) {
                            if (!empty($value) && $key != 'product_type') {
                                $display_key = ucfirst($key);
                                $display_value = is_numeric($value) && in_array($key, ['MY_type', 'MY_Fsd', 'PN_type']) 
                                    ? getCategoryName($db, $value) 
                                    : $value;
                                $emailHtml .= '<span class="option-item">' . htmlspecialchars($display_key) . ': ' . htmlspecialchars($display_value) . '</span>';
                            }
                        }
                        break;
                }
            } else {
                // ÏùºÎ∞ò ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ (Ï†ÑÎã®ÏßÄ Îì±)
                $lines = explode("\n", $type_data);
                foreach ($lines as $line) {
                    $line = trim($line);
                    if (!empty($line)) {
                        $emailHtml .= '<span class="option-item">' . htmlspecialchars($line) . '</span>';
                    }
                }
            }
            
            $emailHtml .= '</div>';
        }
        
        // ÏöîÏ≤≠ÏÇ¨Ìï≠ ÌëúÏãú
        if (!empty($order['cont'])) {
            $emailHtml .= '<div class="request-note">';
            $emailHtml .= '<strong>üí¨ ÏöîÏ≤≠ÏÇ¨Ìï≠:</strong><br>';
            $emailHtml .= nl2br(htmlspecialchars($order['cont']));
            $emailHtml .= '</div>';
        }
        
        $emailHtml .= '</td>';
        
        // ÏàòÎüâ
        $quantity = 1;
        if (!empty($order['Type_1'])) {
            $json_data = json_decode($order['Type_1'], true);
            if ($json_data && is_array($json_data)) {
                // JSON Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏàòÎüâ Ï∂îÏ∂ú
                $details = $json_data['order_details'] ?? $json_data;
                if (isset($details['MY_amount'])) {
                    $quantity = $details['MY_amount'];
                } elseif (isset($details['mesu'])) {
                    $quantity = $details['mesu'];
                }
            } else {
                // ÏùºÎ∞ò ÌÖçÏä§Ìä∏ÏóêÏÑú ÏàòÎüâ Ï∂îÏ∂ú
                if (preg_match('/ÏàòÎüâ:\s*([0-9.]+)Îß§/', $order['Type_1'], $matches)) {
                    $quantity = floatval($matches[1]);
                }
            }
        }
        $emailHtml .= '<td class="col-quantity">' . number_format($quantity) . '</td>';
        
        // Í∏àÏï°
        $emailHtml .= '<td class="col-price">' . number_format($order['money_5']) . 'Ïõê</td>';
        
        // Ï£ºÎ¨∏ÏùºÏãú
        $order_date = '';
        if (isset($order['date']) && !empty($order['date']) && $order['date'] !== '0000-00-00 00:00:00') {
            $order_date = date('m/d H:i', strtotime($order['date']));
        } else {
            $order_date = date('m/d H:i'); // ÌòÑÏû¨ ÏãúÍ∞Ñ
        }
        $emailHtml .= '<td class="col-date">' . $order_date . '</td>';
        
        $emailHtml .= '</tr>';
    }
    
    $emailHtml .= '</tbody>
            </table>
            
            <!-- Í≥†Í∞ùÏ†ïÎ≥¥ Î∞è ÏûÖÍ∏àÏïàÎÇ¥ -->
            <div class="info-section">
                <div class="info-column">
                    <h3>üë§ Í≥†Í∞ù Ï†ïÎ≥¥</h3>
                    <div class="info-row">
                        <div class="info-label">ÏÑ±Î™Ö:</div>
                        <div class="info-value">' . htmlspecialchars($orderList[0]['name']) . '</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ïù¥Î©îÏùº:</div>
                        <div class="info-value">' . htmlspecialchars($orderList[0]['email']) . '</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ïó∞ÎùΩÏ≤ò:</div>
                        <div class="info-value">';
    
    if (!empty($orderList[0]['Hendphone'])) {
        $emailHtml .= htmlspecialchars($orderList[0]['Hendphone']);
    } elseif (!empty($orderList[0]['phone'])) {
        $emailHtml .= htmlspecialchars($orderList[0]['phone']);
    }
    
    $emailHtml .= '</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ï£ºÏÜå:</div>
                        <div class="info-value">';
    
    if (!empty($orderList[0]['zip'])) {
        $emailHtml .= '(' . htmlspecialchars($orderList[0]['zip']) . ') ';
    }
    $emailHtml .= htmlspecialchars($orderList[0]['zip1'] . ' ' . $orderList[0]['zip2']);
    
    $emailHtml .= '</div>
                    </div>
                </div>
                
                <div class="info-column">
                    <h3>üí≥ ÏûÖÍ∏à ÏïàÎÇ¥</h3>
                    <div class="info-row">
                        <div class="info-label">ÏòàÍ∏àÏ£º:</div>
                        <div class="info-value">ÎëêÏÜêÍ∏∞ÌöçÏù∏ÏáÑ Ï∞®Í≤ΩÏÑ†</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Íµ≠ÎØºÏùÄÌñâ:</div>
                        <div class="info-value">999-1688-2384</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ïã†ÌïúÏùÄÌñâ:</div>
                        <div class="info-value">110-342-543507</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ÎÜçÌòë:</div>
                        <div class="info-value">301-2632-1829</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ïπ¥ÎìúÍ≤∞Ï†ú:</div>
                        <div class="info-value">1688-2384 Ï†ÑÌôî</div>
                    </div>
                </div>
            </div>
            
            <!-- Ìë∏ÌÑ∞ -->
            <div class="footer-section">
                <p><strong>‚ö†Ô∏è ÏûÖÍ∏à ÌôïÏù∏ ÌõÑ ÏûëÏóÖÏù¥ ÏãúÏûëÎê©ÎãàÎã§.</strong></p>
                <p>ÏûÖÍ∏àÏûêÎ™ÖÏùÑ Ï£ºÎ¨∏ÏûêÎ™ÖÍ≥º ÎèôÏùºÌïòÍ≤å Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                
                <div class="company-info">
                    <p><strong>ÎëêÏÜêÍ∏∞ÌöçÏù∏ÏáÑ</strong></p>
                    <p>üìû 02-2632-1830, 1688-2384</p>
                    <p>üìç ÏÑúÏö∏ ÏòÅÎì±Ìè¨Íµ¨ ÏòÅÎì±Ìè¨Î°ú 36Í∏∏ 9, ÏÜ°Ìò∏ÎπåÎî© 1F</p>
                    <p>üåê www.dsp114.com</p>
                </div>
            </div>
        </div>
    </body>
    </html>';
    
    // Ïù¥Î©îÏùº Î∞úÏÜ°
    $subject = '[ÎëêÏÜêÍ∏∞ÌöçÏù∏ÏáÑ] Ï£ºÎ¨∏ ÏôÑÎ£å ÏïàÎÇ¥ - ' . $name . ' Í≥†Í∞ùÎãò (' . count($orderList) . 'Í±¥)';
    $from_name = 'ÎëêÏÜêÍ∏∞ÌöçÏù∏ÏáÑ';
    $from_email = 'dsp1830@naver.com';
    
    // Î°úÏª¨ ÌôòÍ≤ΩÏóêÏÑúÎäî Ïù¥Î©îÏùº Î∞úÏÜ°ÏùÑ ÏãúÎÆ¨Î†àÏù¥ÏÖò
    if ($_SERVER['HTTP_HOST'] === 'localhost' || $_SERVER['HTTP_HOST'] === '127.0.0.1') {
        // Î°úÏª¨ ÌôòÍ≤Ω: Ïù¥Î©îÏùº Î∞úÏÜ° ÏãúÎÆ¨Î†àÏù¥ÏÖò
        $result = true;
        
        // Ïù¥Î©îÏùº ÎÇ¥Ïö©ÏùÑ ÌååÏùºÎ°ú Ï†ÄÏû• (ÎîîÎ≤ÑÍ∑∏Ïö©)
        $email_file = "debug_email_" . date('Y-m-d_H-i-s') . ".html";
        file_put_contents($email_file, $emailHtml);
        
    } else {
        // Ïã§Ï†ú ÏÑúÎ≤Ñ ÌôòÍ≤Ω: PHPMailer ÏÇ¨Ïö©
        $result = mailer($from_name, $from_email, $email, $subject, $emailHtml, 1);
    }
    
    if ($result) {
        // Ïù¥Î©îÏùº Î∞úÏÜ° Î°úÍ∑∏ Ï†ÄÏû•
        if ($db) {
            $log_query = "INSERT INTO email_send_log (order_numbers, recipient_email, recipient_name, subject, sent_at, status) VALUES (?, ?, ?, ?, NOW(), 'success')";
            $stmt = mysqli_prepare($db, $log_query);
            if ($stmt) {
                mysqli_stmt_bind_param($stmt, "ssss", $orders, $email, $name, $subject);
                mysqli_stmt_execute($stmt);
                mysqli_stmt_close($stmt);
            }
        }
        
        // Ï∂úÎ†• Î≤ÑÌçº Ï†ïÎ¶¨
        ob_clean();
        
        echo json_encode([
            'success' => true,
            'message' => 'Ï£ºÎ¨∏ÎÇ¥Ïó≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïù¥Î©îÏùºÎ°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§.',
            'data' => [
                'email' => $email,
                'orderCount' => count($orderList),
                'sentAt' => date('Y-m-d H:i:s')
            ]
        ], JSON_UNESCAPED_UNICODE);
    } else {
        throw new Exception('Ïù¥Î©îÏùº Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
    }
    
} catch (Exception $e) {
    // ÏóêÎü¨ Î°úÍ∑∏ Ï†ÄÏû•
    if (isset($db) && isset($orders) && isset($email) && isset($name)) {
        $log_query = "INSERT INTO email_send_log (order_numbers, recipient_email, recipient_name, subject, sent_at, status, error_message) VALUES (?, ?, ?, ?, NOW(), 'failed', ?)";
        $stmt = mysqli_prepare($db, $log_query);
        if ($stmt) {
            $subject = isset($subject) ? $subject : 'Ï£ºÎ¨∏ ÏôÑÎ£å ÏïàÎÇ¥';
            mysqli_stmt_bind_param($stmt, "sssss", $orders, $email, $name, $subject, $e->getMessage());
            mysqli_stmt_execute($stmt);
            mysqli_stmt_close($stmt);
        }
    }
    
    // Ï∂úÎ†• Î≤ÑÌçº Ï†ïÎ¶¨
    ob_clean();
    
    echo json_encode([
        'success' => false,
        'message' => $e->getMessage(),
        'data' => null
    ], JSON_UNESCAPED_UNICODE);
} finally {
    // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ï¢ÖÎ£å
    if (isset($db)) {
        mysqli_close($db);
    }
}
?>